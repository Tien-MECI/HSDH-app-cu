<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Kinh Doanh</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    .filter-box { text-align:center; margin-bottom: 20px; }
    .row { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
    .chart-container { flex:1; min-width:340px; max-width:700px; height:420px; position:relative; }
    .full-width { max-width:1000px; }
    canvas { width:100% !important; height:100% !important; }
  </style>
</head>
<body>
  <h1 style="text-align:center;">üìä Dashboard Kinh Doanh</h1>

  <div class="filter-box">
    <form method="GET" action="/dashboard" style="display:inline-flex; gap:8px; align-items:center;">
      <label>T·ª´ th√°ng:</label>
      <select name="startMonth">
        <option value="">T·∫•t c·∫£</option>
        <% for (let m=1; m<=12; m++) { %>
          <option value="<%= m %>" <%= startMonth==m ? 'selected' : '' %>>Th√°ng <%= m %></option>
        <% } %>
      </select>
      <label>ƒê·∫øn th√°ng:</label>
      <select name="endMonth">
        <option value="">T·∫•t c·∫£</option>
        <% for (let m=1; m<=12; m++) { %>
          <option value="<%= m %>" <%= endMonth==m ? 'selected' : '' %>>Th√°ng <%= m %></option>
        <% } %>
      </select>
      <button type="submit">L·ªçc</button>
    </form>
  </div>

  <!-- H√†ng 1 -->
  <div class="row">
    <div class="chart-container">
      <canvas id="salesChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <!-- H√†ng 2:  -->
  <div class="row">
    <div class="chart-container">
      <canvas id="productChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="cskhChart"></canvas>
    </div>
  </div>
  <!-- H√†ng 4: B√°o c√°o ƒëƒÉng b√†i m·∫°ng x√£ h·ªôi -->
  <div class="row">
    <div class="chart-container full-width">
      <canvas id="baidangChart"></canvas>
    </div>
  </div>

  <!-- B·∫£ng danh s√°ch link -->
<div style="width: 90%; margin: 20px auto;">
  <h3>üîó Danh s√°ch link b√†i ƒëƒÉng</h3>
  <table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Nh√¢n vi√™n</th>
        <th>K√™nh - B√†i</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody>
      <% if (linkList.length === 0) { %>
        <tr><td colspan="3" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
      <% } else { %>
        <% linkList.forEach(item => { %>
          <tr>
            <td><%= item.nhanVien %></td>
            <td><%= item.kenhBai %></td>
            <td><a href="<%= item.link %>" target="_blank" style="color:blue;">Xem b√†i</a></td>
          </tr>
        <% }) %>
      <% } %>
    </tbody>
  </table>
</div>

<!-- H√†ng 5: B√°o c√°o kh√°ch h√†ng m·ªõi -->
<div class="row">
  <div class="chart-container" style="width: 45%; display:inline-block;">
    <canvas id="khachHangNguoiTaoChart"></canvas>
  </div>
  <div class="chart-container" style="width: 25%; display:inline-block;">
    <canvas id="khachHangNguonChart"></canvas>
  </div>
  <div class="chart-container" style="width: 25%; display:inline-block;">
    <canvas id="khachHangLoaiChart"></canvas>
  </div>
</div>



  <script>
    const sales = <%- JSON.stringify(sales) %>;
    const soDonChot = <%= soDonChot %>;
    const soDonHuy = <%= soDonHuy %>;
    const topProducts = <%- JSON.stringify(topProducts) %>;
    const watermarkBase64 = "<%= watermarkBase64 %>";

    // watermark plugin (g√≥c d∆∞·ªõi ph·∫£i)
    const watermarkPlugin = {
      id: 'watermark',
      beforeDraw: (chart) => {
        if (!watermarkBase64) return;
        const ctx = chart.ctx;
        const img = new Image();
        img.src = watermarkBase64;
        const w = chart.width, h = chart.height;
        img.onload = () => {
          const size = Math.min(w, h) * 0.12;
          ctx.save();
          ctx.globalAlpha = 0.12;
          ctx.drawImage(img, w - size - 8, h - size - 8, size, size);
          ctx.restore();
        };
      }
    };

    // --- Sales by NV chart ---
    // ‚úÖ T√≠nh t·ªïng doanh s·ªë
const totalDoanhSo = sales.reduce((sum, s) => sum + s.tongDoanhSo, 0);

new Chart(document.getElementById("salesChart"), {
  type: "bar",
  data: {
    labels: sales.map(s => s.nhanVien),
    datasets: [{
      // ‚úÖ G√°n label k√®m t·ªïng doanh s·ªë
      label: `T·ªïng doanh s·ªë (${totalDoanhSo.toLocaleString("vi-VN")})`,
      data: sales.map(s => Math.round(s.tongDoanhSo)),
      backgroundColor: "rgba(54,162,235,0.75)",
      maxBarThickness: 60
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      title: { display: true, text: "üíº Doanh s·ªë theo nh√¢n vi√™n", font: { size: 16 } },
      datalabels: {
        color: "#000",
        anchor: "end",
        align: "top",
        formatter: v => v.toLocaleString("vi-VN"),
        font: ctx => ({
          size: Math.max(10, Math.min(14, ctx.chart.width / Math.max(1, sales.length) * 0.6))
        })
      }
    },
    scales: {
      x: { ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 } },
      y: { ticks: { callback: v => v.toLocaleString("vi-VN") } }
    }
  },
  plugins: [ChartDataLabels, watermarkPlugin]
});


    // --- Status pie chart ---
    new Chart(document.getElementById("statusChart"), {
      type: "pie",
      data: {
        labels:["ƒê∆°n ch·ªët","ƒê∆°n h·ªßy"],
        datasets:[{ data:[soDonChot, soDonHuy], backgroundColor:["#4CAF50","#F44336"] }]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{
          title: { display:true, text: "üìä T·ª∑ l·ªá ƒë∆°n ch·ªët / h·ªßy", font:{size:16} },
          datalabels: {
            color:"#fff",
            formatter: (v, ctx) => {
              const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
              return total>0 ? ((v/total)*100).toFixed(1)+"%" : "0%";
            },
            font: ctx => ({ size: Math.max(10, Math.min(14, ctx.chart.width / 10)) })
          }
        }
      },
      plugins: [ChartDataLabels, watermarkPlugin]
    });



    // --- Top product chart: bar (soLuong) + line (doanhSo) ---
    new Chart(document.getElementById("productChart"), {
      type: "bar",
      data: {
        labels: topProducts.map(p => p.maSP),
        datasets: [
          {
            label: "S·ªë l∆∞·ª£ng",
            data: topProducts.map(p => Math.round(p.soLuong)),
            backgroundColor: "rgba(255,159,64,0.8)",
            yAxisID: "y",
            maxBarThickness: 60
          },
          {
            label: "Doanh s·ªë",
            data: topProducts.map(p => Math.round(p.doanhSo)),
            borderColor: "rgba(54,162,235,0.9)",
            backgroundColor: "rgba(54,162,235,0.2)",
            type: "line",
            yAxisID: "y1",
            tension: 0.25,
            pointRadius: 4
          }
        ]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins: {
          title: { display:true, text: "üèÜ Top 10 s·∫£n ph·∫©m b√°n ch·∫°y nh·∫•t (theo Doanh s·ªë)", font:{size:16} },
          datalabels: {
            display: (ctx) => ctx.dataset.type !== 'line',
            color: "#000",
            anchor: "end",
            align: "top",
            formatter: (v, ctx) => {
              const unit = topProducts[ctx.dataIndex]?.donVi || "";
              return v.toLocaleString("vi-VN") + (unit ? " " + unit : "");
            },
            font: ctx => ({ size: Math.max(10, Math.min(14, ctx.chart.width / Math.max(1, topProducts.length) * 0.6)) })
          },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                if (ctx.dataset.label === "Doanh s·ªë") {
                  return ctx.dataset.label + ": " + ctx.parsed.y.toLocaleString("vi-VN") + " ƒë";
                } else {
                  const unit = topProducts[ctx.dataIndex]?.donVi || "";
                  return ctx.dataset.label + ": " + ctx.parsed.y.toLocaleString("vi-VN") + (unit ? " " + unit : "");
                }
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 },
          },
          y: {
            position: "left",
            title: { display:true, text: "S·ªë l∆∞·ª£ng" },
            beginAtZero: true
          },
          y1: {
            position: "right",
            title: { display:true, text: "Doanh s·ªë (VND)" },
            beginAtZero: true,
            grid: { drawOnChartArea: false },
            ticks: { callback: v => v.toLocaleString("vi-VN") }
          }
        }
      },
      plugins: [ChartDataLabels, watermarkPlugin]
    });


    // D·ªØ li·ªáu CSKH
  const cskhData = <%- JSON.stringify(cskhData) %>;
  const hinhThucList = <%- JSON.stringify(hinhThucList) %>;

  // T·∫°o datasets cho t·ª´ng h√¨nh th·ª©c
  const cskhDatasets = hinhThucList.map((ht, idx) => ({
    label: ht,
    data: cskhData.map(item => item[ht] || 0),
    backgroundColor: `hsl(${(idx * 60) % 360}, 70%, 60%)`, // t·ª± sinh m√†u kh√°c nhau
    stack: "Stack 0"
  }));

  new Chart(document.getElementById("cskhChart"), {
    type: "bar",
    data: {
      labels: cskhData.map(item => item.nhanVien),
      datasets: cskhDatasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: "üìû B√°o c√°o chƒÉm s√≥c kh√°ch h√†ng", font: { size: 16 } },
        tooltip: {
          callbacks: {
            footer: (items) => {
              const nv = items[0].label;
              const total = cskhData.find(x => x.nhanVien === nv)?.total || 0;
              return `T·ªïng li√™n h·ªá: ${total}`;
            }
          }
        },
        datalabels: {
          color: "#000",
          anchor: "end",
          align: "top",
          formatter: v => v > 0 ? v : "",
          font: ctx => ({ size: Math.max(10, Math.min(14, ctx.chart.width / Math.max(1, cskhData.length) * 0.6)) })
        }
      },
      scales: {
        x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45 } },
        y: { stacked: true, beginAtZero: true }
      }
    },
    plugins: [ChartDataLabels, watermarkPlugin]
  });

  const baidangData = <%- JSON.stringify(baidangData) %>;
  const kenhBaiArray = <%- JSON.stringify(kenhBaiArray) %>;

  // Datasets cho stacked bar
  const baidangDatasets = kenhBaiArray.map((k, idx) => ({
    label: k,
    data: baidangData.map(item => item[k] || 0),
    backgroundColor: `hsl(${(idx * 50) % 360}, 70%, 60%)`,
    stack: "Stack 0"
  }));

  new Chart(document.getElementById("baidangChart"), {
    type: "bar",
    data: {
      labels: baidangData.map(item => item.nhanVien),
      datasets: baidangDatasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: "üì¢ B√°o c√°o ƒëƒÉng b√†i m·∫°ng x√£ h·ªôi", font: { size: 16 } },
        datalabels: {
          color: "#000",
          anchor: "end",
          align: "top",
          formatter: v => v > 0 ? v : "",
          font: ctx => ({
            size: Math.max(10, Math.min(14, ctx.chart.width / Math.max(1, baidangData.length) * 0.6))
          })
        }
      },
      scales: {
        x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45 } },
        y: { stacked: true, beginAtZero: true }
      }
    },
    plugins: [ChartDataLabels, watermarkPlugin]
  });

  const khNguoiTaoData = <%- JSON.stringify(khNguoiTaoData) %>;
  const khNguonData = <%- JSON.stringify(khNguonData) %>;
  const khLoaiData = <%- JSON.stringify(khLoaiData) %>;

  // Bar Chart: kh√°ch h√†ng m·ªõi theo ng∆∞·ªùi t·∫°o
  new Chart(document.getElementById("khachHangNguoiTaoChart"), {
    type: "bar",
    data: {
      labels: khNguoiTaoData.map(x => x.nguoi),
      datasets: [{
        label: "Kh√°ch h√†ng m·ªõi",
        data: khNguoiTaoData.map(x => x.count),
        backgroundColor: "rgba(54, 162, 235, 0.7)"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: "üë§ Kh√°ch h√†ng m·ªõi theo ng∆∞·ªùi t·∫°o", font: { size: 16 } },
        datalabels: {
          color: "#000",
          anchor: "end",
          align: "top",
          formatter: value => value,
          font: ctx => ({
            size: Math.max(10, Math.min(14, ctx.chart.width / Math.max(1, khNguoiTaoData.length) * 0.6))
          })
        }
      },
      scales: {
        y: { beginAtZero: true }
      }
    },
    plugins: [ChartDataLabels, watermarkPlugin]
  });

  // Pie Chart: kh√°ch h√†ng theo ngu·ªìn
  new Chart(document.getElementById("khachHangNguonChart"), {
    type: "pie",
    data: {
      labels: khNguonData.map(x => x.nguon),
      datasets: [{
        data: khNguonData.map(x => x.count),
        backgroundColor: khNguonData.map((_, i) => `hsl(${(i * 50) % 360}, 70%, 60%)`)
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "üìå Ngu·ªìn kh√°ch h√†ng", font: { size: 16 } },
        datalabels: {
          color: "#fff",
          formatter: (value, ctx) => {
            let total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            return total > 0 ? `${((value / total) * 100).toFixed(1)}%` : "0%";
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  // Pie Chart: kh√°ch h√†ng theo lo·∫°i
  new Chart(document.getElementById("khachHangLoaiChart"), {
    type: "pie",
    data: {
      labels: khLoaiData.map(x => x.loai),
      datasets: [{
        data: khLoaiData.map(x => x.count),
        backgroundColor: khLoaiData.map((_, i) => `hsl(${(i * 70) % 360}, 70%, 60%)`)
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "üè∑Ô∏è Lo·∫°i kh√°ch h√†ng", font: { size: 16 } },
        datalabels: {
          color: "#fff",
          formatter: (value, ctx) => {
            let total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            return total > 0 ? `${((value / total) * 100).toFixed(1)}%` : "0%";
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
  </script>
</body>
</html>
