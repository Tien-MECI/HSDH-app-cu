<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Kinh Doanh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .table-header {
            background-color: #2c3e50;
            color: white;
        }
        .quarter-row {
            background-color: #e8f4fd;
            font-weight: bold;
        }
        .total-row {
            background-color: #2ecc71;
            color: white;
            font-weight: bold;
        }
        .number-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4 sticky-header">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="bi bi-graph-up"></i> BÁO CÁO KINH DOANH</h4>
                        <div>
                            <a href="/export/baocaokinhdoanh" class="btn btn-success btn-sm">
                                <i class="bi bi-file-excel"></i> Xuất Excel
                            </a>
                            <button class="btn btn-primary btn-sm" onclick="window.print()">
                                <i class="bi bi-printer"></i> In báo cáo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BẢNG 1 -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">BẢNG 1: TỔNG HỢP DOANH SỐ THEO NĂM/MẢNG SẢN PHẨM</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-header">
                                    <tr>
                                        <th rowspan="2">Quý/Tháng</th>
                                        <th colspan="3" class="text-center"><%= currentYear - 2 %></th>
                                        <th colspan="3" class="text-center"><%= currentYear - 1 %></th>
                                        <th colspan="3" class="text-center"><%= currentYear %></th>
                                    </tr>
                                    <tr>
                                        <% for(let i = 0; i < 3; i++) { %>
                                            <th>Mảng Nhựa</th>
                                            <th>Mảng Nhôm</th>
                                            <th>Tổng</th>
                                        <% } %>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% table1.forEach(row => { %>
                                        <tr class="<%= row.isQuarter ? 'quarter-row' : '' %><%= row.isTotal ? 'total-row' : '' %>">
                                            <td><strong><%= row.label %></strong></td>
                                            <% row.years.forEach(yearData => { %>
                                                <td class="number-cell"><%= formatNumber(yearData.nhua) %></td>
                                                <td class="number-cell"><%= formatNumber(yearData.nhom) %></td>
                                                <td class="number-cell"><strong><%= formatNumber(yearData.tong) %></strong></td>
                                            <% }); %>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BẢNG 2 -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">BẢNG 2: TỔNG HỢP DOANH SỐ THEO NHÂN VIÊN KINH DOANH NĂM <%= currentYear %></h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-header">
                                    <tr>
                                        <th>Quý/Tháng</th>
                                        <% table2.employeeList.forEach(emp => { %>
                                            <th><%= emp %></th>
                                        <% }); %>
                                        <th>Tổng Quý/Tháng</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% table2.data.forEach(row => { %>
                                        <tr class="<%= row.isQuarter ? 'quarter-row' : '' %><%= row.isTotal ? 'total-row' : '' %>">
                                            <td><strong><%= row.label %></strong></td>
                                            <% row.employees.forEach(emp => { %>
                                                <td class="number-cell"><%= formatNumber(emp.doanhSo) %></td>
                                            <% }); %>
                                            <td class="number-cell"><strong><%= formatNumber(row.tongQuy) %></strong></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BẢNG 3 -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">BẢNG 3: BÁO CÁO DOANH SỐ THEO ĐƠN CHI TIẾT</h5>
                        <div>
                            <form class="row g-2" method="GET">
                                <div class="col-auto">
                                    <select name="filterType" class="form-select form-select-sm">
                                        <option value="ngay" <%= filterType === 'ngay' ? 'selected' : '' %>>Theo ngày</option>
                                        <option value="thang" <%= filterType === 'thang' ? 'selected' : '' %>>Theo tháng</option>
                                        <option value="nam" <%= filterType === 'nam' ? 'selected' : '' %>>Theo năm</option>
                                    </select>
                                </div>
                                
                                <% if (filterType === 'ngay') { %>
                                    <div class="col-auto">
                                        <input type="number" name="filterDay" class="form-control form-control-sm" 
                                               placeholder="Ngày" value="<%= filterDay || '' %>" min="1" max="31">
                                    </div>
                                <% } %>
                                
                                <% if (filterType !== 'nam') { %>
                                    <div class="col-auto">
                                        <select name="filterMonth" class="form-select form-select-sm">
                                            <% for(let m = 1; m <= 12; m++) { %>
                                                <option value="<%= m %>" <%= parseInt(filterMonth) === m ? 'selected' : '' %>>
                                                    Tháng <%= m %>
                                                </option>
                                            <% } %>
                                        </select>
                                    </div>
                                <% } %>
                                
                                <div class="col-auto">
                                    <select name="filterYear" class="form-select form-select-sm">
                                        <% for(let y = currentYear - 5; y <= currentYear; y++) { %>
                                            <option value="<%= y %>" <%= parseInt(filterYear) === y ? 'selected' : '' %>>
                                                Năm <%= y %>
                                            </option>
                                        <% } %>
                                    </select>
                                </div>
                                
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="bi bi-search"></i> Lấy báo cáo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-header">
                                    <tr>
                                        <th>STT</th>
                                        <th>Ngày duyệt đơn</th>
                                        <th>Mã đơn hàng</th>
                                        <th>Loại khách</th>
                                        <th>Khách hàng ID</th>
                                        <th>Tên công ty/Khách hàng</th>
                                        <th>Địa chỉ trụ sở</th>
                                        <th>Tỉnh</th>
                                        <th>Tên Người liên hệ</th>
                                        <th>Số điện thoại</th>
                                        <th>Nhóm sản phẩm</th>
                                        <th>Loại đơn hàng</th>
                                        <th>Nhóm sản xuất</th>
                                        <th>Doanh số thực lĩnh</th>
                                        <th>Kinh doanh</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (table3.length === 0) { %>
                                        <tr>
                                            <td colspan="15" class="text-center">Không có dữ liệu</td>
                                        </tr>
                                    <% } else { %>
                                        <% table3.forEach(item => { %>
                                            <tr>
                                                <td><%= item.stt %></td>
                                                <td><%= item.ngayDuyet %></td>
                                                <td><%= item.maDonHang %></td>
                                                <td><%= item.loaiKhach %></td>
                                                <td><%= item.khachHangID %></td>
                                                <td><%= item.tenKhachHang %></td>
                                                <td><%= item.diaChi %></td>
                                                <td><%= item.tinh %></td>
                                                <td><%= item.nguoiLienHe %></td>
                                                <td><%= item.soDienThoai %></td>
                                                <td><%= item.nhomSanPham %></td>
                                                <td><%= item.loaiDonHang %></td>
                                                <td><%= item.nhomSanXuat %></td>
                                                <td class="number-cell"><%= formatNumber(item.doanhSo) %></td>
                                                <td><%= item.kinhDoanh %></td>
                                            </tr>
                                        <% }); %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <% if (table3TotalPages > 1) { %>
                            <div class="pagination-container">
                                <nav>
                                    <ul class="pagination">
                                        <% for(let p = 1; p <= table3TotalPages; p++) { %>
                                            <li class="page-item <%= table3CurrentPage === p ? 'active' : '' %>">
                                                <a class="page-link" href="?page=<%= p %>&filterType=<%= filterType %>&filterMonth=<%= filterMonth %>&filterYear=<%= filterYear %>"><%= p %></a>
                                            </li>
                                        <% } %>
                                    </ul>
                                </nav>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- BẢNG 4 -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">BẢNG 4: BÁO CÁO DOANH SỐ THEO DÒNG SẢN PHẨM</h5>
                        <div>
                            <form class="row g-2" method="GET">
                                <div class="col-auto">
                                    <select name="productYear" class="form-select form-select-sm">
                                        <% for(let y = currentYear - 5; y <= currentYear; y++) { %>
                                            <option value="<%= y %>" <%= parseInt(productYear) === y ? 'selected' : '' %>>
                                                Năm <%= y %>
                                            </option>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="bi bi-search"></i> Lấy báo cáo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-header">
                                    <tr>
                                        <th rowspan="2">Quý/Tháng</th>
                                        <% table4.productGroups.forEach(group => { %>
                                            <th colspan="1"><%= group %></th>
                                        <% }); %>
                                        <th rowspan="2">Tổng tháng/quý</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% table4.data.forEach(row => { %>
                                        <tr class="<%= row.isQuarter ? 'quarter-row' : '' %><%= row.isTotal ? 'total-row' : '' %>">
                                            <td><strong><%= row.label %></strong></td>
                                            <% row.products.forEach(product => { %>
                                                <td class="number-cell"><%= formatNumber(product.doanhSo) %></td>
                                            <% }); %>
                                            <td class="number-cell"><strong><%= formatNumber(row.tongThang) %></strong></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BẢNG 5 -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">BẢNG 5: BÁO CÁO DOANH SỐ MẢNG SẢN PHẨM/NHÂN VIÊN KINH DOANH</h5>
                <div>
                    <form class="row g-2" method="GET">
                        <div class="col-auto">
                            <select name="employeeMonth" class="form-select form-select-sm">
                                <option value="0">Tất cả tháng</option>
                                <% for(let m = 1; m <= 12; m++) { %>
                                    <option value="<%= m %>" <%= parseInt(employeeMonth) === m ? 'selected' : '' %>>
                                        Tháng <%= m %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-auto">
                            <select name="employeeYear" class="form-select form-select-sm">
                                <% for(let y = currentYear - 5; y <= currentYear; y++) { %>
                                    <option value="<%= y %>" <%= parseInt(employeeYear) === y ? 'selected' : '' %>>
                                        Năm <%= y %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-search"></i> Lấy báo cáo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <% table5.periods.forEach(period => { %>
                    <h6 class="bg-light p-2 mb-3"><%= period.label %></h6>
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered table-hover">
                            <thead class="table-header">
                                <tr>
                                    <th>Nhân viên</th>
                                    <% table5.productGroups.forEach(group => { %>
                                        <th><%= group %></th>
                                    <% }); %>
                                    <th>Tổng Nhựa</th>
                                    <th>Tổng Nhôm</th>
                                    <th>Tổng</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% period.data.forEach(empData => { %>
                                    <tr>
                                        <td><%= empData.employee %></td>
                                        <% table5.productGroups.forEach(group => { %>
                                            <td class="number-cell"><%= formatNumber(empData.products[group]) %></td>
                                        <% }); %>
                                        <td class="number-cell"><strong><%= formatNumber(empData.tongNhua) %></strong></td>
                                        <td class="number-cell"><strong><%= formatNumber(empData.tongNhom) %></strong></td>
                                        <td class="number-cell"><strong><%= formatNumber(empData.tong) %></strong></td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% }); %>
            </div>
        </div>
    </div>
</div>

        <!-- BẢNG 6 -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">BẢNG 6: BÁO CÁO DANH SÁCH HỦY ĐƠN HÀNG</h5>
                        <div>
                            <form class="row g-2" method="GET">
                                <div class="col-auto">
                                    <select name="cancelMonth" class="form-select form-select-sm">
                                        <option value="0">Tất cả tháng</option>
                                        <% for(let m = 1; m <= 12; m++) { %>
                                            <option value="<%= m %>" <%= parseInt(cancelMonth) === m ? 'selected' : '' %>>
                                                Tháng <%= m %>
                                            </option>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <select name="cancelYear" class="form-select form-select-sm">
                                        <% for(let y = currentYear - 5; y <= currentYear; y++) { %>
                                            <option value="<%= y %>" <%= parseInt(cancelYear) === y ? 'selected' : '' %>>
                                                Năm <%= y %>
                                            </option>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="bi bi-search"></i> Lấy báo cáo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-header">
                                    <tr>
                                        <th>STT</th>
                                        <th>Khách hàng ID</th>
                                        <th>Tên đầy đủ</th>
                                        <th>Tên người liên hệ</th>
                                        <th>Điện thoại liên hệ</th>
                                        <th>Địa chỉ thực hiện</th>
                                        <th>Mã đơn hàng</th>
                                        <th>Hết hàng</th>
                                        <th>Giá trị hủy</th>
                                        <th>Lý do hủy ghi nhận</th>
                                        <th>Ngày tháng hủy</th>
                                        <th>Khối lượng SP hủy</th>
                                        <th>Ghi chú</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (table6.length === 0) { %>
                                        <tr>
                                            <td colspan="13" class="text-center">Không có dữ liệu</td>
                                        </tr>
                                    <% } else { %>
                                        <% table6.forEach(item => { %>
                                            <tr>
                                                <td><%= item.stt %></td>
                                                <td><%= item.khachHangID %></td>
                                                <td><%= item.tenDayDu %></td>
                                                <td><%= item.nguoiLienHe %></td>
                                                <td><%= item.dienThoai %></td>
                                                <td><%= item.diaChiThucHien %></td>
                                                <td><%= item.maDonHang %></td>
                                                <td>
                                                    <select class="form-select form-select-sm" onchange="updateCancelReason(this, '<%= item.maDonHang %>')">
                                                        <option value="">Chọn lý do</option>
                                                        <option value="Hết hàng">Hết hàng</option>
                                                        <option value="Không đáp ứng tiến độ mua hàng">Không đáp ứng tiến độ mua hàng</option>
                                                        <option value="Không đáp ứng tiến độ sản xuất">Không đáp ứng tiến độ sản xuất</option>
                                                        <option value="lỗi sản xuất">Lỗi sản xuất</option>
                                                        <option value="lỗi kỹ thuật vẽ">Lỗi kỹ thuật vẽ</option>
                                                        <option value="lỗi kỹ thuật lắp đặt">Lỗi kỹ thuật lắp đặt</option>
                                                        <option value="lỗi giao vận">Lỗi giao vận</option>
                                                    </select>
                                                </td>
                                                <td class="number-cell"><%= formatNumber(item.giaTriHuy) %></td>
                                                <td><%= item.lyDoHuy %></td>
                                                <td><%= item.ngayThangHuy %></td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           value="<%= item.khoiLuongSPHuy %>"
                                                           onchange="updateCancelQuantity(this, '<%= item.maDonHang %>')">
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           placeholder="Nhập ghi chú"
                                                           onchange="updateCancelNote(this, '<%= item.maDonHang %>')">
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Hàm định dạng số (client-side)
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Cập nhật lý do hủy
        function updateCancelReason(select, maDonHang) {
            console.log(`Cập nhật lý do hủy cho đơn ${maDonHang}: ${select.value}`);
            // Gửi API cập nhật
        }
        
        // Cập nhật số lượng hủy
        function updateCancelQuantity(input, maDonHang) {
            console.log(`Cập nhật số lượng hủy cho đơn ${maDonHang}: ${input.value}`);
        }
        
        // Cập nhật ghi chú
        function updateCancelNote(input, maDonHang) {
            console.log(`Cập nhật ghi chú cho đơn ${maDonHang}: ${input.value}`);
        }
        
        // Tự động cập nhật ngày khi thay đổi loại filter
        document.querySelector('select[name="filterType"]').addEventListener('change', function() {
            if (this.value === 'nam') {
                document.querySelector('select[name="filterMonth"]').closest('.col-auto').style.display = 'none';
                document.querySelector('input[name="filterDay"]')?.closest('.col-auto').style.display = 'none';
            } else if (this.value === 'thang') {
                document.querySelector('select[name="filterMonth"]').closest('.col-auto').style.display = 'block';
                document.querySelector('input[name="filterDay"]')?.closest('.col-auto').style.display = 'none';
            } else {
                document.querySelector('select[name="filterMonth"]').closest('.col-auto').style.display = 'block';
                document.querySelector('input[name="filterDay"]')?.closest('.col-auto').style.display = 'block';
            }
        });
    </script>
</body>
</html>