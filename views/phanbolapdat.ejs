<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Khoán Lắp Đặt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .card-header {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
        }
        .table-header {
            background-color: #34495e;
            color: white;
        }
        .number-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .summary-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .form-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="bi bi-tools"></i> BÁO CÁO KHOÁN LẮP ĐẶT</h4>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                                <i class="bi bi-file-excel"></i> Xuất Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form tìm kiếm -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="form-container">
                    <form id="searchForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="manv" class="form-label">Mã nhân viên</label>
                            <input type="text" class="form-control" id="manv" name="manv" 
                                   value="<%= manv %>" placeholder="Nhập mã nhân viên">
                        </div>
                        <div class="col-md-3">
                            <label for="thang" class="form-label">Tháng</label>
                            <select class="form-select" id="thang" name="thang">
                                <option value="">Tất cả</option>
                                <% for(let i = 1; i <= 12; i++) { %>
                                    <option value="<%= i %>" <%= thang == i ? 'selected' : '' %>>
                                        Tháng <%= i %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="nam" class="form-label">Năm</label>
                            <select class="form-select" id="nam" name="nam">
                                <% 
                                    const currentYear = new Date().getFullYear();
                                    for(let y = currentYear - 5; y <= currentYear; y++) { 
                                %>
                                    <option value="<%= y %>" <%= nam == y ? 'selected' : '' %>>
                                        Năm <%= y %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Lấy báo cáo
                            </button>
                        </div>
                    </form>
                    
                    <% if (hoTen) { %>
                        <div class="mt-3">
                            <h5>Thông tin nhân viên: <span class="text-primary"><%= hoTen %></span></h5>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Thông báo lỗi -->
        <% if (error) { %>
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> <%= error %>
                    </div>
                </div>
            </div>
        <% } %>

        <!-- Tóm tắt -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="summary-box">
                    <h6><i class="bi bi-cash-stack"></i> Tổng số đơn hàng</h6>
                    <h3 class="text-primary"><%= tongDonHang %></h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-box">
                    <h6><i class="bi bi-currency-dollar"></i> Tổng thành tiền</h6>
                    <h3 class="text-success"><%= formatNumber(tongTien) %></h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-box">
                    <h6><i class="bi bi-calendar-check"></i> Thời gian báo cáo</h6>
                    <h5>
                        <% if (thang && nam) { %>
                            Tháng <%= thang %>/<%= nam %>
                        <% } else { %>
                            Tất cả thời gian
                        <% } %>
                    </h5>
                </div>
            </div>
        </div>

        <!-- BẢNG 1 -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">BẢNG 1: TỔNG HỢP CÁC ĐƠN HÀNG CÓ SỰ THAM GIA LẮP ĐẶT</h5>
                    </div>
                    <div class="card-body">
                        <% if (table1.length === 0) { %>
                            <div class="alert alert-info">
                                Không có dữ liệu đơn hàng nào.
                            </div>
                        <% } else { %>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Mã đơn hàng</th>
                                            <th>Giá trị khoán</th>
                                            <th>Tổng hệ số điểm khoán đơn hàng</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% table1.forEach(item => { %>
                                            <tr>
                                                <td><%= item.stt %></td>
                                                <td><%= item.maDonHang %></td>
                                                <td class="number-cell"><%= formatNumber(item.giaTriKhoan) %></td>
                                                <td class="number-cell"><%= formatNumber(item.tongHeSoDiem) %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- BẢNG 2 -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">BẢNG 2: TỔNG HỢP TIỀN KHOÁN ĐƯỢC HƯỞNG/ĐƠN HÀNG</h5>
                    </div>
                    <div class="card-body">
                        <% if (table2.length === 0) { %>
                            <div class="alert alert-info">
                                Không có dữ liệu phân bổ khoán nào.
                            </div>
                        <% } else { %>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Mã lần thực hiện</th>
                                            <th>Họ tên nhân sự</th>
                                            <th>Vai trò</th>
                                            <th>Hệ số điểm</th>
                                            <th>Đơn giá trung bình</th>
                                            <th>Thành tiền trên lần thực hiện</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% table2.forEach(item => { %>
                                            <tr>
                                                <td><%= item.stt %></td>
                                                <td><%= item.maLanThucHien %></td>
                                                <td><%= item.hoTen %></td>
                                                <td><%= item.vaiTro %></td>
                                                <td class="number-cell"><%= formatNumber(item.heSoDiem) %></td>
                                                <td class="number-cell"><%= formatNumber(item.donGiaTB) %></td>
                                                <td class="number-cell"><strong><%= formatNumber(item.thanhTien) %></strong></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-secondary">
                                            <td colspan="6" class="text-end"><strong>Tổng cộng:</strong></td>
                                            <td class="number-cell"><strong><%= formatNumber(tongTien) %></strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Xử lý form submit
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const manv = document.getElementById('manv').value;
            const thang = document.getElementById('thang').value;
            const nam = document.getElementById('nam').value;
            
            let url = '/lapdat';
            if (manv) {
                url = `/lapdat-${manv}`;
            }
            
            // Thêm query parameters
            const params = new URLSearchParams();
            if (thang) params.append('thang', thang);
            if (nam) params.append('nam', nam);
            
            const queryString = params.toString();
            if (queryString) {
                url += `?${queryString}`;
            }
            
            window.location.href = url;
        });

        // Xuất Excel
        function exportToExcel() {
            const manv = document.getElementById('manv').value;
            const thang = document.getElementById('thang').value;
            const nam = document.getElementById('nam').value;
            
            if (!manv) {
                alert('Vui lòng nhập mã nhân viên trước khi xuất Excel!');
                return;
            }
            
            const params = new URLSearchParams({
                manv: manv,
                thang: thang || '',
                nam: nam || ''
            });
            
            window.location.href = `/export/lapdat?${params.toString()}`;
        }

        // Auto-focus vào ô mã nhân viên
        document.getElementById('manv').focus();
    </script>
</body>
</html>