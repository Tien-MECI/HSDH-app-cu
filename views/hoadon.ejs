<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hóa đơn giá trị gia tăng</title>

<style>
  @page { size: A4 landscape; margin: 0; }

  html, body {
    width: 297mm;
    height: 210mm;
    margin: 0;
    padding: 0;
    font-family: "Times New Roman", serif;
    font-size: 11.5pt;
    line-height: 1.2;
    background: #fff;
  }

  /* WATERMARK FULL TRANG - CĂN CHÍNH GIỮA, KHÔNG ĐÈ CHỮ */
  .watermark {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 297mm;
    height: 210mm;
    z-index: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none;
    opacity: 0.85; /* nhẹ khi xem */
  }
  .watermark img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  @media print {
    .watermark { opacity: 0.22 !important; }
  }

  /* KHUNG CHÍNH - GIỐNG HÓA ĐƠN: CÓ VIỀN, CÁCH MÉP, NỘI DUNG GỌN TRONG NÀY */
  .container {
    position: relative;
    z-index: 10;
    width: 277mm;           /* 297 - 20mm (10mm mỗi bên) */
    height: 190mm;          /* 210 - 20mm */
    margin: 10mm auto;      /* cách đều 10mm 4 phía */
    padding: 8mm 10mm;      /* khoảng cách nội dung đến viền */
    border: 1.5mm solid #000;  /* viền đỏ đậm giống phiếu thật */
    box-sizing: border-box;
    background: #fff;       /* nền trắng để đè lên watermark */
  }

  .content {
    display: flex;
    height: 100%;
  }

  .left, .right {
    width: 50%;
    padding: 0 8mm;
    box-sizing: border-box;
  }
  .left { border-right: 1px solid #000; }

  /* HEADER */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3mm;
  }
  .company-logo { height: 11mm; }
  .company-name {
    font-size: 15pt;
    font-weight: bold;
    text-transform: uppercase;
    text-align: right;
    line-height: 1.1;
  }

  .title {
    text-align: center;
    font-size: 18pt;
    font-weight: bold;
    text-transform: uppercase;
    margin: 2mm 0 1mm;
  }
  .date {
    text-align: center;
    font-style: italic;
    margin-bottom: 4mm;
    font-size: 11pt;
  }

  .ticket {
    border: 1px solid #000;
    padding: 3mm 0;
    text-align: center;
    font-weight: bold;
    font-size: 13pt;
    margin-bottom: 5mm;
  }

  /* BẢNG THÔNG TIN KHÁCH HÀNG - CHỈ KHUNG, KHÔNG NỀN */
  .info-box {
    border: 1px solid #000;
    margin-bottom: 5mm;
    font-size: 11pt;
  }
  .info-box table {
    width: 100%;
    border-collapse: collapse;
  }
  .info-box td {
    border: 1px solid #000;
    padding: 2.3mm 4mm;
    vertical-align: top;
  }
  .info-box td:first-child {
    width: 36%;
    font-weight: bold;
  }

  .commitment {
    border: 1px solid #000;
    padding: 4mm;
    margin: 5mm 0;
    font-size: 11pt;
    line-height: 1.25;
    text-align: justify;
  }

  .prod-table {
    width: 100%;
    border-collapse: collapse;
    margin: 5mm 0;
    font-size: 11pt;
  }
  .prod-table th, .prod-table td {
    border: 1px solid #000;
    padding: 2.5mm 4mm;
    text-align: center;
  }
  .prod-table th { font-weight: bold; }
  .prod-table td:nth-child(2) { text-align: left; padding-left: 6mm; }

  /* CỘT PHẢI */
  .terms-title {
    text-align: center;
    font-size: 17pt;
    font-weight: bold;
    text-transform: uppercase;
    margin-bottom: 5mm;
  }
  .quality-box {
    border: 1px solid #000;
    padding: 4mm;
    margin-bottom: 5mm;
    font-weight: bold;
    font-size: 11.5pt;
    line-height: 1.25;
  }
  .section {
    font-weight: bold;
    margin: 6mm 0 3mm 0;
    font-size: 11.5pt;
  }
  .notice {
    border: 1px solid #000;
    padding: 4mm;
    margin-top: 8mm;
    font-size: 11pt;
    line-height: 1.25;
    text-align: justify;
  }
  p { margin: 2mm 0; text-align: justify; font-size: 11pt; }

  .contact {
    margin-top: 6mm;
    font-size: 11pt;
    line-height: 1.3;
  }

  @media print {
    body, html { background: white; }
    .container { 
      border: 1.5mm solid #000 !important;
      margin: 10mm auto;
      padding: 8mm 10mm;
    }
    .watermark { opacity: 0.22 !important; }
    .left { border-right: 1px solid #000 !important; }
  }
</style>
</head>

<body>
  <% if (watermarkBase64) { %>
    <div class="watermark">
      <img src="<%= watermarkBase64 %>" alt="watermark">
    </div>
  <% } %>

  <div class="container">
    <div class="header">
      <div style="width:140px;">
        <% if (logoBase64) { %>
          <img class="logo" src="<%= logoBase64 %>" alt="logo">
        <% } %>
      </div>

      <div class="header-center">
        <div class="invoice-title">HÓA ĐƠN GIÁ TRỊ GIA TĂNG</div>
        <div class="invoice-sub">(VAT INVOICE)</div>
        <div class="invoice-date">
          Ngày <%= today.getDate() %> tháng <%= today.getMonth()+1 %> năm <%= today.getFullYear() %>
        </div>
      </div>

      <div class="header-right">
        <div>Mẫu số (Form No.): <strong>1</strong></div>
        <div>Ký hiệu (Serial No.): <strong></strong></div>
        <div>Số (Invoice No.): <strong>00000000</strong></div>
      </div>
    </div>

    <div class="section"><strong>Mã CQT (Tax Authority Code):</strong> <strong></strong></div>

    <!-- SELLER -->
    <div class="section">
      <strong>Đơn vị bán hàng (Seller):</strong> CÔNG TY CỔ PHẦN CÔNG NGHIỆP M.E.C.I<br>
      <strong>Mã số thuế (Tax Code):</strong> 0 1 0 5 2 7 3 5 0 1<br>
      <strong>Địa chỉ (Address):</strong> Số 164 đường Nguyễn Trãi, Phường Thanh Xuân, TP Hà Nội, Việt Nam<br>
      <strong>Số điện thoại (Tel):</strong> 0902.227.007 - 0982.934.876 &nbsp; <strong>Website:</strong> www.meci.vn<br>
      <strong>Số tài khoản (Account No.):</strong> 22011686868 tại Ngân hàng TMCP Tiên Phong - Chi nhánh Hoài Đức
    </div>

    <!-- BUYER -->
    <div class="section">
      <strong>Họ tên người mua hàng (Buyer):</strong> ......................................................................<br>
      <strong>Tên đơn vị (Co. name):</strong> <%= order && order.companyName ? order.companyName : "" %><br>
      <strong>Địa chỉ (Address):</strong> <%= order && order.address ? order.address : "" %><br>
      <strong>Số tài khoản (Account No.):</strong> .................................................<br>
      <strong>Hình thức thanh toán (Pay. method):</strong> Tiền mặt/Chuyển khoản &nbsp;
      <strong>Mã số thuế (Tax Code):</strong> <%= order && order.taxCode ? order.taxCode : "" %>
    </div>

    <!-- PRODUCTS -->
    <table>
      <thead>
        <tr>
          <th>STT<br><em>(No.)</em></th>
          <th>Tên hàng hóa, dịch vụ<br><em>(Description)</em></th>
          <th>ĐVT<br><em>(Unit)</em></th>
          <th>SL<br><em>(Qty)</em></th>
          <th>Đơn giá<br><em>(Unit price)</em></th>
          <th>Tiền chưa thuế<br><em>(Amount)</em></th>
          <th>%</th>
          <th>Tiền thuế<br><em>(VAT)</em></th>
          <th>Thành tiền<br><em>(Total)</em></th>
        </tr>
      </thead>

      <tbody>
        <% if (products && products.length) { %>
          <% products.forEach(function(p, idx){ %>
            <tr>
              <td style="text-align:center;"><%= p.stt || (idx+1) %></td>
              <td><%= p.description || "" %></td>
              <td style="text-align:center;"><%= p.unit || "" %></td>
              <td class="right"><%= formatNumber1(p.quantity) %></td>
              <td class="right"><%= formatNumber1(p.unitPrice) %></td>
              <td class="right"><%= formatNumber1(p.amount) %></td>
              <td style="text-align:center;"><%= p.taxRate != null ? p.taxRate + '%' : '' %></td>
              <td class="right"><%= formatNumber1(p.taxAmount) %></td>
              <td class="right"><%= formatNumber1(p.totalAmount) %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="9" style="text-align:center;">Không có dữ liệu</td></tr>
        <% } %>
      </tbody>

      <tfoot>
        <tr>
          <td colspan="5" style="text-align:right;"><strong>Tổng cộng (Amount):</strong></td>
          <td class="right"><strong><%= formatNumber1(totalAmountBeforeTax) %></strong></td>
          <td></td>
          <td class="right"><strong><%= formatNumber1(totalTax) %></strong></td>
          <td class="right"><strong><%= formatNumber1(totalAmount) %></strong></td>
        </tr>
      </tfoot>
    </table>

    <!-- SUMMARY -->
    <table class="summary-table">
      <thead>
        <tr>
          <th>Tổng hợp</th>
          <th>Thuế suất</th>
          <th>Tiền trước thuế</th>
          <th>Tiền thuế GTGT</th>
          <th>Tổng thanh toán</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align:left;">Thuế suất 0%</td>
          <td>0%</td>
          <td class="right"><%= formatNumber1(summary.totalAmount0 || 0) %></td>
          <td class="right">0</td>
          <td class="right"><%= formatNumber1(summary.totalAmount0 || 0) %></td>
        </tr>
        <tr>
          <td style="text-align:left;">Thuế suất 8%</td>
          <td>8%</td>
          <td class="right"><%= formatNumber1(summary.totalAmount8 || 0) %></td>
          <td class="right"><%= formatNumber1(summary.totalTax8 || 0) %></td>
          <td class="right"><%= formatNumber1((summary.totalAmount8||0) + (summary.totalTax8||0)) %></td>
        </tr>
        <tr>
          <td style="text-align:left;">Thuế suất 10%</td>
          <td>10%</td>
          <td class="right"><%= formatNumber1(summary.totalAmount10 || 0) %></td>
          <td class="right"><%= formatNumber1(summary.totalTax10 || 0) %></td>
          <td class="right"><%= formatNumber1((summary.totalAmount10||0) + (summary.totalTax10||0)) %></td>
        </tr>
        <tr>
          <td colspan="2" style="text-align:center;"><strong>Tổng cộng</strong></td>
          <td class="right"><strong><%= formatNumber1(totalAmountBeforeTax) %></strong></td>
          <td class="right"><strong><%= formatNumber1(totalTax) %></strong></td>
          <td class="right"><strong><%= formatNumber1(totalAmount) %></strong></td>
        </tr>
      </tbody>
    </table>

    <div class="amount-in-words">
        <% 
        let amountNum = Number(totalAmount);
        if (!isNaN(amountNum)) {
            amountNum = Math.round(amountNum);
        } else {
          amountNum = 0;
        }
        %>
        Tổng số tiền viết bằng chữ (Amount in words): <strong><%= numberToWords1(amountNum) %> đồng chẵn</strong>
    </div>


    <div class="signature">
      <div>Người mua hàng (Buyer)<br><br><br>(Ký, ghi rõ họ tên)</div>
      <div>Người bán hàng (Seller)<br><br><br>(Ký, ghi rõ họ tên)</div>
    </div>

    <div style="text-align:center; margin-top:8px; font-style:italic;">
      (Cần kiểm tra đối chiếu khi lập, giao, nhận hóa đơn)
    </div>
  </div>
</body>
</html>
