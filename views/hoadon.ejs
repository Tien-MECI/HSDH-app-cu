<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hóa đơn giá trị gia tăng</title>

<style>
  @page { size: A4 portrait; margin: 0; }

  html, body {
    width: 210mm;
    height: 297mm;
    margin: 0 auto;
    padding: 0;
    font-family: "Times New Roman", Times, serif;
    font-size: 12px;
    line-height: 1.3;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    background: #fff;
  }

  /* WATERMARK full trang, căn giữa */
  .watermark {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 210mm;
    height: 297mm;
    z-index: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none;
    opacity: 0.8; /* nhẹ hơn để không che nội dung */
  }
  .watermark img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /*
    CONTAINER:
    - border: 1mm solid black
    - padding (khoảng cách giữa nội dung và khung): 1mm theo yêu cầu
    - margin-top: 10mm để không chồng lên watermark viền trên (nếu watermark có họa tiết sát mép)
  */
    .container {
    position: relative;
    z-index: 1;
    width: 190mm;
    margin: 10mm auto;              /* cách mép trên và dưới 10mm */
    padding: 1mm;                   /* <<< khoảng cách nội dung tới khung = 1mm */
    box-sizing: border-box;
    border: 1mm solid #000;         /* viền đen 1mm */
    background: transparent;
    /* đảm bảo không vượt quá trang in (297mm) trừ margin trên/dưới */
    height: 260mm;
    overflow: visible;              /* nếu bạn muốn nội dung tràn sang trang sau, để visible */
  }

  /* Header */
  .header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    border-bottom: 1px solid #000;
    padding-bottom: 6px;
  }
  .logo { width: 120px; height: auto; }
  .header-center { flex: 1; text-align: center; }
  .invoice-title { font-size: 18px; font-weight: 700; text-transform: uppercase; }
  .invoice-sub { font-style: italic; font-size: 13px; }
  .invoice-date { font-size: 12px; margin-top: 4px; }
  .header-right { text-align: right; font-size: 12px; line-height: 1.25; }

  /* Seller/Buyer blocks */
  .section {
    border: 1px solid #000;
    padding: 6px;
    margin-top: 8px;
    background: #fff;
    line-height: 1.6;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
  }
  th, td {
    border: 1px solid #000;
    padding: 6px;
    font-size: 12px;
    vertical-align: middle;
  }
  thead th {
    font-weight: bold;
    text-align: center;
  }
  th em {
    display: block;
    font-style: italic;
    font-weight: 400;
    font-size: 11px;
    margin-top: 2px;
  }
  td.right { text-align: right; }

  .summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
  }
  .summary-table th, .summary-table td {
    border: 1px solid #000;
    padding: 6px;
    font-size: 12px;
    text-align: center;
  }

  .amount-in-words { margin-top: 12px; font-style: italic; }

  .signature {
    display: flex;
    justify-content: space-between;
    margin-top: 25px;
  }
  .signature div {
    width: 45%;
    text-align: center;
  }

  @media print {
    .watermark { opacity: 0.25 !important; }
    .container {
      border: 1mm solid #000;
      margin: 10mm auto;
      padding: 1mm;
      max-height: calc(297mm - 20mm);
    }
  }
</style>
</head>

<body>
  <% if (watermarkBase64) { %>
    <div class="watermark">
      <img src="<%= watermarkBase64 %>" alt="watermark">
    </div>
  <% } %>

  <div class="container">
    <div class="header">
      <div style="width:140px;">
        <% if (logoBase64) { %>
          <img class="logo" src="<%= logoBase64 %>" alt="logo">
        <% } %>
      </div>

      <div class="header-center">
        <div class="invoice-title">HÓA ĐƠN GIÁ TRỊ GIA TĂNG</div>
        <div class="invoice-sub">(VAT INVOICE)</div>
        <div class="invoice-date">
          Ngày <%= today.getDate() %> tháng <%= today.getMonth()+1 %> năm <%= today.getFullYear() %>
        </div>
      </div>

      <div class="header-right">
        <div>Mẫu số (Form No.): <strong>1</strong></div>
        <div>Ký hiệu (Serial No.): <strong></strong></div>
        <div>Số (Invoice No.): <strong>00000000</strong></div>
      </div>
    </div>

    <div class="section">Mã CQT (Tax Authority Code): <strong></strong></div>

    <!-- SELLER -->
    <div class="section">
      <strong>Đơn vị bán hàng (Seller):</strong> CÔNG TY CỔ PHẦN CÔNG NGHIỆP M.E.C.I<br>
      <strong>Mã số thuế (Tax Code):</strong> 0 1 0 5 2 7 3 5 0 1<br>
      <strong>Địa chỉ (Address):</strong> Số 164 đường Nguyễn Trãi, Phường Thanh Xuân, TP Hà Nội, Việt Nam<br>
      <strong>Số điện thoại (Tel):</strong> 0902.227.007 - 0982.934.876 &nbsp; <strong>Website:</strong> www.meci.vn<br>
      <strong>Số tài khoản (Account No.):</strong> 22011686868 tại Ngân hàng TMCP Tiên Phong - Chi nhánh Hoài Đức
    </div>

    <!-- BUYER -->
    <div class="section">
      <strong>Họ tên người mua hàng (Buyer):</strong> ......................................................................<br>
      <strong>Tên đơn vị (Co. name):</strong> <%= order && order.companyName ? order.companyName : "" %><br>
      <strong>Địa chỉ (Address):</strong> <%= order && order.address ? order.address : "" %><br>
      <strong>Số tài khoản (Account No.):</strong> .................................................<br>
      <strong>Hình thức thanh toán (Pay. method):</strong> Tiền mặt/Chuyển khoản &nbsp;
      <strong>Mã số thuế (Tax Code):</strong> <%= order && order.taxCode ? order.taxCode : "" %>
    </div>

    <!-- PRODUCTS -->
    <table>
      <thead>
        <tr>
          <th>STT<br><em>(No.)</em></th>
          <th>Tên hàng hóa, dịch vụ<br><em>(Description)</em></th>
          <th>ĐVT<br><em>(Unit)</em></th>
          <th>SL<br><em>(Qty)</em></th>
          <th>Đơn giá<br><em>(Unit price)</em></th>
          <th>Tiền chưa thuế<br><em>(Amount)</em></th>
          <th>%</th>
          <th>Tiền thuế<br><em>(VAT)</em></th>
          <th>Thành tiền<br><em>(Total)</em></th>
        </tr>
      </thead>

      <tbody>
        <% if (products && products.length) { %>
          <% products.forEach(function(p, idx){ %>
            <tr>
              <td style="text-align:center;"><%= p.stt || (idx+1) %></td>
              <td><%= p.description || "" %></td>
              <td style="text-align:center;"><%= p.unit || "" %></td>
              <td class="right"><%= formatNumber1(p.quantity) %></td>
              <td class="right"><%= formatNumber1(p.unitPrice) %></td>
              <td class="right"><%= formatNumber1(p.amount) %></td>
              <td style="text-align:center;"><%= p.taxRate != null ? p.taxRate + '%' : '' %></td>
              <td class="right"><%= formatNumber1(p.taxAmount) %></td>
              <td class="right"><%= formatNumber1(p.totalAmount) %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="9" style="text-align:center;">Không có dữ liệu</td></tr>
        <% } %>
      </tbody>

      <tfoot>
        <tr>
          <td colspan="5" style="text-align:right;"><strong>Tổng cộng (Amount):</strong></td>
          <td class="right"><strong><%= formatNumber1(totalAmountBeforeTax) %></strong></td>
          <td></td>
          <td class="right"><strong><%= formatNumber1(totalTax) %></strong></td>
          <td class="right"><strong><%= formatNumber1(totalAmount) %></strong></td>
        </tr>
      </tfoot>
    </table>

    <!-- SUMMARY -->
    <table class="summary-table">
      <thead>
        <tr>
          <th>Tổng hợp</th>
          <th>Thuế suất</th>
          <th>Tiền trước thuế</th>
          <th>Tiền thuế GTGT</th>
          <th>Tổng thanh toán</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align:left;">Thuế suất 0%</td>
          <td>0%</td>
          <td class="right"><%= formatNumber1(summary.totalAmount0 || 0) %></td>
          <td class="right">0</td>
          <td class="right"><%= formatNumber1(summary.totalAmount0 || 0) %></td>
        </tr>
        <tr>
          <td style="text-align:left;">Thuế suất 8%</td>
          <td>8%</td>
          <td class="right"><%= formatNumber1(summary.totalAmount8 || 0) %></td>
          <td class="right"><%= formatNumber1(summary.totalTax8 || 0) %></td>
          <td class="right"><%= formatNumber1((summary.totalAmount8||0) + (summary.totalTax8||0)) %></td>
        </tr>
        <tr>
          <td style="text-align:left;">Thuế suất 10%</td>
          <td>10%</td>
          <td class="right"><%= formatNumber1(summary.totalAmount10 || 0) %></td>
          <td class="right"><%= formatNumber1(summary.totalTax10 || 0) %></td>
          <td class="right"><%= formatNumber1((summary.totalAmount10||0) + (summary.totalTax10||0)) %></td>
        </tr>
        <tr>
          <td colspan="2" style="text-align:center;"><strong>Tổng cộng</strong></td>
          <td class="right"><strong><%= formatNumber1(totalAmountBeforeTax) %></strong></td>
          <td class="right"><strong><%= formatNumber1(totalTax) %></strong></td>
          <td class="right"><strong><%= formatNumber1(totalAmount) %></strong></td>
        </tr>
      </tbody>
    </table>

    <div class="amount-in-words">
        <% 
        let amountNum = Number(totalAmount);
        if (!isNaN(amountNum)) {
            amountNum = Math.round(amountNum);
        } else {
          amountNum = 0;
        }
        %>
        Tổng số tiền viết bằng chữ (Amount in words): <strong><%= numberToWords1(amountNum) %> đồng chẵn</strong>
    </div>


    <div class="signature">
      <div>Người mua hàng (Buyer)<br><br><br>(Ký, ghi rõ họ tên)</div>
      <div>Người bán hàng (Seller)<br><br><br>(Ký, ghi rõ họ tên)</div>
    </div>

    <div style="text-align:center; margin-top:8px; font-style:italic;">
      (Cần kiểm tra đối chiếu khi lập, giao, nhận hóa đơn)
    </div>
  </div>
</body>
</html>
