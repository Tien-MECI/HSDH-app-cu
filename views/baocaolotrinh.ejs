<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo lộ trình xe tháng <%= data.thang %>/<%= data.nam %></title>
  <style>
    body { font-family: "Times New Roman", serif; margin: 25px; position: relative; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #000; padding: 5px 3px; text-align: center; vertical-align: middle; line-height: 1.4; }
    th { background-color: #d9d9d9; font-weight: bold; }
    .logo { height: 70px; }
    .title { font-weight: bold; font-size: 22px; color: #c00; margin: 5px 0; }
    .watermark { position: absolute; top: 48%; left: 50%; transform: translate(-50%, -50%) rotate(-35deg); opacity: 0.07; z-index: -1; }
    .watermark img { width: 1000px; }
    .bold { font-weight: bold; }
    .text-left { text-align: left !important; padding-left: 8px; }
    .small { font-size: 11px; }
    .footer { margin-top: 80px; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
  </style>
</head>
<body>

<% if (!data) { %>
  <div style="text-align:center; margin-top:120px;">
    <h2>Chọn tháng/năm để xem báo cáo</h2>
    <form method="GET">
      <select name="thang" required><% for(let i=1;i<=12;i++) { %><option value="<%=i%>"><%=i%> tháng</option><% } %></select>
      <input type="number" name="nam" value="<%= new Date().getFullYear() %>" min="2020" required style="width:80px;">
      <button type="submit" style="padding:8px 20px; margin-left:10px;">Xem báo cáo</button>
    </form>
  </div>
<% } else { %>

  <% if (watermark) { %>
    <div class="watermark"><img src="<%= watermark %>" /></div>
  <% } %>

  <div style="text-align:center; margin-bottom:10px;">
    <% if (logo) { %><img src="<%= logo %>" class="logo" alt="MECI"><% } %><br>
    <div class="title">CÔNG TY CỔ PHẦN CÔNG NGHIỆP MECI</div>
    <h2>BẢNG TỔNG HỢP HÀNH TRÌNH XE THÁNG <%= data.thang %>/<%= data.nam %></h2>
  </div>

  <table>
    <thead>
      <!-- Dòng 1: Giá khấu hao -->
      <tr>
        <th rowspan="2">Tên người<br>sử dụng xe</th>
        <th rowspan="2">Định mức<br>nhiên liệu<br>/100km</th>
        <% data.xeArray.forEach(xe => { %>
          <th colspan="1" class="small">
            Giá khấu hao phương tiện<br>
            Lấy theo tên xe ở bảng data_phuong_tien cột số 7
          </th>
        <% }) %>
        <th rowspan="2">Tổng số km<br>sử dụng<br>cá nhân</th>
        <th rowspan="2">Tiền<br>khấu hao</th>
        <th rowspan="2">Tiền<br>nhiên liệu</th>
        <th rowspan="2">Thành tiền</th>
        <th rowspan="2">Tiền<br>Epass</th>
        <th rowspan="2">Tổng<br>thành tiền</th>
        <th rowspan="2">Ký xác nhận</th>
      </tr>

      <!-- Dòng 2: Giá nhiên liệu + Định mức + Loại nhiên liệu -->
      <tr>
        <% data.xeArray.forEach(xe => { %>
          <th class="small">
            Giá nhiên liệu trong tháng<br>
            Lấy giá trung bình của code tính và ghi vào<br><br>
            Định mức nhiên liệu/100km<br>
            Lấy theo tên xe ở bảng data_phuong_tien cột số 6<br><br>
            Loại nhiên liệu<br>
            Lấy theo tên xe ở bảng data_phuong_tien cột số 5
          </th>
        <% }) %>
      </tr>

      <!-- Dòng 3: Tên xe -->
      <tr>
        <th></th>
        <th></th>
        <% data.xeArray.forEach(xe => { %>
          <th><%= xe.tenXe %></th>
        <% }) %>
        <th colspan="6"></th>
      </tr>
    </thead>

    <tbody>
      <!-- Dòng người sử dụng cá nhân -->
      <% 
        const nguoiCaNhan = {};
        data.xeArray.forEach(xe => {
          Array.from(xe.nguoiSD_CaNhan).forEach(name => {
            nguoiCaNhan[name] = nguoiCaNhan[name] || { xe: [], km: 0 };
            nguoiCaNhan[name].xe.push(xe.tenXe);
            nguoiCaNhan[name].km += xe.kmCaNhan;
          });
        });
      %>

      <% Object.keys(nguoiCaNhan).forEach((ten, idx) => { %>
        <tr>
          <td class="text-left bold" rowspan="1"><%= ten %></td>
          <% if (idx === 0) { %>
            <td rowspan="<%= Object.keys(nguoiCaNhan).length + (data.coXeQuangMinh ? 2 : 1) %>" class="bold">
              <%= data.xeArray.length > 0 ? data.xeArray[0].dinhMucNL : 0 %>
            </td>
          <% } %>
          <% data.xeArray.forEach(xe => { %>
            <td>
              <% if (xe.nguoiSD_CaNhan.has(ten)) { %>
                <%= xe.kmCaNhan.toLocaleString() %>
              <% } %>
            </td>
          <% }) %>
          <% if (idx === 0) { %>
            <td rowspan="<%= Object.keys(nguoiCaNhan).length + (data.coXeQuangMinh ? 2 : 1) %>" class="bold">
              <%= data.tongKmCaNhan.toLocaleString() %>
            </td>
            <td rowspan="<%= Object.keys(nguoiCaNhan).length + (data.coXeQuangMinh ? 2 : 1) %>" class="bold"><%= data.tongTienKhauHao.toLocaleString() %></td>
            <td rowspan="<%= Object.keys(nguoiCaNhan).length + (data.coXeQuangMinh ? 2 : 1) %>" class="bold"><%= data.tongTienNhienLieu.toLocaleString() %></td>
            <td rowspan="<%= Object.keys(nguoiCaNhan).length + (data.coXeQuangMinh ? 2 : 1) %>" class="bold"><%= data.tongThanhTien.toLocaleString() %></td>
            <td rowspan="<%= Object.keys(nguoiCaNhan).length + (data.coXeQuangMinh ? 2 : 1) %>" class="bold"><%= data.tongEpass.toLocaleString() %></td>
            <td rowspan="<%= Object.keys(nguoiCaNhan).length + (data.coXeQuangMinh ? 2 : 1) %>" class="bold"><%= data.tongCuoi.toLocaleString() %></td>
            <td rowspan="<%= Object.keys(nguoiCaNhan).length + (data.coXeQuangMinh ? 2 : 1) %>"></td>
          <% } %>
        </tr>
      <% }) %>

      <!-- Dòng Xe Quang Minh (nếu có) -->
      <% if (data.coXeQuangMinh) { %>
        <tr>
          <td class="text-left small">
            Nếu Xe Quang Minh có số km sử dụng thì tạo hàng này và ghi tên người là MECI sử dụng
          </td>
          <% data.xeArray.forEach(xe => { %>
            <td>
              <% if (xe.tenXe === 'Xe Quang Minh') { %>
                <%= xe.kmQuangMinh.toLocaleString() %>
              <% } %>
            </td>
          <% }) %>
        </tr>
      <% } %>
    </tbody>
  </table>

  <div class="footer">
    <div>Ban giám đốc</div>
    <div>PT kế toán</div>
    <div>Người lập phiếu</div>
  </div>

<% } %>
</body>
</html>