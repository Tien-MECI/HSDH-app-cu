<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B√°o c√°o l·ªô tr√¨nh xe th√°ng <%= data ? data.thang : '' %>/<%= data ? data.nam : '' %></title>
  <style>
    /* CƒÉn ch·ªânh cho in ·∫•n */
    @page {
      size: A4 landscape;
      margin: 0;
    }
    
    @media print {
      body {
        margin: 0 !important;
        padding: 0 !important;
        width: 297mm !important;
        height: 210mm !important;
        overflow: hidden !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .no-print { display: none !important; }
      
      table {
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        width: 100% !important;
      }
      
      tr { page-break-inside: avoid !important; }
    }
    
    @media screen {
      body {
        width: 297mm;
        min-height: 210mm;
        margin: 10px auto;
        padding: 15mm;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        background: white;
      }
    }
    
    body {
      font-family: "Times New Roman", serif;
      margin: 0;
      padding: 15mm;
      position: relative;
      font-size: 13px;
      background: white;
      box-sizing: border-box;
    }
    
    .report-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
      word-wrap: break-word;
      border-spacing: 0;
    }
    
    th, td {
      border: 1px solid #000;
      padding: 6px;
      text-align: center;
      vertical-align: middle;
      height: 24px;
      overflow: hidden;
      box-sizing: border-box;
    }
    
    th {
      background-color: #e9f0fb;
      font-weight: bold;
      page-break-inside: avoid;
    }
    
    .logo { 
      height: 65px;
      max-height: 65px;
    }
    
    .title { 
      font-weight: bold; 
      font-size: 18px; 
      color: #c00;
      margin: 5px 0;
    }
    
    .watermark { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%) rotate(-35deg); 
      opacity: 0.06; 
      z-index: -1; 
      pointer-events: none;
      width: 100%;
      text-align: center;
    }
    
    .watermark img { 
      width: 900px;
      max-width: 90%;
    }
    
    .bold { font-weight: bold; }
    
    .text-left { 
      text-align: left !important;
      padding-left: 8px;
    }
    
    .small { 
      font-size: 11px; 
      line-height: 1.2; 
      text-align: left; 
      padding-left: 6px;
    }
    
    .footer { 
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      font-size: 14px;
      position: relative;
      bottom: 0;
      width: 100%;
    }
    
    .col-vehicle { white-space: nowrap; }
    
    /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc c·ªôt */
    .vehicle-cell { 
      width: 6%;
      min-width: 40px;
      max-width: 60px;
    }
    
    /* ƒê·∫£m b·∫£o chi·ªÅu r·ªông c·ªôt c·ªë ƒë·ªãnh */
    th:first-child,
    td:first-child {
      width: 9%;
      min-width: 70px;
    }
    
    th:nth-child(2),
    td:nth-child(2) {
      width: 6%;
      min-width: 50px;
    }
    
    /* C·ªôt t·ªïng */
    th:nth-last-child(-n+7),
    td:nth-last-child(-n+7) {
      width: 7%;
      min-width: 60px;
    }
    
    /* ƒê·∫£m b·∫£o kh√¥ng b·ªã wrap trong c√°c √¥ */
    th, td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Form ch·ªçn th√°ng/nƒÉm */
    .form-container {
      text-align: center;
      margin-top: 100px;
      padding: 20px;
    }
    
    .form-container form {
      display: inline-block;
      background: #f5f5f5;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .form-container select,
    .form-container input {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    
    .form-container button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .form-container button:hover {
      background: #0056b3;
    }
    
    /* Header b√°o c√°o */
    .report-header {
      text-align: center;
      margin-bottom: 15px;
      page-break-after: avoid;
    }
    
    /* ƒê·∫£m b·∫£o kh√¥ng b·ªã c·∫Øt khi in */
    .avoid-break {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    /* Print button */
    .print-button {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }
    
    .print-button:hover {
      background: #218838;
    }
  </style>
</head>
<body>

<% if (!data) { %>
  <div class="form-container">
    <h2>Ch·ªçn th√°ng/nƒÉm ƒë·ªÉ xem b√°o c√°o l·ªô tr√¨nh xe</h2>
    <form method="GET">
      <select name="thang" required>
        <% for(let i=1;i<=12;i++){ %>
          <option value="<%=i%>"><%=i%></option>
        <% } %>
      </select>
      <span>th√°ng</span>
      <input type="number" name="nam" value="<%= new Date().getFullYear() %>" min="2020" required style="width:80px;">
      <button type="submit">Xem b√°o c√°o</button>
    </form>
  </div>
<% } else { %>
  <button class="print-button no-print" onclick="window.print()">üñ®Ô∏è In b√°o c√°o</button>

  <% if (watermark) { %>
    <div class="watermark"><img src="<%= watermark %>" alt="watermark" /></div>
  <% } %>

  <div class="report-container">
    <div class="report-header">
      <% if (logo) { %>
        <img src="<%= logo %>" class="logo" alt="MECI">
      <% } %>
      <br>
      <div class="title">C√îNG TY C·ªî PH·∫¶N C√îNG NGHI·ªÜP MECI</div>
      <h2>B·∫¢NG T·ªîNG H·ª¢P H√ÄNH TR√åNH XE TH√ÅNG <%= data.thang %>/<%= data.nam %></h2>
    </div>

    <%
      // ========= PREPARE helper data =========
      data.xeArray.forEach(x => {
        if (x && x.nguoiSD_CaNhan && typeof x.nguoiSD_CaNhan.forEach === 'function' && !Array.isArray(x.nguoiSD_CaNhan)) {
          x._nguoiSDArr = Array.from(x.nguoiSD_CaNhan);
        } else {
          x._nguoiSDArr = x && x.nguoiSD_CaNhan ? (Array.isArray(x.nguoiSD_CaNhan) ? x.nguoiSD_CaNhan : []) : [];
        }
        
        if (x.userKmMap && typeof x.userKmMap === 'object' && !(x.userKmMap instanceof Map)) {
          x._userKmMap = x.userKmMap;
        } else if (x.userKmMap instanceof Map) {
          x._userKmMap = {};
          for (let [k,v] of x.userKmMap) x._userKmMap[k]=v;
        } else {
          x._userKmMap = {};
        }
      });

      const userSet = new Set();
      data.xeArray.forEach(x => {
        x._nguoiSDArr.forEach(u => { if (u) userSet.add(u); });
      });

      let hasQM = false;
      const xeQuangMinh = data.xeArray.find(x => (x.tenXe || '').trim().toLowerCase() === 'xe quang minh');
      if (xeQuangMinh && (parseFloat(xeQuangMinh.kmQuangMinh) || 0) > 0) {
        hasQM = true;
        userSet.add('MECI s·ª≠ d·ª•ng');
      }

      const danhSachNguoi = Array.from(userSet);
      danhSachNguoi.sort((a,b) => {
        if (a === 'MECI s·ª≠ d·ª•ng') return 1;
        if (b === 'MECI s·ª≠ d·ª•ng') return -1;
        return a.localeCompare(b,'vi');
      });
    %>

    <table class="avoid-break">
      <thead>
        <!-- D√íNG 1: Kh·∫•u hao / gi√° nhi√™n li·ªáu TB -->
        <tr style="height: 48px;">
          <th rowspan="4" style="width:9%; vertical-align:middle; font-weight:normal;">
            T√™n ng∆∞·ªùi<br>s·ª≠ d·ª•ng xe
          </th>
          <th style="width:6%; font-size:11px; font-weight:bold; background:#f4f4f4; line-height:1.3;">
            Kh·∫•u hao/<br>gi√° nhi√™n li·ªáu TB
          </th>
          <% data.xeArray.forEach(function(xe){ %>
            <th colspan="2" style="font-size:11px; background:#fff; line-height:1.4; padding:4px;">
              Kh·∫•u hao: <%= Math.round(xe.dinhMucKH || 0).toLocaleString() %> ƒë/km<br>
              Gi√° <%= xe.loaiNhienLieu %> TB: <%= (data.donGiaTB[xe.loaiNhienLieu] || 0).toLocaleString() %> ƒë/l√≠t
            </th>
          <% }); %>
          <th rowspan="4" style="width:7%;">T·ªïng s·ªë km<br>s·ª≠ d·ª•ng<br>c√° nh√¢n</th>
          <th rowspan="4" style="width:7%;">Ti·ªÅn<br>Kh·∫•u hao</th>
          <th rowspan="4" style="width:7%;">Ti·ªÅn<br>nhi√™n li·ªáu</th>
          <th rowspan="4" style="width:7%;">Th√†nh ti·ªÅn</th>
          <th rowspan="4" style="width:7%;">Ti·ªÅn<br>Epass</th>
          <th rowspan="4" style="width:7%;">T·ªïng<br>th√†nh ti·ªÅn</th>
          <th rowspan="4" style="width:7%;">K√Ω<br>x√°c nh·∫≠n</th>
        </tr>

        <!-- D√íNG 2: Lo·∫°i xe (t√™n xe) -->
        <tr style="height: 38px;">
          <th style="width:6%; font-size:11px; font-weight:bold; background:#f9f9f9;">
            Lo·∫°i xe
          </th>
          <% data.xeArray.forEach(function(xe){ %>
            <th colspan="2" style="font-weight:bold; font-size:14px; vertical-align:middle;">
              <%= xe.tenXe %>
            </th>
          <% }); %>
        </tr>

        <!-- D√íNG 3: QM thu√™ MECI / MC thu√™ QM | C√° nh√¢n -->
        <tr style="height: 28px;">
          <th style="width:6%; font-size:11px; background:#f4f4f4;">
            Lo·∫°i
          </th>
          <% data.xeArray.forEach(function(xe){ 
              const ten = (xe.tenXe || '').trim().toLowerCase();
              const isQuangMinh = ten.includes('quang minh') || ten === 'xe quang minh';
          %>
            <th style="font-size:11px;"><%= isQuangMinh ? 'MC thu√™ QM' : 'QM thu√™ MECI' %></th>
            <th style="font-size:11px;">C√° nh√¢n</th>
          <% }); %>
        </tr>

        <!-- D√íNG 4: ƒê·ªãnh m·ª©c + Lo·∫°i nhi√™n li·ªáu -->
        <tr style="height: 28px;">
          <th style="width:6%; font-size:11px; background:#f9f9f9;">
            ƒê·ªãnh m·ª©c<br>(l√≠t/100km)
          </th>
          <% data.xeArray.forEach(function(xe){ %>
            <th style="font-size:11px;"><%= xe.dinhMucNL || '' %></th>
            <th style="font-size:11px;"><%= xe.loaiNhienLieu || 'DO' %></th>
          <% }); %>
        </tr>
      </thead>

      <tbody>
        <% 
          function kmForUserOnVehicle(xe, user) {
            if (user === 'MECI s·ª≠ d·ª•ng') {
              if ((xe.tenXe || '').trim().toLowerCase() === 'xe quang minh') {
                return Number(xe.kmQuangMinh) || 0;
              }
              return 0;
            }
            
            if (xe._userKmMap && typeof xe._userKmMap === 'object' && xe._userKmMap[user] != null) {
              return Number(xe._userKmMap[user]) || 0;
            }
            
            if (Array.isArray(xe._nguoiSDArr) && xe._nguoiSDArr.length === 1 && xe._nguoiSDArr[0] === user) {
              return Number(xe.kmCaNhan) || 0;
            }
            
            if (Array.isArray(xe._nguoiSDArr) && xe._nguoiSDArr.includes(user)) {
              if (Number(xe.kmCaNhan) && xe._nguoiSDArr.length > 0) {
                return Math.round(Number(xe.kmCaNhan) / xe._nguoiSDArr.length);
              }
              return 0;
            }
            return 0;
          }
        %>

        <% for (let i = 0; i < danhSachNguoi.length; i++) { 
             const user = danhSachNguoi[i];
             let totalKmUser = 0;
             let totalKhauHao_user = 0;
             let totalNhienLieu_user = 0;
             let totalEpass_user = (data.userEpass && data.userEpass[user]) ? Number(data.userEpass[user]) : 0;
        %>
          <tr class="avoid-break">
            <td class="text-left"><%= user %></td>
            <td></td>

            <% data.xeArray.forEach(function(xe){
                const km = kmForUserOnVehicle(xe, user) || 0;
                const khauhao = Math.round(km * (Number(xe.dinhMucKH) || 0));
                const nhienlieu = Math.round((km * (Number(xe.dinhMucNL) || 0) / 100) * (Number(data.donGiaTB) || 0));
                totalKmUser += km;
                totalKhauHao_user += khauhao;
                totalNhienLieu_user += nhienlieu;
            %>
              <td class="vehicle-cell"><%= (user === 'MECI s·ª≠ d·ª•ng' && (xe.tenXe || '').trim().toLowerCase() === 'xe quang minh') ? (km ? km.toLocaleString() : '') : '' %></td>
              <td class="vehicle-cell"><%= (user !== 'MECI s·ª≠ d·ª•ng') ? (km ? km.toLocaleString() : '') : '' %></td>
            <% }); %>

            <td class="bold"><%= totalKmUser ? totalKmUser.toLocaleString() : '' %></td>
            <td class="bold"><%= totalKhauHao_user ? totalKhauHao_user.toLocaleString() : '' %></td>
            <td class="bold"><%= totalNhienLieu_user ? totalNhienLieu_user.toLocaleString() : '' %></td>
            <td class="bold"><%= (totalKhauHao_user + totalNhienLieu_user) ? (totalKhauHao_user + totalNhienLieu_user).toLocaleString() : '' %></td>
            <td class="bold"><%= totalEpass_user ? totalEpass_user.toLocaleString() : '' %></td>
            <td class="bold"><%= ( (totalKhauHao_user + totalNhienLieu_user) + totalEpass_user ) ? ( (totalKhauHao_user + totalNhienLieu_user) + totalEpass_user ).toLocaleString() : '' %></td>
            <td></td>
          </tr>
        <% } %>

        <%
          let grandKm = 0, grandKh = 0, grandNl = 0, grandEpass = 0;
          for (let ui=0; ui<danhSachNguoi.length; ui++) {
            const u = danhSachNguoi[ui];
            let totKm=0, totKh=0, totNl=0, totEp= (data.userEpass && data.userEpass[u]) ? Number(data.userEpass[u]) : 0;
            data.xeArray.forEach(function(xe){
              const k = kmForUserOnVehicle(xe,u) || 0;
              totKm += k;
              totKh += Math.round(k * (Number(xe.dinhMucKH) || 0));
              totNl += Math.round((k * (Number(xe.dinhMucNL) || 0) / 100) * (Number(data.donGiaTB) || 0));
            });
            grandKm += totKm; grandKh += totKh; grandNl += totNl; grandEpass += totEp;
          }
        %>
        <tr class="avoid-break">
          <td class="text-left bold">T·ªïng</td>
          <td></td>
          <% data.xeArray.forEach(function(xe){ %>
            <td></td><td></td>
          <% }); %>
          <td class="bold"><%= grandKm ? grandKm.toLocaleString() : '' %></td>
          <td class="bold"><%= grandKh ? grandKh.toLocaleString() : '' %></td>
          <td class="bold"><%= grandNl ? grandNl.toLocaleString() : '' %></td>
          <td class="bold"><%= (grandKh + grandNl) ? (grandKh + grandNl).toLocaleString() : '' %></td>
          <td class="bold"><%= grandEpass ? grandEpass.toLocaleString() : '' %></td>
          <td class="bold"><%= (grandKh + grandNl + grandEpass) ? (grandKh + grandNl + grandEpass).toLocaleString() : '' %></td>
          <td></td>
        </tr>
      </tbody>
    </table>

    <div class="footer avoid-break">
      <div>Ban gi√°m ƒë·ªëc</div>
      <div>PT k·∫ø to√°n</div>
      <div>Ng∆∞·ªùi l·∫≠p phi·∫øu</div>
    </div>
  </div>
<% } %>

<script>
  // ƒê·∫£m b·∫£o khi in s·∫Ω kh√¥ng b·ªã scale
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof data !== 'undefined' && data) {
      // Th√™m style ƒë·ªÉ ngƒÉn tr√¨nh duy·ªát t·ª± ƒë·ªông scale khi in
      const style = document.createElement('style');
      style.textContent = `
        @media print {
          body {
            transform: scale(1) !important;
            zoom: 1 !important;
            -webkit-print-color-adjust: exact !important;
          }
        }
      `;
      document.head.appendChild(style);
      
      // N√∫t in
      const printBtn = document.querySelector('.print-button');
      if (printBtn) {
        printBtn.addEventListener('click', function() {
          // ƒê·∫£m b·∫£o t·∫•t c·∫£ CSS ƒë√£ load xong tr∆∞·ªõc khi in
          setTimeout(() => {
            window.print();
          }, 100);
        });
      }
    }
  });
</script>

</body>
</html>