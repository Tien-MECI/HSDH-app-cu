<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo lộ trình xe tháng <%= data ? data.thang : '' %>/<%= data ? data.nam : '' %></title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; position: relative; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid black; padding: 6px; text-align: center; vertical-align: middle; }
    th { background: #f0f0f0; }
    .logo { height: 70px; }
    .title { font-size: 20px; font-weight: bold; color: #c00; }
    .watermark { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) rotate(-35deg); opacity: 0.08; z-index: -1; }
    .watermark img { width: 900px; }
    .bold { font-weight: bold; }
    .text-left { text-align: left !important; }
    .footer { margin-top: 80px; display: flex; justify-content: space-between; font-weight: bold; }
  </style>
</head>
<body>

<% if (!data) { %>
  <h2 style="text-align:center;">Chọn tháng/năm để xem báo cáo lộ trình xe</h2>
  <form method="GET" style="text-align:center; margin:30px;">
    <select name="thang" required>
      <% for(let i=1;i<=12;i++) { %>
        <option value="<%=i%>"><%=i%> tháng</option>
      <% } %>
    </select>
    <input type="number" name="nam" value="<%= new Date().getFullYear() %>" min="2020" style="width:80px;" required>
    <button type="submit" style="padding:8px 16px;">Xem báo cáo</button>
  </form>
<% } else { %>

  <% if (watermark) { %>
    <div class="watermark"><img src="<%= watermark %>" /></div>
  <% } %>

  <div style="text-align:center; margin-bottom:20px;">
    <% if (logo) { %><img src="<%= logo %>" class="logo" alt="MECI"><% } %><br>
    <div class="title">CÔNG TY CỔ PHẦN CÔNG NGHIỆP MECI</div>
    <h2>BẢNG TỔNG HỢP HÀNH TRÌNH XE THÁNG <%= data.thang %>/<%= data.nam %></h2>
  </div>

  <table>
    <thead>
      <tr>
        <th rowspan="2">Tên người sử dụng xe</th>
        <th rowspan="2">Định mức nhiên liệu/100km</th>
        <% data.xeArray.forEach(xe => { %>
          <th colspan="2"><%= xe.tenXe %></th>
        <% }) %>
        <th rowspan="2">Tổng số km sử dụng cá nhân</th>
        <th rowspan="2">Tiền khấu hao</th>
        <th rowspan="2">Tiền nhiên liệu</th>
        <th rowspan="2">Thành tiền</th>
        <th rowspan="2">Tiền Epass</th>
        <th rowspan="2">Tổng thành tiền</th>
        <th rowspan="2">Ký xác nhận</th>
      </tr>
      <tr>
        <% data.xeArray.forEach(xe => { %>
          <th>MC mượn QM</th>
          <th>Cá nhân</th>
        <% }) %>
      </tr>
    </thead>
    <tbody>
      <!-- Dòng 1: MC mượn QM -->
      <tr>
        <td class="text-left bold">MC mượn QM</td>
        <td></td>
        <% data.xeArray.forEach(xe => { %>
          <td><%= xe.kmQuangMinh > 0 ? xe.kmQuangMinh.toLocaleString() : '' %></td>
          <td></td>
        <% }) %>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
      </tr>

      <!-- Dòng 2: Tên người sử dụng cho Xe Quang Minh -->
      <tr>
        <td class="text-left bold"></td>
        <td></td>
        <% data.xeArray.forEach(xe => { %>
          <td><small><%= Array.from(xe.nguoiSD_QuangMinh).join(', ') %></small></td>
          <td></td>
        <% }) %>
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
      </tr>

      <!-- Dòng 3: Cá nhân -->
      <tr>
        <td class="text-left bold">Cá nhân</td>
        <td class="bold"><%= data.xeArray.length > 0 ? data.xeArray[0].dinhMucNL : 0 %></td>
        <% data.xeArray.forEach(xe => { %>
          <td></td>
          <td><%= xe.kmCaNhan > 0 ? xe.kmCaNhan.toLocaleString() : '' %></td>
        <% }) %>
        <td class="bold"><%= data.tongKmCaNhan.toLocaleString() %></td>
        <td class="bold"><%= data.tongTienKhauHao.toLocaleString() %></td>
        <td class="bold"><%= data.tongTienNhienLieu.toLocaleString() %></td>
        <td class="bold"><%= data.tongThanhTien.toLocaleString() %></td>
        <td class="bold"><%= data.tongEpass.toLocaleString() %></td>
        <td class="bold"><%= data.tongCuoi.toLocaleString() %></td>
        <td></td>
      </tr>

      <!-- Dòng 4: Tên người sử dụng cá nhân -->
      <tr>
        <td class="text-left bold"></td>
        <td></td>
        <% data.xeArray.forEach(xe => { %>
          <td></td>
          <td><small><%= Array.from(xe.nguoiSD_CaNhan).join(', ') %></small></td>
        <% }) %>
        <td colspan="7"></td>
      </tr>
    </tbody>
  </table>

  <div class="footer">
    <div>Ban giám đốc</div>
    <div>PT kế toán</div>
    <div>Người lập phiếu</div>
  </div>

<% } %>
</body>
</html>