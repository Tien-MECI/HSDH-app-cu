<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo lộ trình xe tháng <%= data ? data.thang : '' %>/<%= data ? data.nam : '' %></title>
  <style>
    body { font-family: "Times New Roman", serif; margin: 20px; position: relative; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; word-wrap:break-word; }
    th, td { border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle; }
    th { background-color: #e9f0fb; font-weight: bold; }
    .logo { height: 65px; }
    .title { font-weight: bold; font-size: 18px; color: #c00; }
    .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-35deg); opacity: 0.06; z-index: -1; pointer-events:none; }
    .watermark img { width: 900px; }
    .bold { font-weight: bold; }
    .text-left { text-align: left !important; padding-left: 8px; }
    .small { font-size: 11px; line-height: 1.2; text-align: left; padding-left:6px; }
    .footer { margin-top: 50px; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
    .col-vehicle { white-space: nowrap; }
    /* make two columns per vehicle (MC mượn QM / Cá nhân) */
    .vehicle-cell { width: 6%; }
  </style>
</head>
<body>

<% if (!data) { %>
  <div style="text-align:center; margin-top:100px;">
    <h2>Chọn tháng/năm để xem báo cáo lộ trình xe</h2>
    <form method="GET">
      <select name="thang" required><% for(let i=1;i<=12;i++){ %><option value="<%=i%>"><%=i%> tháng</option><% } %></select>
      <input type="number" name="nam" value="<%= new Date().getFullYear() %>" min="2020" required style="width:80px;">
      <button type="submit" style="padding:8px 20px; margin-left:10px;">Xem báo cáo</button>
    </form>
  </div>
<% } else { %>

  <% if (watermark) { %>
    <div class="watermark"><img src="<%= watermark %>" alt="watermark" /></div>
  <% } %>

  <div style="text-align:center; margin-bottom:10px;">
    <% if (logo) { %><img src="<%= logo %>" class="logo" alt="MECI"><% } %><br>
    <div class="title">CÔNG TY CỔ PHẦN CÔNG NGHIỆP MECI</div>
    <h2>BẢNG TỔNG HỢP HÀNH TRÌNH XE THÁNG <%= data.thang %>/<%= data.nam %></h2>
  </div>

  <%
    // ========= PREPARE helper data (run in EJS render time on server) =========
    // data.xeArray: array các xe với fields:
    //  tenXe, dinhMucNL, dinhMucKH, loaiNhienLieu, kmQuangMinh, kmCaNhan, nguoiSD_CaNhan (Set), tienEpass, userKmMap (optional)
    // data.donGiaTB: đơn giá nhiên liệu trung bình
    // data.userEpass: optional object mapping user->epass (server có thể gửi nếu muốn)
    // We'll build danhSachNguoi: list người dùng cá nhân (từ nguoiSD_CaNhan) + 'MECI sử dụng' nếu cần.
  %>

  <%
    // chuyển Set thành Array nếu cần
    data.xeArray.forEach(x => {
      if (x && x.nguoiSD_CaNhan && typeof x.nguoiSD_CaNhan.forEach === 'function' && !Array.isArray(x.nguoiSD_CaNhan)) {
        x._nguoiSDArr = Array.from(x.nguoiSD_CaNhan);
      } else {
        x._nguoiSDArr = x && x.nguoiSD_CaNhan ? (Array.isArray(x.nguoiSD_CaNhan) ? x.nguoiSD_CaNhan : []) : [];
      }
      // ensure userKmMap exists (optional): if server provided object or Map, normalize to plain object
      if (x.userKmMap && typeof x.userKmMap === 'object' && !(x.userKmMap instanceof Map)) {
        x._userKmMap = x.userKmMap;
      } else if (x.userKmMap instanceof Map) {
        x._userKmMap = {};
        for (let [k,v] of x.userKmMap) x._userKmMap[k]=v;
      } else {
        x._userKmMap = {};
      }
    });

    // build set of users from all xe._nguoiSDArr
    const userSet = new Set();
    data.xeArray.forEach(x => {
      x._nguoiSDArr.forEach(u => { if (u) userSet.add(u); });
    });

    // if Xe Quang Minh has kmQuangMinh > 0, add MECI sử dụng user row
    let hasQM = false;
    const xeQuangMinh = data.xeArray.find(x => (x.tenXe || '').trim().toLowerCase() === 'xe quang minh');
    if (xeQuangMinh && (parseFloat(xeQuangMinh.kmQuangMinh) || 0) > 0) {
      hasQM = true;
      userSet.add('MECI sử dụng');
    }

    const danhSachNguoi = Array.from(userSet);
    // sort danhSachNguoi to make MECI cuối cùng (optional)
    danhSachNguoi.sort((a,b) => {
      if (a === 'MECI sử dụng') return 1;
      if (b === 'MECI sử dụng') return -1;
      return a.localeCompare(b,'vi');
    });
  %>

  <table>
    <thead>
  <!-- Row 1 -->
  <tr>
    <th rowspan="4" style="width:9%;">Tên người<br/>sử dụng xe</th>

    <!-- ←←←←←←←←←← ĐOẠN MỚI Ở ĐÂY (có 4 ô kẻ viền) ←←←←←←←←←← -->
    <th style="width:6%; padding:0;">
      <table style="width:100%; height:100%; border-collapse:collapse; font-size:11px;">
        <tr>
          <td class="small bold" style="border:1px solid #000; height:28px; background:#f0f0f0;">
            Khấu hao/<br>giá nhiên liệu TB
          </td>
        </tr>
        <tr>
          <td class="small" style="border:1px solid #000; height:28px;">
            Loại xe
          </td>
        </tr>
        <tr>
          <td class="small" style="border:1px solid #000; height:28px;">
            Loại
          </td>
        </tr>
        <tr>
          <td class="small" style="border:1px solid #000; height:28px;">
            Định mức<br>(lít/100km)
          </td>
        </tr>
      </table>
    </th>
    <!-- ←←←←←←←←←← KẾT THÚC ĐOẠN MỚI ←←←←←←←←←← -->

    <% data.xeArray.forEach(function(xe){ %>
      <th colspan="2" style="background:#fff; border-bottom:none; padding:6px;">
        <div class="small">
          Giá khấu hao phương tiện: <%= Math.round(xe.dinhMucKH || 0).toLocaleString() %> đ/km<br>
          Loại nhiên liệu: <%= (xe.loaiNhienLieu || 'DO') %><br>
          Giá nhiên liệu tháng: <%= (data.donGiaTB || 0).toLocaleString() %> đ/lít
        </div>
      </th>
    <% }); %>
    <th rowspan="4" style="width:7%;">Tổng số km<br/>sử dụng<br/>cá nhân</th>
    <th rowspan="4" style="width:7%;">Tiền<br/>Khấu hao</th>
    <th rowspan="4" style="width:7%;">Tiền<br/>nhiên liệu</th>
    <th rowspan="4" style="width:7%;">Thành tiền</th>
    <th rowspan="4" style="width:7%;">Tiền<br/>Epass</th>
    <th rowspan="4" style="width:7%;">Tổng<br/>thành tiền</th>
    <th rowspan="4" style="width:7%;">Ký<br/>xác nhận</th>
  </tr>

  <!-- Row 2 – Tên xe -->
  <tr>
    <% data.xeArray.forEach(function(xe){ %>
      <th colspan="2" style="font-weight:bold; font-size:14px;"><%= xe.tenXe %></th>
    <% }); %>
  </tr>

  <!-- Row 3 – QM thuê MECI | Cá nhân   hoặc   MC thuê QM | Cá nhân -->
  <tr>
    <% data.xeArray.forEach(function(xe){ 
        const ten = (xe.tenXe || '').trim().toLowerCase();
        const isQuangMinh = ten.includes('quang minh') || ten === 'xe quang minh';
    %>
      <th class="small"><%= isQuangMinh ? 'MC thuê QM' : 'QM thuê MECI' %></th>
      <th class="small">Cá nhân</th>
    <% }); %>
  </tr>

  <!-- Row 4 – Định mức + Loại nhiên liệu -->
  <tr>
    <% data.xeArray.forEach(function(xe){ %>
      <th class="small"><%= xe.dinhMucNL || '' %></th>
      <th class="small"><%= xe.loaiNhienLieu || 'DO' %></th>
    <% }); %>
  </tr>
</thead>

    <tbody>
      <!-- Now build one row per user -->
      <% 
        // helper function (inside EJS) to get km of a user on a vehicle:
        function kmForUserOnVehicle(xe, user) {
          // 1) if user === 'MECI sử dụng' and xe has kmQuangMinh, return that for Xe Quang Minh only
          if (user === 'MECI sử dụng') {
            if ((xe.tenXe || '').trim().toLowerCase() === 'xe quang minh') {
              return Number(xe.kmQuangMinh) || 0;
            }
            return 0;
          }
          // 2) if xe._userKmMap contains mapping, use it
          if (xe._userKmMap && typeof xe._userKmMap === 'object' && xe._userKmMap[user] != null) {
            return Number(xe._userKmMap[user]) || 0;
          }
          // 3) if xe._nguoiSDArr contains exactly one user and equals this user, give all kmCaNhan to them
          if (Array.isArray(xe._nguoiSDArr) && xe._nguoiSDArr.length === 1 && xe._nguoiSDArr[0] === user) {
            return Number(xe.kmCaNhan) || 0;
          }
          // 4) if xe._nguoiSDArr contains user but we don't have per-user km, we cannot split accurately -> leave blank (0)
          if (Array.isArray(xe._nguoiSDArr) && xe._nguoiSDArr.includes(user)) {
            // no accurate split info — choose to leave 0 (so you don't overassign),
            // but you could also distribute equally: Math.round(xe.kmCaNhan / xe._nguoiSDArr.length)
            // We'll try equal split as fallback to give user visible numbers:
            if (Number(xe.kmCaNhan) && xe._nguoiSDArr.length > 0) {
              return Math.round(Number(xe.kmCaNhan) / xe._nguoiSDArr.length);
            }
            return 0;
          }
          return 0;
        }
      %>

      <% for (let i = 0; i < danhSachNguoi.length; i++) { 
           const user = danhSachNguoi[i];
           // compute per-vehicle km cells and totals per user
           let totalKmUser = 0;
           let totalKhauHao_user = 0;
           let totalNhienLieu_user = 0;
           let totalEpass_user = (data.userEpass && data.userEpass[user]) ? Number(data.userEpass[user]) : 0;
      %>
        <tr>
          <td class="text-left"><%= user %></td>
          <!-- For the global Định mức nhiên liệu column we could show blank or a representative value (left blank) -->
          <td></td>

          <% data.xeArray.forEach(function(xe){
              const km = kmForUserOnVehicle(xe, user) || 0;
              // compute money for this user on this vehicle
              const khauhao = Math.round(km * (Number(xe.dinhMucKH) || 0));
              const nhienlieu = Math.round((km * (Number(xe.dinhMucNL) || 0) / 100) * (Number(data.donGiaTB) || 0));
              // accumulate totals in EJS scope variables for current user
              totalKmUser += km;
              totalKhauHao_user += khauhao;
              totalNhienLieu_user += nhienlieu;
          %>
            <!-- MC mượn QM cell: show km only if this user is MECI sử dụng and xe is Xe Quang Minh -->
            <td class="vehicle-cell"><%= (user === 'MECI sử dụng' && (xe.tenXe || '').trim().toLowerCase() === 'xe quang minh') ? (km ? km.toLocaleString() : '') : '' %></td>
            <!-- Cá nhân cell: show km for normal users (including MECI if we consider them personal) -->
            <td class="vehicle-cell"><%= (user !== 'MECI sử dụng') ? (km ? km.toLocaleString() : '') : '' %></td>
          <% }); /* end foreach xe */ %>

          <td class="bold"><%= totalKmUser ? totalKmUser.toLocaleString() : '' %></td>
          <td class="bold"><%= totalKhauHao_user ? totalKhauHao_user.toLocaleString() : '' %></td>
          <td class="bold"><%= totalNhienLieu_user ? totalNhienLieu_user.toLocaleString() : '' %></td>
          <td class="bold"><%= (totalKhauHao_user + totalNhienLieu_user) ? (totalKhauHao_user + totalNhienLieu_user).toLocaleString() : '' %></td>
          <td class="bold"><%= totalEpass_user ? totalEpass_user.toLocaleString() : '' %></td>
          <td class="bold"><%= ( (totalKhauHao_user + totalNhienLieu_user) + totalEpass_user ) ? ( (totalKhauHao_user + totalNhienLieu_user) + totalEpass_user ).toLocaleString() : '' %></td>
          <td></td>
        </tr>
      <% } %>

      <!-- Optional final summary row (totals across all users) -->
      <%
        // compute grand totals
        let grandKm = 0, grandKh = 0, grandNl = 0, grandEpass = 0;
        // We will re-iterate users to sum (cheap)
        for (let ui=0; ui<danhSachNguoi.length; ui++) {
          const u = danhSachNguoi[ui];
          let totKm=0, totKh=0, totNl=0, totEp= (data.userEpass && data.userEpass[u]) ? Number(data.userEpass[u]) : 0;
          data.xeArray.forEach(function(xe){
            const k = kmForUserOnVehicle(xe,u) || 0;
            totKm += k;
            totKh += Math.round(k * (Number(xe.dinhMucKH) || 0));
            totNl += Math.round((k * (Number(xe.dinhMucNL) || 0) / 100) * (Number(data.donGiaTB) || 0));
          });
          grandKm += totKm; grandKh += totKh; grandNl += totNl; grandEpass += totEp;
        }
      %>
      <tr>
        <td class="text-left bold">Tổng</td>
        <td></td>
        <% data.xeArray.forEach(function(xe){ %>
          <td></td><td></td>
        <% }); %>
        <td class="bold"><%= grandKm ? grandKm.toLocaleString() : '' %></td>
        <td class="bold"><%= grandKh ? grandKh.toLocaleString() : '' %></td>
        <td class="bold"><%= grandNl ? grandNl.toLocaleString() : '' %></td>
        <td class="bold"><%= (grandKh + grandNl) ? (grandKh + grandNl).toLocaleString() : '' %></td>
        <td class="bold"><%= grandEpass ? grandEpass.toLocaleString() : '' %></td>
        <td class="bold"><%= (grandKh + grandNl + grandEpass) ? (grandKh + grandNl + grandEpass).toLocaleString() : '' %></td>
        <td></td>
      </tr>

    </tbody>
  </table>

  <div class="footer">
    <div>Ban giám đốc</div>
    <div>PT kế toán</div>
    <div>Người lập phiếu</div>
  </div>

<% } %>

</body>
</html>
