<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o KPI Ph√≤ng Kinh Doanh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .nav-tabs .nav-link.active {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
        .kpi-card {
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .kpi-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .kpi-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .kpi-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        .kpi-target {
            background-color: #e3f2fd;
        }
        .kpi-result {
            background-color: #e8f5e9;
        }
        .table-kpi {
            font-size: 0.9rem;
        }
        .table-kpi th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0"><i class="bi bi-graph-up"></i> H·ªÜ TH·ªêNG B√ÅO C√ÅO KPI PH√íNG KINH DOANH</h4>
                            <small class="text-white-50">ƒê√°nh gi√° hi·ªáu su·∫•t nh√¢n s·ª± - KPI 3 b·ªô ph·∫≠n: Kinh doanh, Marketing, K·ªπ thu·∫≠t</small>
                        </div>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                                <i class="bi bi-file-excel"></i> Xu·∫•t Excel
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="window.print()">
                                <i class="bi bi-printer"></i> In b√°o c√°o
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-section">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Lo·∫°i b√°o c√°o</label>
                            <select name="loaiBaoCao" class="form-select" onchange="changeReportType(this.value)">
                                <option value="kinhdoanh" <%= loaiBaoCao === 'kinhdoanh' ? 'selected' : '' %>>Kinh doanh</option>
                                <option value="marketing" <%= loaiBaoCao === 'marketing' ? 'selected' : '' %>>Marketing</option>
                                <option value="chamsoc" <%= loaiBaoCao === 'chamsoc' ? 'selected' : '' %>>ChƒÉm s√≥c KH</option>
                                <option value="kythuat" <%= loaiBaoCao === 'kythuat' ? 'selected' : '' %>>K·ªπ thu·∫≠t</option>
                                <option value="giaoviec" <%= loaiBaoCao === 'giaoviec' ? 'selected' : '' %>>Giao vi·ªác</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Th·ªùi gian</label>
                            <select name="filterType" class="form-select" onchange="changeTimeFilter(this.value)">
                                <option value="ngay" <%= filterType === 'ngay' ? 'selected' : '' %>>Theo ng√†y</option>
                                <option value="tuan" <%= filterType === 'tuan' ? 'selected' : '' %>>Theo tu·∫ßn</option>
                                <option value="thang" <%= filterType === 'thang' ? 'selected' : '' %>>Theo th√°ng</option>
                                <option value="quy" <%= filterType === 'quy' ? 'selected' : '' %>>Theo qu√Ω</option>
                                <option value="nam" <%= filterType === 'nam' ? 'selected' : '' %>>Theo nƒÉm</option>
                            </select>
                        </div>
                        
                        <div id="timeFilterControls" class="col-md-6">
                            <!-- Dynamic time controls will be inserted here -->
                        </div>
                        
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> L·∫•y b√°o c√°o
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-tabs" id="kpiTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link <%= loaiBaoCao === 'kinhdoanh' ? 'active' : '' %>" 
                                onclick="loadReport('kinhdoanh')">Kinh Doanh</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link <%= loaiBaoCao === 'marketing' ? 'active' : '' %>" 
                                onclick="loadReport('marketing')">Marketing</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link <%= loaiBaoCao === 'chamsoc' ? 'active' : '' %>" 
                                onclick="loadReport('chamsoc')">ChƒÉm s√≥c KH</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link <%= loaiBaoCao === 'kythuat' ? 'active' : '' %>" 
                                onclick="loadReport('kythuat')">K·ªπ thu·∫≠t</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link <%= loaiBaoCao === 'giaoviec' ? 'active' : '' %>" 
                                onclick="loadReport('giaoviec')">Giao vi·ªác</button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Report Content -->
        <div class="row">
            <div class="col-12">
                <!-- Kinh Doanh Reports -->
                <% if (loaiBaoCao === 'kinhdoanh') { %>
                    <!-- 1Ô∏è‚É£ B√°o c√°o b√°o gi√° & ƒë∆°n h√†ng theo nh√¢n vi√™n -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">1Ô∏è‚É£ B√ÅO C√ÅO B√ÅO GI√Å & ƒê∆†N H√ÄNG THEO NH√ÇN VI√äN</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover table-kpi">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>M√£ NV</th>
                                            <th>T√™n NV</th>
                                            <th>T·ªïng b√°o gi√°</th>
                                            <th>T·ªïng ƒë∆°n h√†ng</th>
                                            <th>T·ª∑ l·ªá chuy·ªÉn ƒë·ªïi (%)</th>
                                            <th>M·ª•c ti√™u</th>
                                            <th>K·∫øt qu·∫£</th>
                                            <th>Ghi ch√∫</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (baoCaoBaoGiaDonHang && baoCaoBaoGiaDonHang.length > 0) { %>
                                            <% baoCaoBaoGiaDonHang.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.maNV %></td>
                                                    <td><%= item.tenNV %></td>
                                                    <td class="text-end"><%= formatNumber(item.tongBaoGia) %></td>
                                                    <td class="text-end"><%= formatNumber(item.tongDonHang) %></td>
                                                    <td class="text-end"><%= item.tyLeChuyenDoi %>%</td>
                                                    <td><input type="text" class="form-control form-control-sm kpi-target" placeholder="Nh·∫≠p m·ª•c ti√™u"></td>
                                                    <td><input type="text" class="form-control form-control-sm kpi-result" placeholder="K·∫øt qu·∫£ th·ª±c t·∫ø"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Ghi ch√∫"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="9" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 2Ô∏è‚É£ Doanh s·ªë theo nh√¢n vi√™n -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">2Ô∏è‚É£ DOANH S·ªê THEO NH√ÇN VI√äN</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover table-kpi">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>M√£ NV</th>
                                            <th>T√™n NV</th>
                                            <th>T·ªïng th√†nh ti·ªÅn (BE)</th>
                                            <th>T·ªïng doanh s·ªë KPI (BR)</th>
                                            <th>M·ª•c ti√™u</th>
                                            <th>K·∫øt qu·∫£</th>
                                            <th>Ghi ch√∫</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (baoCaoDoanhSoNV && baoCaoDoanhSoNV.length > 0) { %>
                                            <% baoCaoDoanhSoNV.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.maNV %></td>
                                                    <td><%= item.tenNV %></td>
                                                    <td class="text-end"><%= formatNumber(item.tongThanhTien) %></td>
                                                    <td class="text-end"><%= formatNumber(item.tongDoanhSo) %></td>
                                                    <td><input type="text" class="form-control form-control-sm kpi-target" placeholder="Nh·∫≠p m·ª•c ti√™u"></td>
                                                    <td><input type="text" class="form-control form-control-sm kpi-result" placeholder="K·∫øt qu·∫£ th·ª±c t·∫ø"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Ghi ch√∫"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="8" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 3Ô∏è‚É£ ƒê∆°n h√†ng h·ªßy -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">3Ô∏è‚É£ ƒê∆†N H√ÄNG H·ª¶Y</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="kpi-card p-3">
                                        <div class="kpi-label">S·ªë l∆∞·ª£ng ƒë∆°n h·ªßy</div>
                                        <div class="kpi-value"><%= baoCaoDonHangHuy?.soLuongHuy || 0 %></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="kpi-card p-3">
                                        <div class="kpi-label">Gi√° tr·ªã h·ªßy (BR)</div>
                                        <div class="kpi-value"><%= formatNumber(baoCaoDonHangHuy?.giaTriHuy || 0) %></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="kpi-card p-3">
                                        <div class="kpi-label">T·ª∑ l·ªá ho√†n th√†nh/h·ªßy</div>
                                        <div class="kpi-value"><%= (baoCaoDonHangHuy?.tyLeHoanThanh || 0).toFixed(2) %>%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

     <!-- 4Ô∏è‚É£ Top 100 kh√°ch h√†ng doanh s·ªë cao nh·∫•t -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">4Ô∏è‚É£ TOP 100 KH√ÅCH H√ÄNG DOANH S·ªê CAO NH·∫§T</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Kh√°ch h√†ng ID</th>
                            <th>T√™n kh√°ch h√†ng</th>
                            <th>T·ªïng th√†nh ti·ªÅn (BE)</th>
                            <th>T·ªïng doanh s·ªë (BR)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (top100KH && top100KH.length > 0) { %>
                            <% top100KH.slice(0, 20).forEach((item, index) => { %>
                                <tr>
                                    <td><%= index + 1 %></td>
                                    <td><%= item.khachHangID %></td>
                                    <td><%= item.tenKH %></td>
                                    <td class="text-end"><%= formatNumber(item.tongThanhTien) %></td>
                                    <td class="text-end"><%= formatNumber(item.tongDoanhSo) %></td>
                                </tr>
                            <% }); %>
                            <% if (top100KH.length > 20) { %>
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <em>Hi·ªÉn th·ªã 20/100 kh√°ch h√†ng. Xem ƒë·∫ßy ƒë·ªß trong file Excel.</em>
                                    </td>
                                </tr>
                            <% } %>
                        <% } else { %>
                            <tr><td colspan="5" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5Ô∏è‚É£ & 6Ô∏è‚É£ Kh√°ch h√†ng c≈© v√† m·ªõi -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">5Ô∏è‚É£ KH√ÅCH H√ÄNG C≈® (‚â•2 ƒë∆°n)</h6>
                </div>
                <div class="card-body">
                    <div class="kpi-card p-3 text-center">
                        <div class="kpi-label">S·ªë l∆∞·ª£ng KH</div>
                        <div class="kpi-value"><%= doanhSoKHCu?.soLuongKH || 0 %></div>
                        <hr>
                        <div class="kpi-label">Doanh s·ªë (BR)</div>
                        <div class="kpi-value"><%= formatNumber(doanhSoKHCu?.tongDoanhSo || 0) %></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">6Ô∏è‚É£ KH√ÅCH H√ÄNG M·ªöI (1 ƒë∆°n)</h6>
                </div>
                <div class="card-body">
                    <div class="kpi-card p-3 text-center">
                        <div class="kpi-label">S·ªë l∆∞·ª£ng KH</div>
                        <div class="kpi-value"><%= doanhSoKHNew?.soLuongKH || 0 %></div>
                        <hr>
                        <div class="kpi-label">Doanh s·ªë (BR)</div>
                        <div class="kpi-value"><%= formatNumber(doanhSoKHNew?.tongDoanhSo || 0) %></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 7Ô∏è‚É£ Chuy·ªÉn ƒë·ªïi b√°o gi√° -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">7Ô∏è‚É£ CHUY·ªÇN ƒê·ªîI B√ÅO GI√Å ‚Üí ƒê∆†N H√ÄNG</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="kpi-card p-3 text-center">
                        <div class="kpi-label">S·ªë kh√°ch chuy·ªÉn ƒë·ªïi</div>
                        <div class="kpi-value"><%= chuyenDoiBaoGia?.soKhachChuyenDoi || 0 %></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi-card p-3 text-center">
                        <div class="kpi-label">T·ªïng b√°o gi√°</div>
                        <div class="kpi-value"><%= chuyenDoiBaoGia?.tongBaoGia || 0 %></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi-card p-3 text-center">
                        <div class="kpi-label">T·ª∑ l·ªá chuy·ªÉn ƒë·ªïi</div>
                        <div class="kpi-value"><%= chuyenDoiBaoGia?.tyLeChuyenDoi || 0 %>%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 8Ô∏è‚É£ ƒê∆°n h√†ng ph√™ duy·ªát -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">8Ô∏è‚É£ ƒê∆†N H√ÄNG ƒê∆Ø·ª¢C PH√ä DUY·ªÜT THEO NV</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Nh√¢n vi√™n ph√™ duy·ªát</th>
                            <th>S·ªë ƒë∆°n h√†ng</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (donHangPheDuyet && donHangPheDuyet.length > 0) { %>
                            <% donHangPheDuyet.forEach((item, index) => { %>
                                <tr>
                                    <td><%= index + 1 %></td>
                                    <td><%= item.nvPheDuyet %></td>
                                    <td class="text-end"><%= item.soDon %></td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr><td colspan="3" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 9Ô∏è‚É£-1Ô∏è‚É£1Ô∏è‚É£ C√°c b√°o c√°o kh√°c -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">9Ô∏è‚É£ KH√ÅCH H√ÄNG M·ªöI T·∫†O</h6>
                </div>
                <div class="card-body">
                    <div class="kpi-card p-3 text-center">
                        <div class="kpi-label">T·ªïng KH m·ªõi</div>
                        <div class="kpi-value"><%= khachHangMoi?.tongKhachHang || 0 %></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">üîü ƒê·∫†I L√ù M·ªöI</h6>
                </div>
                <div class="card-body">
                    <div class="kpi-card p-3 text-center">
                        <div class="kpi-label">T·ªïng ƒë·∫°i l√Ω</div>
                        <div class="kpi-value"><%= daiLyMoi?.tongDaiLy || 0 %></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">1Ô∏è‚É£1Ô∏è‚É£ KH√ÅCH H√ÄNG B√ÄN GIAO</h6>
                </div>
                <div class="card-body">
                    <div class="kpi-card p-3 text-center">
                        <div class="kpi-label">T·ªïng KH b√†n giao</div>
                        <div class="kpi-value"><%= khachHangBanGiao?.tongKhachBanGiao || 0 %></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

                <% } else if (loaiBaoCao === 'marketing') { %>
                    <!-- Marketing Reports -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">üìä B√ÅO C√ÅO MARKETING - TRUY·ªÄN TH√îNG</h5>
                        </div>
                        <div class="card-body">
                            <!-- Theo nh√¢n vi√™n -->
                            <h6>S·ªë l∆∞·ª£ng b√†i ƒëƒÉng theo nh√¢n vi√™n</h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>M√£ NV</th>
                                            <th>T√™n NV</th>
                                            <th>S·ªë l∆∞·ª£ng b√†i ƒëƒÉng</th>
                                            <th>M·ª•c ti√™u</th>
                                            <th>K·∫øt qu·∫£</th>
                                            <th>Ghi ch√∫</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (tongHopNV && tongHopNV.length > 0) { %>
                                            <% tongHopNV.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.maNV %></td>
                                                    <td><%= item.tenNV %></td>
                                                    <td class="text-end"><%= item.tongBaiDang %></td>
                                                    <td><input type="text" class="form-control form-control-sm kpi-target" placeholder="M·ª•c ti√™u"></td>
                                                    <td><input type="text" class="form-control form-control-sm kpi-result" placeholder="K·∫øt qu·∫£"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Ghi ch√∫"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="7" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Theo k√™nh -->
                            <h6>S·ªë l∆∞·ª£ng b√†i ƒëƒÉng theo k√™nh</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>K√™nh ƒëƒÉng b√†i</th>
                                            <th>S·ªë l∆∞·ª£ng b√†i</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (tongHopKenh && tongHopKenh.length > 0) { %>
                                            <% tongHopKenh.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.kenh %></td>
                                                    <td class="text-end"><%= item.soLuong %></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="3" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <% } else if (loaiBaoCao === 'chamsoc') { %>
                    <!-- ChƒÉm s√≥c KH Reports -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">üë• B√ÅO C√ÅO CHƒÇM S√ìC KH√ÅCH H√ÄNG</h5>
                        </div>
                        <div class="card-body">
                            <!-- T·ªïng h·ª£p theo NV -->
                            <h6>S·ªë l∆∞·ª£t chƒÉm s√≥c theo nh√¢n vi√™n</h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>M√£ NV</th>
                                            <th>T√™n NV</th>
                                            <th>S·ªë l∆∞·ª£t chƒÉm s√≥c</th>
                                            <th>M·ª•c ti√™u</th>
                                            <th>K·∫øt qu·∫£</th>
                                            <th>Ghi ch√∫</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (tongHopNV && tongHopNV.length > 0) { %>
                                            <% tongHopNV.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.maNV %></td>
                                                    <td><%= item.tenNV %></td>
                                                    <td class="text-end"><%= item.soLuotChamSoc %></td>
                                                    <td><input type="text" class="form-control form-control-sm kpi-target" placeholder="M·ª•c ti√™u"></td>
                                                    <td><input type="text" class="form-control form-control-sm kpi-result" placeholder="K·∫øt qu·∫£"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Ghi ch√∫"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="7" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Danh s√°ch chi ti·∫øt -->
                            <h6>Danh s√°ch chi ti·∫øt chƒÉm s√≥c</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>Kh√°ch h√†ng ID</th>
                                            <th>T√™n KH</th>
                                            <th>H√¨nh th·ª©c</th>
                                            <th>N·ªôi dung</th>
                                            <th>Ng√†y chƒÉm s√≥c</th>
                                            <th>Nh√¢n vi√™n</th>
                                            <th>K·∫øt qu·∫£</th>
                                            <th>Ng√†y h·∫πn ti·∫øp</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (danhSachChamSoc && danhSachChamSoc.length > 0) { %>
                                            <% danhSachChamSoc.forEach((item) => { %>
                                                <tr>
                                                    <td><%= item.stt %></td>
                                                    <td><%= item.khachHangID %></td>
                                                    <td><%= item.tenKH %></td>
                                                    <td><%= item.hinhThuc %></td>
                                                    <td><%= item.noiDung %></td>
                                                    <td><%= item.ngayChamSoc %></td>
                                                    <td><%= item.tenNV %></td>
                                                    <td><%= item.ketQua %></td>
                                                    <td><%= item.ngayHenTiep %></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="9" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                <% } %>

<!-- B√°o c√°o K·ªπ thu·∫≠t -->
<% if (loaiBaoCao === 'kythuat') { %>
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üîß B√ÅO C√ÅO K·ª∏ THU·∫¨T - THI·∫æT K·∫æ</h5>
        </div>
        <div class="card-body">
            <!-- T·ªïng h·ª£p -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="kpi-card p-3">
                        <div class="kpi-label">T·ªïng ƒë∆°n h√†ng</div>
                        <div class="kpi-value"><%= tongDonHang %></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card p-3">
                        <div class="kpi-label">T·ªïng l·∫ßn thi·∫øt k·∫ø</div>
                        <div class="kpi-value"><%= tongLanThietKe %></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card p-3">
                        <div class="kpi-label">TB l·∫ßn thi·∫øt k·∫ø/ƒë∆°n</div>
                        <div class="kpi-value">
                            <% 
                                const tbThietKe = tongDonHang > 0 ? (tongLanThietKe / tongDonHang).toFixed(1) : 0;
                            %>
                            <%= tbThietKe %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theo lo·∫°i b·∫£n v·∫Ω -->
            <h6>Theo lo·∫°i b·∫£n v·∫Ω</h6>
            <div class="table-responsive mb-4">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Lo·∫°i b·∫£n v·∫Ω</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>T·ª∑ l·ªá</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                            const loaiBanVeEntries = Object.entries(theoLoaiBanVe || {});
                            if (loaiBanVeEntries.length > 0) {
                                loaiBanVeEntries.forEach(([loai, soLuong], index) => {
                        %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td><%= loai %></td>
                                <td class="text-end"><%= soLuong %></td>
                                <td class="text-end">
                                    <%= ((soLuong / tongDonHang) * 100).toFixed(1) %>%
                                </td>
                            </tr>
                        <% 
                                });
                            } else {
                        %>
                            <tr><td colspan="4" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Theo nh√¢n s·ª± -->
            <h6>Theo nh√¢n s·ª± k·ªπ thu·∫≠t</h6>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Nh√¢n s·ª±</th>
                            <th>S·ªë ƒë∆°n h√†ng</th>
                            <th>S·ªë l·∫ßn thi·∫øt k·∫ø</th>
                            <th>TB l·∫ßn/ƒë∆°n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                            const nhanSuEntries = Object.entries(theoNhanSu || {});
                            if (nhanSuEntries.length > 0) {
                                nhanSuEntries.forEach(([nhanSu, data], index) => {
                        %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td><%= nhanSu %></td>
                                <td class="text-end"><%= data.soDonHang %></td>
                                <td class="text-end"><%= data.soLanThietKe %></td>
                                <td class="text-end">
                                    <%= (data.soLanThietKe / data.soDonHang).toFixed(1) %>
                                </td>
                            </tr>
                        <% 
                                });
                            } else {
                        %>
                            <tr><td colspan="5" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<% } %>

<!-- B√°o c√°o Giao vi·ªác -->
<% if (loaiBaoCao === 'giaoviec') { %>
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üìã B√ÅO C√ÅO GIAO VI·ªÜC KINH DOANH</h5>
        </div>
        <div class="card-body">
            <!-- T·ªïng h·ª£p -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="kpi-card p-3">
                        <div class="kpi-label">T·ªïng c√¥ng vi·ªác</div>
                        <div class="kpi-value"><%= tongCongViec %></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card p-3">
                        <div class="kpi-label">T·ª∑ l·ªá ti·∫øp nh·∫≠n</div>
                        <div class="kpi-value"><%= tyLeTiepNhan %>%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card p-3">
                        <div class="kpi-label">T·ª∑ l·ªá ho√†n th√†nh</div>
                        <div class="kpi-value"><%= tyLeHoanThanh %>%</div>
                    </div>
                </div>
            </div>

            <!-- Theo ng∆∞·ªùi ti·∫øp nh·∫≠n -->
            <h6>Theo ng∆∞·ªùi ti·∫øp nh·∫≠n</h6>
            <div class="table-responsive mb-4">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ng∆∞·ªùi ti·∫øp nh·∫≠n</th>
                            <th>T·ªïng c√¥ng vi·ªác</th>
                            <th>ƒê√£ ti·∫øp nh·∫≠n</th>
                            <th>ƒê√£ ho√†n th√†nh</th>
                            <th>T·ª∑ l·ªá ho√†n th√†nh</th>
                            <th>M·ª•c ti√™u</th>
                            <th>K·∫øt qu·∫£</th>
                            <th>Ghi ch√∫</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                            const nguoiTiepNhanEntries = Object.entries(theoNguoiTiepNhan || {});
                            if (nguoiTiepNhanEntries.length > 0) {
                                nguoiTiepNhanEntries.forEach(([ten, data], index) => {
                        %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td><%= ten %></td>
                                <td class="text-end"><%= data.tongCongViec %></td>
                                <td class="text-end"><%= data.daTiepNhan %></td>
                                <td class="text-end"><%= data.daHoanThanh %></td>
                                <td class="text-end">
                                    <%= ((data.daHoanThanh / data.tongCongViec) * 100).toFixed(1) %>%
                                </td>
                                <td><input type="text" class="form-control form-control-sm kpi-target" placeholder="M·ª•c ti√™u"></td>
                                <td><input type="text" class="form-control form-control-sm kpi-result" placeholder="K·∫øt qu·∫£"></td>
                                <td><input type="text" class="form-control form-control-sm" placeholder="Ghi ch√∫"></td>
                            </tr>
                        <% 
                                });
                            } else {
                        %>
                            <tr><td colspan="9" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Theo tr·∫°ng th√°i -->
            <h6>Theo tr·∫°ng th√°i</h6>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>T·ª∑ l·ªá</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                            const trangThaiEntries = Object.entries(theoTrangThai || {});
                            if (trangThaiEntries.length > 0) {
                                trangThaiEntries.forEach(([trangThai, soLuong], index) => {
                        %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td><%= trangThai %></td>
                                <td class="text-end"><%= soLuong %></td>
                                <td class="text-end">
                                    <%= ((soLuong / tongCongViec) * 100).toFixed(1) %>%
                                </td>
                            </tr>
                        <% 
                                });
                            } else {
                        %>
                            <tr><td colspan="4" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<% } %>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Kh·ªüi t·∫°o time filter controls
        function initTimeFilterControls() {
            const filterType = '<%= filterType %>';
            const controlsDiv = document.getElementById('timeFilterControls');
            
            let html = '';
            
            if (filterType === 'ngay') {
                html = `
                    <div class="col-md-2">
                        <label class="form-label">Ng√†y</label>
                        <input type="number" name="filterNgay" class="form-control" 
                               value="<%= filterNgay || '' %>" min="1" max="31">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Th√°ng</label>
                        <select name="filterThang" class="form-select">
                            <% for(let m = 1; m <= 12; m++) { %>
                                <option value="<%= m %>" <%= parseInt(filterThang) === m ? 'selected' : '' %>>
                                    Th√°ng <%= m %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">NƒÉm</label>
                        <select name="filterNam" class="form-select">
                            <% for(let y = currentYear - 2; y <= currentYear; y++) { %>
                                <option value="<%= y %>" <%= parseInt(filterNam) === y ? 'selected' : '' %>>
                                    NƒÉm <%= y %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                `;
            } else if (filterType === 'tuan') {
                html = `
                    <div class="col-md-2">
                        <label class="form-label">Tu·∫ßn</label>
                        <select name="filterTuan" class="form-select">
                            <% for(let w = 1; w <= 5; w++) { %>
                                <option value="<%= w %>" <%= parseInt(filterTuan) === w ? 'selected' : '' %>>
                                    Tu·∫ßn <%= w %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Th√°ng</label>
                        <select name="filterThang" class="form-select">
                            <% for(let m = 1; m <= 12; m++) { %>
                                <option value="<%= m %>" <%= parseInt(filterThang) === m ? 'selected' : '' %>>
                                    Th√°ng <%= m %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">NƒÉm</label>
                        <select name="filterNam" class="form-select">
                            <% for(let y = currentYear - 2; y <= currentYear; y++) { %>
                                <option value="<%= y %>" <%= parseInt(filterNam) === y ? 'selected' : '' %>>
                                    NƒÉm <%= y %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                `;
            } else if (filterType === 'thang') {
                html = `
                    <div class="col-md-2">
                        <label class="form-label">Th√°ng</label>
                        <select name="filterThang" class="form-select">
                            <% for(let m = 1; m <= 12; m++) { %>
                                <option value="<%= m %>" <%= parseInt(filterThang) === m ? 'selected' : '' %>>
                                    Th√°ng <%= m %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">NƒÉm</label>
                        <select name="filterNam" class="form-select">
                            <% for(let y = currentYear - 2; y <= currentYear; y++) { %>
                                <option value="<%= y %>" <%= parseInt(filterNam) === y ? 'selected' : '' %>>
                                    NƒÉm <%= y %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                `;
            } else if (filterType === 'quy') {
                html = `
                    <div class="col-md-2">
                        <label class="form-label">Qu√Ω</label>
                        <select name="filterQuy" class="form-select">
                            <% for(let q = 1; q <= 4; q++) { %>
                                <option value="<%= q %>" <%= parseInt(filterQuy) === q ? 'selected' : '' %>>
                                    Qu√Ω <%= q %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">NƒÉm</label>
                        <select name="filterNam" class="form-select">
                            <% for(let y = currentYear - 2; y <= currentYear; y++) { %>
                                <option value="<%= y %>" <%= parseInt(filterNam) === y ? 'selected' : '' %>>
                                    NƒÉm <%= y %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                `;
            } else if (filterType === 'nam') {
                html = `
                    <div class="col-md-2">
                        <label class="form-label">NƒÉm</label>
                        <select name="filterNam" class="form-select">
                            <% for(let y = currentYear - 2; y <= currentYear; y++) { %>
                                <option value="<%= y %>" <%= parseInt(filterNam) === y ? 'selected' : '' %>>
                                    NƒÉm <%= y %>
                                </option>
                            <% } %>
                        </select>
                    </div>
                `;
            }
            
            controlsDiv.innerHTML = html;
        }

        // Thay ƒë·ªïi lo·∫°i b√°o c√°o
        function loadReport(type) {
            const form = document.getElementById('filterForm');
            const loaiBaoCaoInput = form.querySelector('[name="loaiBaoCao"]');
            loaiBaoCaoInput.value = type;
            form.submit();
        }

        // Thay ƒë·ªïi lo·∫°i filter th·ªùi gian
        function changeTimeFilter(type) {
            const form = document.getElementById('filterForm');
            const filterTypeInput = form.querySelector('[name="filterType"]');
            filterTypeInput.value = type;
            
            // Update UI
            initTimeFilterControls();
        }

        // Xu·∫•t Excel
        function exportToExcel() {
            const form = document.getElementById('filterForm');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                params.append(key, value);
            }
            
            window.location.href = `/export/kpi-phong-kinhdoanh?${params.toString()}`;
        }

        // Kh·ªüi t·∫°o khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            initTimeFilterControls();
        });
    </script>
</body>
</html>