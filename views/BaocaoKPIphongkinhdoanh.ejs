<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo KPI Phòng Kinh Doanh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
        }
        .kpi-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .kpi-target {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 10px;
            margin-bottom: 10px;
        }
        .kpi-result {
            background-color: #e8f4fd;
            border-left: 4px solid #2ecc71;
            padding: 10px;
            margin-bottom: 10px;
        }
        .table-kpi {
            font-size: 0.9rem;
        }
        .table-kpi th {
            background-color: #2c3e50;
            color: white;
            position: sticky;
            top: 0;
        }
        .progress-kpi {
            height: 25px;
            border-radius: 5px;
        }
        .nav-tabs .nav-link {
            font-weight: 500;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0"><i class="bi bi-graph-up-arrow"></i> HỆ THỐNG BÁO CÁO KPI PHÒNG KINH DOANH</h4>
                            <small class="opacity-75">Đánh giá hiệu suất - Đo lường thành tích - Cải thiện hiệu quả</small>
                        </div>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                                <i class="bi bi-file-excel"></i> Xuất Excel
                            </button>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#danhGiaModal">
                                <i class="bi bi-clipboard-check"></i> Đánh giá
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form lọc -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-section">
                    <form id="filterForm" method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Loại báo cáo</label>
                            <select name="loaiBaoCao" class="form-select" onchange="changeReportType(this.value)">
                                <optgroup label="Kinh Doanh">
                                    <option value="1" <%= loaiBaoCao === '1' ? 'selected' : '' %>>1. Báo giá & Đơn hàng theo NV</option>
                                    <option value="2" <%= loaiBaoCao === '2' ? 'selected' : '' %>>2. Doanh số theo NV</option>
                                    <option value="3" <%= loaiBaoCao === '3' ? 'selected' : '' %>>3. Đơn hàng hủy</option>
                                    <option value="4" <%= loaiBaoCao === '4' ? 'selected' : '' %>>4. Top 100 KH doanh số</option>
                                    <option value="5" <%= loaiBaoCao === '5' ? 'selected' : '' %>>5. KH cũ</option>
                                    <option value="6" <%= loaiBaoCao === '6' ? 'selected' : '' %>>6. KH mới</option>
                                    <option value="7" <%= loaiBaoCao === '7' ? 'selected' : '' %>>7. Chuyển đổi BG → ĐH</option>
                                    <option value="8" <%= loaiBaoCao === '8' ? 'selected' : '' %>>8. Đơn hàng phê duyệt</option>
                                    <option value="9" <%= loaiBaoCao === '9' ? 'selected' : '' %>>9. KH mới được tạo</option>
                                    <option value="10" <%= loaiBaoCao === '10' ? 'selected' : '' %>>10. Đại lý mới</option>
                                    <option value="11" <%= loaiBaoCao === '11' ? 'selected' : '' %>>11. KH được bàn giao</option>
                                </optgroup>
                                <optgroup label="Marketing">
                                    <option value="12">12. Bài đăng bán hàng</option>
                                    <option value="13">13. Chiến dịch quảng cáo</option>
                                </optgroup>
                                <optgroup label="Chăm sóc KH">
                                    <option value="14">14. Chăm sóc KH</option>
                                </optgroup>
                                <optgroup label="Kỹ thuật">
                                    <option value="15">15. Bản vẽ kỹ thuật</option>
                                </optgroup>
                                <optgroup label="Công việc">
                                    <option value="16">16. Công việc được giao</option>
                                </optgroup>
                                <optgroup label="Chấm công">
                                    <option value="17">17. Ngày làm việc</option>
                                    <option value="18">18. Khảo sát công trình</option>
                                    <option value="19">19. Làm việc văn phòng</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label">Thời gian</label>
                            <select name="filterType" class="form-select" onchange="toggleTimeFields(this.value)">
                                <option value="ngay" <%= filterType === 'ngay' ? 'selected' : '' %>>Theo ngày</option>
                                <option value="tuan" <%= filterType === 'tuan' ? 'selected' : '' %>>Theo tuần</option>
                                <option value="thang" <%= filterType === 'thang' ? 'selected' : '' %>>Theo tháng</option>
                                <option value="quy" <%= filterType === 'quy' ? 'selected' : '' %>>Theo quý</option>
                                <option value="nam" <%= filterType === 'nam' ? 'selected' : '' %>>Theo năm</option>
                                <option value="khoang" <%= filterType === 'khoang' ? 'selected' : '' %>>Khoảng thời gian</option>
                            </select>
                        </div>
                        
                        <!-- Dynamic time fields -->
                        <div id="timeFields" class="col-md-6">
                            <% if (filterType === 'ngay') { %>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <input type="number" name="filterDay" class="form-control" placeholder="Ngày" 
                                               min="1" max="31" value="<%= filterDay || '' %>">
                                    </div>
                                    <div class="col-4">
                                        <select name="filterMonth" class="form-select">
                                            <% for(let m=1; m<=12; m++) { %>
                                                <option value="<%= m %>" <%= filterMonth == m ? 'selected' : '' %>>Tháng <%= m %></option>
                                            <% } %>
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select name="filterYear" class="form-select">
                                            <% for(let y=2020; y<=new Date().getFullYear(); y++) { %>
                                                <option value="<%= y %>" <%= filterYear == y ? 'selected' : '' %>>Năm <%= y %></option>
                                            <% } %>
                                        </select>
                                    </div>
                                </div>
                            <% } else if (filterType === 'tuan') { %>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="number" name="filterWeek" class="form-control" placeholder="Tuần" 
                                               min="1" max="53" value="<%= filterWeek || '' %>">
                                    </div>
                                    <div class="col-6">
                                        <select name="filterYear" class="form-select">
                                            <% for(let y=2020; y<=new Date().getFullYear(); y++) { %>
                                                <option value="<%= y %>" <%= filterYear == y ? 'selected' : '' %>>Năm <%= y %></option>
                                            <% } %>
                                        </select>
                                    </div>
                                </div>
                            <% } else if (filterType === 'thang') { %>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <select name="filterMonth" class="form-select">
                                            <% for(let m=1; m<=12; m++) { %>
                                                <option value="<%= m %>" <%= filterMonth == m ? 'selected' : '' %>>Tháng <%= m %></option>
                                            <% } %>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select name="filterYear" class="form-select">
                                            <% for(let y=2020; y<=new Date().getFullYear(); y++) { %>
                                                <option value="<%= y %>" <%= filterYear == y ? 'selected' : '' %>>Năm <%= y %></option>
                                            <% } %>
                                        </select>
                                    </div>
                                </div>
                            <% } else if (filterType === 'quy') { %>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <select name="filterQuarter" class="form-select">
                                            <option value="1" <%= filterQuarter == '1' ? 'selected' : '' %>>Quý 1</option>
                                            <option value="2" <%= filterQuarter == '2' ? 'selected' : '' %>>Quý 2</option>
                                            <option value="3" <%= filterQuarter == '3' ? 'selected' : '' %>>Quý 3</option>
                                            <option value="4" <%= filterQuarter == '4' ? 'selected' : '' %>>Quý 4</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select name="filterYear" class="form-select">
                                            <% for(let y=2020; y<=new Date().getFullYear(); y++) { %>
                                                <option value="<%= y %>" <%= filterYear == y ? 'selected' : '' %>>Năm <%= y %></option>
                                            <% } %>
                                        </select>
                                    </div>
                                </div>
                            <% } else if (filterType === 'nam') { %>
                                <div class="row g-2">
                                    <div class="col-12">
                                        <select name="filterYear" class="form-select">
                                            <% for(let y=2020; y<=new Date().getFullYear(); y++) { %>
                                                <option value="<%= y %>" <%= filterYear == y ? 'selected' : '' %>>Năm <%= y %></option>
                                            <% } %>
                                        </select>
                                    </div>
                                </div>
                            <% } else if (filterType === 'khoang') { %>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="date" name="filterStartDate" class="form-control" 
                                               value="<%= filterStartDate || '' %>">
                                    </div>
                                    <div class="col-6">
                                        <input type="date" name="filterEndDate" class="form-control" 
                                               value="<%= filterEndDate || '' %>">
                                    </div>
                                </div>
                            <% } %>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label">Nhân viên</label>
                            <select name="nhanVien" class="form-select">
                                <option value="">Tất cả nhân viên</option>
                                <% if (danhSachNV && danhSachNV.length > 0) { %>
                                    <% danhSachNV.forEach(nv => { %>
                                        <option value="<%= nv %>" <%= nhanVien === nv ? 'selected' : '' %>><%= nv %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                        
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Xem báo cáo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Kết quả báo cáo -->
        <div class="row">
            <div class="col-12">
                <% if (baoCaoData) { %>
                    <!-- Hiển thị theo loại báo cáo -->
                    <% if (loaiBaoCao === '1') { %>
                        <!-- Báo cáo 1: Báo giá & Đơn hàng -->
                        <div class="card shadow kpi-card">
                            <div class="card-header">
                                <h5 class="mb-0">BÁO CÁO BÁO GIÁ & ĐƠN HÀNG THEO NHÂN VIÊN</h5>
                            </div>
                            <div class="card-body">
                                <!-- Thông tin KPI -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="kpi-target">
                                            <h6><i class="bi bi-target"></i> Mục tiêu KPI</h6>
                                            <p><strong>Tổng số báo giá:</strong> <%= baoCaoData.kpiBaoGia.mucTieu || 0 %> <%= baoCaoData.kpiBaoGia.donViTinh || '' %></p>
                                            <p><strong>Tổng số đơn hàng:</strong> <%= baoCaoData.kpiDonHang.mucTieu || 0 %> <%= baoCaoData.kpiDonHang.donViTinh || '' %></p>
                                            <p><strong>Tỷ lệ chuyển đổi:</strong> <%= baoCaoData.kpiTyLe.mucTieu || 0 %>%</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="kpi-result">
                                            <h6><i class="bi bi-check-circle"></i> Kết quả thực tế</h6>
                                            <p><strong>Tổng số báo giá:</strong> <%= baoCaoData.tongBaoGia || 0 %></p>
                                            <p><strong>Tổng số đơn hàng:</strong> <%= baoCaoData.tongDonHang || 0 %></p>
                                            <p><strong>Tỷ lệ chuyển đổi:</strong> <%= baoCaoData.tyLeChuyenDoi.toFixed(2) %>%</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="kpi-target">
                                            <h6><i class="bi bi-clipboard-data"></i> Đánh giá</h6>
                                            <div class="mb-2">
                                                <small>% đạt mục tiêu báo giá:</small>
                                                <div class="progress progress-kpi">
                                                    <div class="progress-bar <%= (baoCaoData.tongBaoGia / (baoCaoData.kpiBaoGia.mucTieu || 1)) * 100 >= 100 ? 'bg-success' : 'bg-warning' %>" 
                                                         style="width: <%= Math.min((baoCaoData.tongBaoGia / (baoCaoData.kpiBaoGia.mucTieu || 1)) * 100, 100) %>%">
                                                        <%= ((baoCaoData.tongBaoGia / (baoCaoData.kpiBaoGia.mucTieu || 1)) * 100).toFixed(1) %>%
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <small>% đạt mục tiêu đơn hàng:</small>
                                                <div class="progress progress-kpi">
                                                    <div class="progress-bar <%= (baoCaoData.tongDonHang / (baoCaoData.kpiDonHang.mucTieu || 1)) * 100 >= 100 ? 'bg-success' : 'bg-warning' %>" 
                                                         style="width: <%= Math.min((baoCaoData.tongDonHang / (baoCaoData.kpiDonHang.mucTieu || 1)) * 100, 100) %>%">
                                                        <%= ((baoCaoData.tongDonHang / (baoCaoData.kpiDonHang.mucTieu || 1)) * 100).toFixed(1) %>%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bảng chi tiết -->
                                <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover table-kpi">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Mã đơn</th>
                                                    <th>Khách hàng</th>
                                                    <th>Nhân viên</th>
                                                    <th>Ngày tạo</th>
                                                    <th>Loại</th>
                                                    <th>Trạng thái</th>
                                                    <th>Giá trị</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% baoCaoData.danhSach.forEach(item => { %>
                                                    <tr>
                                                        <td><%= item.stt %></td>
                                                        <td><%= item.maDonHang %></td>
                                                        <td><%= item.tenKhach %></td>
                                                        <td><%= item.nhanVien %></td>
                                                        <td><%= item.ngayTao %></td>
                                                        <td><%= item.loaiDon %></td>
                                                        <td><span class="badge <%= item.trangThai === 'Hoàn thành' ? 'bg-success' : 'bg-warning' %>"><%= item.trangThai %></span></td>
                                                        <td class="text-end"><%= formatNumber(item.giaTri) %></td>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Phân trang -->
                                    <% if (totalPages > 1) { %>
                                        <nav aria-label="Page navigation" class="mt-3">
                                            <ul class="pagination justify-content-center">
                                                <% for(let p = 1; p <= totalPages; p++) { %>
                                                    <li class="page-item <%= currentPage == p ? 'active' : '' %>">
                                                        <a class="page-link" href="?loaiBaoCao=<%= loaiBaoCao %>&filterType=<%= filterType %>&page=<%= p %>"><%= p %></a>
                                                    </li>
                                                <% } %>
                                            </ul>
                                        </nav>
                                    <% } %>
                                <% } else { %>
                                    <div class="alert alert-info">
                                        Không có dữ liệu báo cáo.
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    <% } else if (loaiBaoCao === '2') { %>
                        <!-- Báo cáo 2: Doanh số theo NV -->
                        <div class="card shadow kpi-card">
                            <div class="card-header">
                                <h5 class="mb-0">BÁO CÁO DOANH SỐ THEO NHÂN VIÊN</h5>
                            </div>
                            <div class="card-body">
                                <!-- Thông tin tổng quan -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted">Tổng doanh số thực tế</h6>
                                                <h2 class="kpi-value text-primary"><%= formatNumber(baoCaoData.tongDoanhSo) %> đ</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted">Tỷ lệ đạt KPI</h6>
                                                <h2 class="kpi-value <%= baoCaoData.tyLeDatDuoc >= 100 ? 'text-success' : 'text-warning' %>">
                                                    <%= baoCaoData.tyLeDatDuoc.toFixed(1) %>%
                                                </h2>
                                                <div class="progress mt-2">
                                                    <div class="progress-bar <%= baoCaoData.tyLeDatDuoc >= 100 ? 'bg-success' : 'bg-warning' %>" 
                                                         style="width: <%= Math.min(baoCaoData.tyLeDatDuoc, 100) %>%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bảng chi tiết theo NV -->
                                <% if (baoCaoData.doanhSoTheoNV && baoCaoData.doanhSoTheoNV.length > 0) { %>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover table-kpi">
                                            <thead>
                                                <tr>
                                                    <th>Nhân viên</th>
                                                    <th>Số đơn hàng</th>
                                                    <th>Tổng doanh số</th>
                                                    <th>Doanh số trung bình/đơn</th>
                                                    <th>% đóng góp</th>
                                                    <th>Đánh giá</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% baoCaoData.doanhSoTheoNV.forEach(item => { %>
                                                    <tr>
                                                        <td><strong><%= item.nhanVien %></strong></td>
                                                        <td class="text-center"><%= item.soDonHang %></td>
                                                        <td class="text-end"><strong><%= formatNumber(item.tongDoanhSo) %> đ</strong></td>
                                                        <td class="text-end"><%= formatNumber(item.tongDoanhSo / item.soDonHang) %> đ</td>
                                                        <td class="text-center">
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar bg-info" 
                                                                     style="width: <%= (item.tongDoanhSo / baoCaoData.tongDoanhSo) * 100 %>%">
                                                                    <%= ((item.tongDoanhSo / baoCaoData.tongDoanhSo) * 100).toFixed(1) %>%
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <% const tyLeCaNhan = (item.tongDoanhSo / baoCaoData.kpiDoanhSo.mucTieu) * 100; %>
                                                            <span class="badge <%= tyLeCaNhan >= 100 ? 'bg-success' : tyLeCaNhan >= 80 ? 'bg-warning' : 'bg-danger' %>">
                                                                <%= tyLeCaNhan.toFixed(1) %>%
                                                            </span>
                                                        </td>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>
                                <% } else { %>
                                    <div class="alert alert-info">
                                        Không có dữ liệu doanh số.
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    <% } else if (loaiBaoCao === '3') { %>
                        <!-- Báo cáo 3: Đơn hàng hủy -->
                        <div class="card shadow kpi-card">
                            <div class="card-header">
                                <h5 class="mb-0">BÁO CÁO ĐƠN HÀNG HỦY</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card bg-danger text-white">
                                            <div class="card-body text-center">
                                                <h6>Tổng số đơn hủy</h6>
                                                <h2><%= baoCaoData.tongSoDonHuy %></h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-warning text-dark">
                                            <div class="card-body text-center">
                                                <h6>Giá trị hủy</h6>
                                                <h2><%= formatNumber(baoCaoData.tongGiaTriHuy) %> đ</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center">
                                                <h6>Tỷ lệ hủy</h6>
                                                <h2><%= baoCaoData.tyLeHuy.toFixed(2) %>%</h2>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bảng chi tiết -->
                                <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover table-kpi">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Mã đơn</th>
                                                    <th>Khách hàng</th>
                                                    <th>Nhân viên</th>
                                                    <th>Ngày hủy</th>
                                                    <th>Giá trị hủy</th>
                                                    <th>Lý do</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% baoCaoData.danhSach.forEach(item => { %>
                                                    <tr>
                                                        <td><%= item.stt %></td>
                                                        <td><%= item.maDonHang %></td>
                                                        <td><%= item.tenKhach %></td>
                                                        <td><%= item.nhanVien %></td>
                                                        <td><%= item.ngayHuy %></td>
                                                        <td class="text-end text-danger"><strong><%= formatNumber(item.giaTriHuy) %> đ</strong></td>
                                                        <td>
                                                            <select class="form-select form-select-sm" onchange="updateLyDoHuy(this, '<%= item.maDonHang %>')">
                                                                <option value="">Chọn lý do</option>
                                                                <option value="Khách hủy">Khách hủy</option>
                                                                <option value="Hết hàng">Hết hàng</option>
                                                                <option value="Lỗi sản xuất">Lỗi sản xuất</option>
                                                                <option value="Chậm tiến độ">Chậm tiến độ</option>
                                                                <option value="Khác">Khác</option>
                                                            </select>
                                                        </td>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Phân trang -->
                                    <% if (totalPages > 1) { %>
                                        <nav aria-label="Page navigation" class="mt-3">
                                            <ul class="pagination justify-content-center">
                                                <% for(let p = 1; p <= totalPages; p++) { %>
                                                    <li class="page-item <%= currentPage == p ? 'active' : '' %>">
                                                        <a class="page-link" href="?loaiBaoCao=<%= loaiBaoCao %>&filterType=<%= filterType %>&page=<%= p %>"><%= p %></a>
                                                    </li>
                                                <% } %>
                                            </ul>
                                        </nav>
                                    <% } %>
                                <% } else { %>
                                    <div class="alert alert-success">
                                        Không có đơn hàng nào bị hủy trong thời gian này.
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    <% } else if (loaiBaoCao === '4') { %>
                        <!-- Báo cáo 4: Top 100 KH -->
                        <div class="card shadow kpi-card">
                            <div class="card-header">
                                <h5 class="mb-0">TOP 100 KHÁCH HÀNG DOANH SỐ CAO NHẤT</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Tổng doanh số top 100: <strong><%= formatNumber(baoCaoData.tongTatCa) %> đ</strong>
                                </div>

                                <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover table-kpi">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Khách hàng ID</th>
                                                    <th>Tên khách hàng</th>
                                                    <th>Số đơn hàng</th>
                                                    <th>Tổng doanh số BE</th>
                                                    <th>Tổng doanh số BR</th>
                                                    <th>Doanh số trung bình</th>
                                                    <th>Xếp hạng</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% baoCaoData.danhSach.forEach((item, index) => { %>
                                                    <tr>
                                                        <td><%= item.stt %></td>
                                                        <td><%= item.khachHangID %></td>
                                                        <td><strong><%= item.tenKhach %></strong></td>
                                                        <td class="text-center"><span class="badge bg-primary"><%= item.soDonHang %></span></td>
                                                        <td class="text-end"><%= formatNumber(item.tongDoanhSoBE) %> đ</td>
                                                        <td class="text-end"><strong class="text-success"><%= formatNumber(item.tongDoanhSoBR) %> đ</strong></td>
                                                        <td class="text-end"><%= formatNumber(item.tongDoanhSoBR / item.soDonHang) %> đ</td>
                                                        <td class="text-center">
                                                            <% if (index < 3) { %>
                                                                <span class="badge bg-warning"><%= index + 1 %></span>
                                                            <% } else if (index < 10) { %>
                                                                <span class="badge bg-info"><%= index + 1 %></span>
                                                            <% } else { %>
                                                                <span class="badge bg-secondary"><%= index + 1 %></span>
                                                            <% } %>
                                                        </td>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Phân trang -->
                                    <% if (totalPages > 1) { %>
                                        <nav aria-label="Page navigation" class="mt-3">
                                            <ul class="pagination justify-content-center">
                                                <% for(let p = 1; p <= totalPages; p++) { %>
                                                    <li class="page-item <%= currentPage == p ? 'active' : '' %>">
                                                        <a class="page-link" href="?loaiBaoCao=<%= loaiBaoCao %>&filterType=<%= filterType %>&page=<%= p %>"><%= p %></a>
                                                    </li>
                                                <% } %>
                                            </ul>
                                        </nav>
                                    <% } %>
                                <% } else { %>
                                    <div class="alert alert-info">
                                        Không có dữ liệu khách hàng.
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    <% } else if (loaiBaoCao === '5') { %>
                        <!-- Báo cáo 5: KH cũ -->
                        <div class="card shadow kpi-card">
                            <div class="card-header">
                                <h5 class="mb-0">KHÁCH HÀNG CŨ (CÓ TỪ 2 ĐƠN HÀNG TRỞ LÊN)</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success">
                                    <i class="bi bi-people"></i> Tổng số khách hàng cũ: <strong><%= baoCaoData.tongKhachHang %></strong> | 
                                    Tổng doanh số: <strong><%= formatNumber(baoCaoData.tongTatCa) %> đ</strong>
                                </div>

                                <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover table-kpi">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Khách hàng ID</th>
                                                    <th>Tên khách hàng</th>
                                                    <th>Nhân viên bán</th>
                                                    <th>Số đơn hàng</th>
                                                    <th>Tổng doanh số</th>
                                                    <th>Lần mua gần nhất</th>
                                                    <th>Đánh giá</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% baoCaoData.danhSach.forEach(item => { %>
                                                    <tr>
                                                        <td><%= item.stt %></td>
                                                        <td><%= item.khachHangID %></td>
                                                        <td><strong><%= item.tenKhach %></strong></td>
                                                        <td><%= item.nhanVien %></td>
                                                        <td class="text-center">
                                                            <span class="badge <%= item.soDonHang >= 5 ? 'bg-success' : 'bg-info' %>">
                                                                <%= item.soDonHang %> đơn
                                                            </span>
                                                        </td>
                                                        <td class="text-end"><strong class="text-success"><%= formatNumber(item.tongDoanhSoBR) %> đ</strong></td>
                                                        <td><%= item.ngayMuaGanNhat || 'N/A' %></td>
                                                        <td>
                                                            <% const danhGia = item.tongDoanhSoBR > 100000000 ? 'VIP' : 
                                                                               item.tongDoanhSoBR > 50000000 ? 'Trung thành' : 'Thường xuyên'; %>
                                                            <span class="badge <%= danhGia === 'VIP' ? 'bg-warning' : 
                                                                                 danhGia === 'Trung thành' ? 'bg-info' : 'bg-secondary' %>">
                                                                <%= danhGia %>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Phân trang -->
                                    <% if (totalPages > 1) { %>
                                        <nav aria-label="Page navigation" class="mt-3">
                                            <ul class="pagination justify-content-center">
                                                <% for(let p = 1; p <= totalPages; p++) { %>
                                                    <li class="page-item <%= currentPage == p ? 'active' : '' %>">
                                                        <a class="page-link" href="?loaiBaoCao=<%= loaiBaoCao %>&filterType=<%= filterType %>&page=<%= p %>"><%= p %></a>
                                                    </li>
                                                <% } %>
                                            </ul>
                                        </nav>
                                    <% } %>
                                <% } else { %>
                                    <div class="alert alert-info">
                                        Không có khách hàng cũ nào trong thời gian này.
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                    <!-- Báo cáo 6: KH mới (chỉ có 1 đơn hàng) -->
<% } else if (loaiBaoCao === '6') { %>
    <div class="card shadow kpi-card">
        <div class="card-header">
            <h5 class="mb-0">KHÁCH HÀNG MỚI (CHỈ CÓ 1 ĐƠN HÀNG)</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-primary">
                <i class="bi bi-person-plus"></i> Tổng số khách hàng mới: <strong><%= baoCaoData.tongKhachHang %></strong> | 
                Tổng doanh số: <strong><%= formatNumber(baoCaoData.tongTatCa) %> đ</strong>
            </div>

            <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-kpi">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Khách hàng ID</th>
                                <th>Tên khách hàng</th>
                                <th>Nhân viên bán</th>
                                <th>Số đơn hàng</th>
                                <th>Tổng doanh số</th>
                                <th>Ngày mua đầu tiên</th>
                                <th>Đánh giá</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% baoCaoData.danhSach.forEach(item => { %>
                                <tr>
                                    <td><%= item.stt %></td>
                                    <td><%= item.khachHangID %></td>
                                    <td><strong><%= item.tenKhach %></strong></td>
                                    <td><%= item.nhanVien %></td>
                                    <td class="text-center">
                                        <span class="badge bg-info">1 đơn</span>
                                    </td>
                                    <td class="text-end"><strong class="text-success"><%= formatNumber(item.tongDoanhSoBR) %> đ</strong></td>
                                    <td><%= item.ngayMuaDauTien || 'N/A' %></td>
                                    <td>
                                        <% const danhGia = item.tongDoanhSoBR > 50000000 ? 'Tiềm năng' : 'Bình thường'; %>
                                        <span class="badge <%= danhGia === 'Tiềm năng' ? 'bg-warning' : 'bg-secondary' %>">
                                            <%= danhGia %>
                                        </span>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <% if (totalPages > 1) { %>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <% for(let p = 1; p <= totalPages; p++) { %>
                                <li class="page-item <%= currentPage == p ? 'active' : '' %>">
                                    <a class="page-link" href="?loaiBaoCao=<%= loaiBaoCao %>&filterType=<%= filterType %>&page=<%= p %>"><%= p %></a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                <% } %>
            <% } else { %>
                <div class="alert alert-info">Không có khách hàng mới nào trong thời gian này.</div>
            <% } %>
        </div>
    </div>

<!-- Báo cáo 7: Chuyển đổi từ báo giá sang đơn hàng -->
<% } else if (loaiBaoCao === '7') { %>
    <div class="card shadow kpi-card">
        <div class="card-header">
            <h5 class="mb-0">KHÁCH HÀNG CHUYỂN ĐỔI TỪ BÁO GIÁ SANG ĐƠN HÀNG</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-success">
                <i class="bi bi-arrow-right-circle"></i> Tổng số khách hàng chuyển đổi: <strong><%= baoCaoData.tongKhachHang %></strong> | 
                Tổng doanh số: <strong><%= formatNumber(baoCaoData.tongTatCa) %> đ</strong>
            </div>

            <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-kpi">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Khách hàng ID</th>
                                <th>Tên khách hàng</th>
                                <th>Loại khách</th>
                                <th>Nhân viên bán</th>
                                <th>Doanh số từ đơn hàng</th>
                                <th>Trạng thái chuyển đổi</th>
                                <th>Hiệu quả</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% baoCaoData.danhSach.forEach(item => { %>
                                <tr>
                                    <td><%= item.stt %></td>
                                    <td><%= item.khachHangID %></td>
                                    <td><strong><%= item.tenKhach %></strong></td>
                                    <td><%= item.loaiKhach %></td>
                                    <td><%= item.nhanVien %></td>
                                    <td class="text-end"><strong class="text-success"><%= formatNumber(item.doanhSoBR) %> đ</strong></td>
                                    <td>
                                        <span class="badge <%= item.coBaoGia && item.coDonHang ? 'bg-success' : 'bg-warning' %>">
                                            <%= item.coBaoGia && item.coDonHang ? 'Đã chuyển đổi' : 'Chưa chuyển đổi' %>
                                        </span>
                                    </td>
                                    <td>
                                        <% const hieuQua = item.doanhSoBR > 100000000 ? 'Cao' : item.doanhSoBR > 50000000 ? 'Trung bình' : 'Thấp'; %>
                                        <span class="badge <%= hieuQua === 'Cao' ? 'bg-warning' : hieuQua === 'Trung bình' ? 'bg-info' : 'bg-secondary' %>">
                                            <%= hieuQua %>
                                        </span>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <% if (totalPages > 1) { %>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <% for(let p = 1; p <= totalPages; p++) { %>
                                <li class="page-item <%= currentPage == p ? 'active' : '' %>">
                                    <a class="page-link" href="?loaiBaoCao=<%= loaiBaoCao %>&filterType=<%= filterType %>&page=<%= p %>"><%= p %></a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                <% } %>
            <% } else { %>
                <div class="alert alert-info">Không có khách hàng chuyển đổi nào trong thời gian này.</div>
            <% } %>
        </div>
    </div>

<!-- Báo cáo 8: Đơn hàng được phê duyệt -->
<% } else if (loaiBaoCao === '8') { %>
    <div class="card shadow kpi-card">
        <div class="card-header">
            <h5 class="mb-0">ĐƠN HÀNG ĐƯỢC PHÊ DUYỆT THEO NHÂN VIÊN PHÊ DUYỆT</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <i class="bi bi-check-circle"></i> Tổng số đơn hàng được phê duyệt: <strong><%= baoCaoData.tongSoDon %></strong> | 
                Tổng doanh số: <strong><%= formatNumber(baoCaoData.tongDoanhSo) %> đ</strong>
            </div>

            <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-kpi">
                        <thead>
                            <tr>
                                <th>Nhân viên phê duyệt</th>
                                <th>Số đơn hàng</th>
                                <th>Tổng doanh số</th>
                                <th>Doanh số trung bình/đơn</th>
                                <th>Tỷ lệ phê duyệt</th>
                                <th>Hiệu suất</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% baoCaoData.danhSach.forEach(item => { %>
                                <tr>
                                    <td><strong><%= item.nhanVien %></strong></td>
                                    <td class="text-center"><%= item.soDon %></td>
                                    <td class="text-end"><%= formatNumber(item.tongDoanhSo) %> đ</td>
                                    <td class="text-end"><%= formatNumber(item.doanhSoTrungBinh) %> đ</td>
                                    <td class="text-center">
                                        <% const tyLe = (item.soDon / baoCaoData.tongSoDon) * 100; %>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-info" style="width: <%= tyLe %>%">
                                                <%= tyLe.toFixed(1) %>%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <% const hieuSuat = item.doanhSoTrungBinh > 10000000 ? 'Cao' : item.doanhSoTrungBinh > 5000000 ? 'Trung bình' : 'Thấp'; %>
                                        <span class="badge <%= hieuSuat === 'Cao' ? 'bg-success' : hieuSuat === 'Trung bình' ? 'bg-warning' : 'bg-danger' %>">
                                            <%= hieuSuat %>
                                        </span>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <div class="alert alert-info">Không có đơn hàng nào được phê duyệt trong thời gian này.</div>
            <% } %>
        </div>
    </div>

<!-- Báo cáo 9: KH mới được tạo -->
<% } else if (loaiBaoCao === '9') { %>
    <div class="card shadow kpi-card">
        <div class="card-header">
            <h5 class="mb-0">KHÁCH HÀNG MỚI ĐƯỢC TẠO</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-primary">
                <i class="bi bi-person-plus"></i> Tổng số khách hàng mới được tạo: <strong><%= baoCaoData.tongKhachHang %></strong>
            </div>

            <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-kpi">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Khách hàng ID</th>
                                <th>Tên khách hàng</th>
                                <th>Loại khách</th>
                                <th>Nguồn khách</th>
                                <th>Nhân viên phụ trách</th>
                                <th>Người tạo</th>
                                <th>Ngày tạo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% baoCaoData.danhSach.forEach(item => { %>
                                <tr>
                                    <td><%= item.stt %></td>
                                    <td><%= item.khachHangID %></td>
                                    <td><strong><%= item.tenKhach %></strong></td>
                                    <td><%= item.loaiKhach %></td>
                                    <td><%= item.nguonKhach %></td>
                                    <td><%= item.nhanVienPT %></td>
                                    <td><%= item.nguoiTao %></td>
                                    <td><%= item.ngayTao %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <% if (totalPages > 1) { %>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <% for(let p = 1; p <= totalPages; p++) { %>
                                <li class="page-item <%= currentPage == p ? 'active' : '' %>">
                                    <a class="page-link" href="?loaiBaoCao=<%= loaiBaoCao %>&filterType=<%= filterType %>&page=<%= p %>"><%= p %></a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                <% } %>
            <% } else { %>
                <div class="alert alert-info">Không có khách hàng mới nào được tạo trong thời gian này.</div>
            <% } %>
        </div>
    </div>

<!-- Báo cáo 10: Đại lý mới -->
<% } else if (loaiBaoCao === '10') { %>
    <div class="card shadow kpi-card">
        <div class="card-header">
            <h5 class="mb-0">ĐẠI LÝ MỚI</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-success">
                <i class="bi bi-shop"></i> Tổng số đại lý mới: <strong><%= baoCaoData.tongDaiLy %></strong>
            </div>

            <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-kpi">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Khách hàng ID</th>
                                <th>Tên đại lý</th>
                                <th>Nguồn khách</th>
                                <th>Nhân viên phụ trách</th>
                                <th>Người tạo</th>
                                <th>Ngày tạo</th>
                                <th>Ngày bàn giao</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% baoCaoData.danhSach.forEach(item => { %>
                                <tr>
                                    <td><%= item.stt %></td>
                                    <td><%= item.khachHangID %></td>
                                    <td><strong><%= item.tenKhach %></strong></td>
                                    <td><%= item.nguonKhach %></td>
                                    <td><%= item.nhanVienPT %></td>
                                    <td><%= item.nguoiTao %></td>
                                    <td><%= item.ngayTao %></td>
                                    <td><%= item.ngayBanGiao %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <% if (totalPages > 1) { %>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <% for(let p = 1; p <= totalPages; p++) { %>
                                <li class="page-item <%= currentPage == p ? 'active' : '' %>">
                                    <a class="page-link" href="?loaiBaoCao=<%= loaiBaoCao %>&filterType=<%= filterType %>&page=<%= p %>"><%= p %></a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                <% } %>
            <% } else { %>
                <div class="alert alert-info">Không có đại lý mới nào trong thời gian này.</div>
            <% } %>
        </div>
    </div>

<!-- Báo cáo 11: KH được bàn giao -->
<% } else if (loaiBaoCao === '11') { %>
    <div class="card shadow kpi-card">
        <div class="card-header">
            <h5 class="mb-0">KHÁCH HÀNG ĐƯỢC BÀN GIAO</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="bi bi-arrow-left-right"></i> Tổng số khách hàng được bàn giao: <strong><%= baoCaoData.tongKhachHang %></strong>
            </div>

            <% if (baoCaoData.danhSach && baoCaoData.danhSach.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-kpi">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Khách hàng ID</th>
                                <th>Tên khách hàng</th>
                                <th>Loại khách</th>
                                <th>Nguồn khách</th>
                                <th>Nhân viên phụ trách</th>
                                <th>Người tạo</th>
                                <th>Ngày bàn giao</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% baoCaoData.danhSach.forEach(item => { %>
                                <tr>
                                    <td><%= item.stt %></td>
                                    <td><%= item.khachHangID %></td>
                                    <td><strong><%= item.tenKhach %></strong></td>
                                    <td><%= item.loaiKhach %></td>
                                    <td><%= item.nguonKhach %></td>
                                    <td><%= item.nhanVienPT %></td>
                                    <td><%= item.nguoiTao %></td>
                                    <td><%= item.ngayBanGiao %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <% if (totalPages > 1) { %>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <% for(let p = 1; p <= totalPages; p++) { %>
                                <li class="page-item <%= currentPage == p ? 'active' : '' %>">
                                    <a class="page-link" href="?loaiBaoCao=<%= loaiBaoCao %>&filterType=<%= filterType %>&page=<%= p %>"><%= p %></a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                <% } %>
            <% } else { %>
                <div class="alert alert-info">Không có khách hàng nào được bàn giao trong thời gian này.</div>
            <% } %>
        </div>
    </div>
<% } %>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Modal đánh giá -->
    <div class="modal fade" id="danhGiaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">BIÊN BẢN ĐÁNH GIÁ KPI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="danhGiaForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Ngày họp</label>
                                <input type="date" name="ngayHop" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Thành viên tham dự</label>
                                <input type="text" name="thanhVien" class="form-control" placeholder="Nhập tên thành viên" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Nội dung đánh giá</label>
                                <textarea name="noiDung" class="form-control" rows="3" placeholder="Tóm tắt nội dung cuộc họp..." required></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nguyên nhân khách quan</label>
                                <textarea name="nguyenNhan" class="form-control" rows="2" placeholder="Các yếu tố khách quan ảnh hưởng..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nguyên nhân chủ quan</label>
                                <textarea name="nguyenNhanChuQuan" class="form-control" rows="2" placeholder="Các yếu tố chủ quan ảnh hưởng..."></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Kết luận</label>
                                <textarea name="ketLuan" class="form-control" rows="2" placeholder="Kết luận của cuộc họp..." required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Công việc tiếp theo</label>
                                <textarea name="congViecTiepTheo" class="form-control" rows="3" placeholder="Các công việc cần triển khai..." required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Người chịu trách nhiệm</label>
                                <input type="text" name="nguoiChiTrach" class="form-control" placeholder="Người chịu trách nhiệm thực hiện" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hạn hoàn thành</label>
                                <input type="date" name="hanHoanThanh" class="form-control" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="luuDanhGia()">Lưu đánh giá</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
    <script>
        // Khởi tạo datepicker
        flatpickr("[type=date]", {
            locale: "vn",
            dateFormat: "d/m/Y"
        });

        // Toggle fields thời gian
        function toggleTimeFields(type) {
            const timeFields = document.getElementById('timeFields');
            let html = '';
            
            switch(type) {
                case 'ngay':
                    html = `
                        <div class="row g-2">
                            <div class="col-4">
                                <input type="number" name="filterDay" class="form-control" placeholder="Ngày" min="1" max="31" value="<%= filterDay || '' %>">
                            </div>
                            <div class="col-4">
                                <select name="filterMonth" class="form-select">
                                    ${generateMonthOptions()}
                                </select>
                            </div>
                            <div class="col-4">
                                <select name="filterYear" class="form-select">
                                    ${generateYearOptions()}
                                </select>
                            </div>
                        </div>`;
                    break;
                case 'tuan':
                    html = `
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" name="filterWeek" class="form-control" placeholder="Tuần" min="1" max="53" value="<%= filterWeek || '' %>">
                            </div>
                            <div class="col-6">
                                <select name="filterYear" class="form-select">
                                    ${generateYearOptions()}
                                </select>
                            </div>
                        </div>`;
                    break;
                case 'thang':
                    html = `
                        <div class="row g-2">
                            <div class="col-6">
                                <select name="filterMonth" class="form-select">
                                    ${generateMonthOptions()}
                                </select>
                            </div>
                            <div class="col-6">
                                <select name="filterYear" class="form-select">
                                    ${generateYearOptions()}
                                </select>
                            </div>
                        </div>`;
                    break;
                case 'quy':
                    html = `
                        <div class="row g-2">
                            <div class="col-6">
                                <select name="filterQuarter" class="form-select">
                                    <option value="1">Quý 1</option>
                                    <option value="2">Quý 2</option>
                                    <option value="3">Quý 3</option>
                                    <option value="4">Quý 4</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select name="filterYear" class="form-select">
                                    ${generateYearOptions()}
                                </select>
                            </div>
                        </div>`;
                    break;
                case 'nam':
                    html = `
                        <div class="row g-2">
                            <div class="col-12">
                                <select name="filterYear" class="form-select">
                                    ${generateYearOptions()}
                                </select>
                            </div>
                        </div>`;
                    break;
                case 'khoang':
                    html = `
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" name="filterStartDate" class="form-control" value="<%= filterStartDate || '' %>">
                            </div>
                            <div class="col-6">
                                <input type="date" name="filterEndDate" class="form-control" value="<%= filterEndDate || '' %>">
                            </div>
                        </div>`;
                    break;
            }
            
            timeFields.innerHTML = html;
            
            // Re-init flatpickr nếu có field date
            if (type === 'khoang') {
                flatpickr("[type=date]", {
                    locale: "vn",
                    dateFormat: "d/m/Y"
                });
            }
        }

        function generateMonthOptions() {
            let options = '';
            for (let m = 1; m <= 12; m++) {
                options += `<option value="${m}">Tháng ${m}</option>`;
            }
            return options;
        }

        function generateYearOptions() {
            let options = '';
            const currentYear = new Date().getFullYear();
            for (let y = 2020; y <= currentYear; y++) {
                options += `<option value="${y}">Năm ${y}</option>`;
            }
            return options;
        }

        // Xuất Excel
        function exportToExcel() {
            const form = document.getElementById('filterForm');
            const formData = new FormData(form);
            const params = new URLSearchParams(formData).toString();
            window.location.href = `/export/baocaokpi?${params}`;
        }

        // Lưu đánh giá
        async function luuDanhGia() {
            const form = document.getElementById('danhGiaForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/luu-danhgia-kpi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Đã lưu đánh giá thành công!');
                    bootstrap.Modal.getInstance(document.getElementById('danhGiaModal')).hide();
                    form.reset();
                } else {
                    alert('Lỗi khi lưu đánh giá: ' + result.message);
                }
            } catch (error) {
                alert('Lỗi kết nối: ' + error.message);
            }
        }

        // Cập nhật lý do hủy
        function updateLyDoHuy(select, maDonHang) {
            console.log(`Cập nhật lý do hủy cho đơn ${maDonHang}: ${select.value}`);
            // Gửi API cập nhật
        }

        // Thay đổi loại báo cáo
        function changeReportType(type) {
            // Có thể thêm logic để thay đổi form theo loại báo cáo
            console.log('Chọn báo cáo:', type);
        }
    </script>
</body>
</html>