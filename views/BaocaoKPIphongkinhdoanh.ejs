<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= reportTitle %> - Hệ thống KPI Phòng Kinh Doanh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #0069d9;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --blue-dark: #0056b3;
            --blue-light: #17a2b8;
            --gray-light: #6c757d;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--blue-dark) !important;
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: none;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(45deg, var(--primary-color), var(--blue-dark));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--blue-dark));
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, var(--blue-dark), var(--primary-color));
            transform: scale(1.05);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .kpi-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .kpi-good {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
        }
        
        .kpi-warning {
            background: linear-gradient(45deg, #fff3cd, #ffeaa7);
            color: #856404;
        }
        
        .kpi-danger {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
        }
        
        .stat-card-sales {
            background: linear-gradient(45deg, #007bff, #0056b3);
        }
        
        .stat-card-conversion {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }
        
        .stat-card-customer {
            background: linear-gradient(45deg, #17a2b8, #138496);
        }
        
        .stat-card-revenue {
            background: linear-gradient(45deg, #6f42c1, #5a3d8e);
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .table-hover tbody tr:hover {
            background: linear-gradient(90deg, rgba(0,123,255,0.05), rgba(0,86,179,0.05));
        }
        
        .table thead th {
            background: linear-gradient(45deg, var(--primary-color), var(--blue-dark));
            color: white;
            border: none;
            font-weight: 600;
            padding: 15px;
        }
        
        .pagination .page-item.active .page-link {
            background: linear-gradient(45deg, var(--primary-color), var(--blue-dark));
            border-color: var(--primary-color);
        }
        
        .excel-btn {
            background: linear-gradient(45deg, #1d6f42, #28a745);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .excel-btn:hover {
            background: linear-gradient(45deg, #28a745, #1d6f42);
            transform: scale(1.05);
            color: white;
        }
        
        .report-title {
            color: var(--blue-dark);
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .info-box {
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .export-section {
            position: sticky;
            top: 20px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-graph-up"></i> HỆ THỐNG KPI PHÒNG KINH DOANH
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/baocao-kpi-phong-kinh-doanh">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/bien-ban-cuoc-hop">
                            <i class="bi bi-journal-text"></i> Biên bản họp
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/export-excel-kpi" class="excel-btn">
                            <i class="bi bi-file-earmark-excel"></i> Xuất Excel
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="report-title">
                    <i class="bi bi-bar-chart-line"></i> <%= reportTitle %>
                </h1>
                <p class="text-muted">
                    <i class="bi bi-calendar"></i> Thời gian: <%= new Date().toLocaleDateString('vi-VN') %>
                </p>
            </div>
            <div class="col-md-4 text-end export-section">
                <a href="/export-excel-kpi?filterType=<%= filterType %>&startDate=<%= startDate %>&endDate=<%= endDate %>" 
                   class="btn excel-btn">
                    <i class="bi bi-file-earmark-excel"></i> Xuất Excel
                </a>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <form method="GET" action="/baocao-kpi-phong-kinh-doanh" class="row g-3">
                <input type="hidden" name="loaiBaoCao" value="<%= loaiBaoCao %>">
                
                <div class="col-md-3">
                    <label class="form-label fw-bold">Loại báo cáo</label>
                    <select name="loaiBaoCao" class="form-select" onchange="this.form.submit()">
                        <option value="tongHop" <%= loaiBaoCao === 'tongHop' ? 'selected' : '' %>>Tổng hợp KPI</option>
                        <option value="baoGiaDonHang" <%= loaiBaoCao === 'baoGiaDonHang' ? 'selected' : '' %>>Báo giá & Đơn hàng</option>
                        <option value="doanhSoTheoNV" <%= loaiBaoCao === 'doanhSoTheoNV' ? 'selected' : '' %>>Doanh số theo NV</option>
                        <option value="donHangHuy" <%= loaiBaoCao === 'donHangHuy' ? 'selected' : '' %>>Đơn hàng hủy</option>
                        <option value="topKhachHang" <%= loaiBaoCao === 'topKhachHang' ? 'selected' : '' %>>Top khách hàng</option>
                        <option value="khachHangCu" <%= loaiBaoCao === 'khachHangCu' ? 'selected' : '' %>>Khách hàng cũ</option>
                        <option value="khachHangMoi" <%= loaiBaoCao === 'khachHangMoi' ? 'selected' : '' %>>Khách hàng mới</option>
                        <option value="khachChuyenDoi" <%= loaiBaoCao === 'khachChuyenDoi' ? 'selected' : '' %>>Khách chuyển đổi</option>
                        <option value="donHangPheDuyet" <%= loaiBaoCao === 'donHangPheDuyet' ? 'selected' : '' %>>Đơn hàng phê duyệt</option>
                        <option value="khachHangMoiTao" <%= loaiBaoCao === 'khachHangMoiTao' ? 'selected' : '' %>>Khách hàng mới tạo</option>
                        <option value="khachHangDaiLyMoi" <%= loaiBaoCao === 'khachHangDaiLyMoi' ? 'selected' : '' %>>Khách đại lý mới</option>
                        <option value="khachHangBanGiao" <%= loaiBaoCao === 'khachHangBanGiao' ? 'selected' : '' %>>Khách hàng bàn giao</option>
                        <option value="hoaHongKD" <%= loaiBaoCao === 'hoaHongKD' ? 'selected' : '' %>>Hoa hồng KD</option>
                        <option value="hoaHongQC" <%= loaiBaoCao === 'hoaHongQC' ? 'selected' : '' %>>Hoa hồng QC</option>
                        <option value="baiDangBanHang" <%= loaiBaoCao === 'baiDangBanHang' ? 'selected' : '' %>>Bài đăng bán hàng</option>
                        <option value="ketQuaChienDich" <%= loaiBaoCao === 'ketQuaChienDich' ? 'selected' : '' %>>Kết quả chiến dịch</option>
                        <option value="chamSocKH" <%= loaiBaoCao === 'chamSocKH' ? 'selected' : '' %>>Chăm sóc KH</option>
                        <option value="baoCaoKyThuat" <%= loaiBaoCao === 'baoCaoKyThuat' ? 'selected' : '' %>>Kỹ thuật - Thiết kế</option>
                        <option value="thucHienCV" <%= loaiBaoCao === 'thucHienCV' ? 'selected' : '' %>>Thực hiện công việc</option>
                        <option value="chamCong" <%= loaiBaoCao === 'chamCong' ? 'selected' : '' %>>Chấm công</option>
                        <option value="khaoSat" <%= loaiBaoCao === 'khaoSat' ? 'selected' : '' %>>Khảo sát công trình</option>
                        <option value="vanPhong" <%= loaiBaoCao === 'vanPhong' ? 'selected' : '' %>>Làm việc văn phòng</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label fw-bold">Thời gian</label>
                    <select name="filterType" class="form-select" onchange="toggleDateInputs(this.value)">
                        <option value="day" <%= filterType === 'day' ? 'selected' : '' %>>Theo ngày</option>
                        <option value="week" <%= filterType === 'week' ? 'selected' : '' %>>Theo tuần</option>
                        <option value="month" <%= filterType === 'month' ? 'selected' : '' %>>Theo tháng</option>
                        <option value="quarter" <%= filterType === 'quarter' ? 'selected' : '' %>>Theo quý</option>
                        <option value="year" <%= filterType === 'year' ? 'selected' : '' %>>Theo năm</option>
                        <option value="range" <%= filterType === 'range' ? 'selected' : '' %>>Khoảng thời gian</option>
                    </select>
                </div>
                
<div class="col-md-3" id="startDateDiv">
    <label class="form-label fw-bold" id="startDateLabel">
        <%= filterType === 'range' ? 'Từ ngày' : 
           filterType === 'day' ? 'Ngày' : 
           filterType === 'week' ? 'Tuần bắt đầu' :
           filterType === 'month' ? 'Tháng' :
           filterType === 'quarter' ? 'Quý' : 'Năm' %>
    </label>
    <% if (['month', 'quarter', 'year'].includes(filterType)) { %>
        <input type="month" name="startDate" class="form-control" 
               value="<%= startDate ? new Date(startDate).toISOString().slice(0,7) : '' %>">
    <% } else { %>
        <input type="date" name="startDate" class="form-control" 
               value="<%= startDate ? new Date(startDate).toISOString().split('T')[0] : '' %>">
    <% } %>
</div>

<div class="col-md-3" id="endDateDiv" style="<%= filterType === 'range' ? '' : 'display:none;' %>">
    <label class="form-label fw-bold">Đến ngày</label>
    <input type="date" name="endDate" class="form-control" 
           value="<%= endDate ? new Date(endDate).toISOString().split('T')[0] : '' %>">
</div>
                
                <div class="col-md-3">
                    <label class="form-label fw-bold">Nhân viên</label>
                    <select name="nhanVien" class="form-select">
                        <option value="all">Tất cả nhân viên</option>
                        <% nhanVienList && nhanVienList.forEach(function(nv) { %>
                            <option value="<%= nv %>" <%= nhanVien === nv ? 'selected' : '' %>>
                                <%= nv %>
                            </option>
                        <% }); %>
                    </select>
                </div>
                
                <div class="col-md-12 mt-3">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="bi bi-funnel"></i> Lọc dữ liệu
                    </button>
                    <button type="button" class="btn btn-warning" onclick="resetFilters()">
                        <i class="bi bi-arrow-clockwise"></i> Đặt lại
                    </button>
                </div>
            </form>
        </div>

        <!-- Statistics Cards -->
        <% if (loaiBaoCao === 'tongHop') { %>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card stat-card-sales">
                    <i class="bi bi-currency-dollar fs-1 mb-2"></i>
                    <h3><%= formatNumber(Object.values(data.baoGiaDonHang || {}).reduce((sum, item) => sum + (item.tongDoanhSo || 0), 0)) %></h3>
                    <p class="mb-0">Tổng doanh số</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card stat-card-conversion">
                    <i class="bi bi-percent fs-1 mb-2"></i>
                    <h3>
                        <% 
                            const totalBaoGia = Object.values(data.baoGiaDonHang || {}).reduce((sum, item) => sum + (item.tongBaoGia || 0), 0);
                            const totalDonHang = Object.values(data.baoGiaDonHang || {}).reduce((sum, item) => sum + (item.tongDonHang || 0), 0);
                            const avgConversion = totalBaoGia > 0 ? ((totalDonHang / totalBaoGia) * 100).toFixed(1) : 0;
                        %>
                        <%= avgConversion %>%
                    </h3>
                    <p class="mb-0">Tỷ lệ chuyển đổi</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card stat-card-customer">
                    <i class="bi bi-people fs-1 mb-2"></i>
                    <h3><%= data.topKhachHang ? data.topKhachHang.length : 0 %></h3>
                    <p class="mb-0">Khách hàng tiềm năng</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card stat-card-revenue">
                    <i class="bi bi-cash-stack fs-1 mb-2"></i>
                    <h3>
                        <% 
                            const totalRevenue = (data.doanhSoTheoNV || []).reduce((sum, item) => sum + (item.doanhSoThucTe || 0), 0);
                        %>
                        <%= formatNumber(totalRevenue) %>
                    </h3>
                    <p class="mb-0">Doanh số thực tế</p>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Report Content -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table"></i> <%= reportTitle %>
                </h5>
                <span class="kpi-badge kpi-good">
                    <i class="bi bi-calendar-check"></i> 
                    <%= filterType === 'day' ? 'Theo ngày' :
                       filterType === 'week' ? 'Theo tuần' :
                       filterType === 'month' ? 'Theo tháng' :
                       filterType === 'quarter' ? 'Theo quý' :
                       filterType === 'year' ? 'Theo năm' : 'Khoảng thời gian' %>
                </span>
            </div>
            <div class="card-body">
                <!-- Báo cáo tổng hợp -->
                <% if (loaiBaoCao === 'tongHop') { %>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary mb-3">
                                <i class="bi bi-person-check"></i> Báo cáo báo giá & đơn hàng
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nhân viên</th>
                                            <th>Tổng báo giá</th>
                                            <th>Tổng đơn hàng</th>
                                            <th>Tỷ lệ chuyển đổi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% for (const [nv, item] of Object.entries(data.baoGiaDonHang || {})) { %>
                                        <tr>
                                            <td><strong><%= nv %></strong></td>
                                            <td><span class="badge bg-info"><%= item.tongBaoGia || 0 %></span></td>
                                            <td><span class="badge bg-success"><%= item.tongDonHang || 0 %></span></td>
                                            <td>
                                                <span class="<%= (item.tyLeChuyenDoi || 0) >= 30 ? 'kpi-badge kpi-good' : 
                                                               (item.tyLeChuyenDoi || 0) >= 15 ? 'kpi-badge kpi-warning' : 
                                                               'kpi-badge kpi-danger' %>">
                                                    <%= (item.tyLeChuyenDoi || 0).toFixed(1) %>%
                                                </span>
                                            </td>
                                        </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary mb-3">
                                <i class="bi bi-graph-up"></i> Doanh số theo nhân viên
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nhân viên</th>
                                            <th>Doanh số thực tế</th>
                                            <th>KPI mục tiêu</th>
                                            <th>Tỷ lệ hoàn thành</th>
                                            <th>Đánh giá</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% (data.doanhSoTheoNV || []).forEach(function(item) { %>
                                        <tr>
                                            <td><strong><%= item.tenNhanVien %></strong></td>
                                            <td><span class="fw-bold text-success"><%= formatNumber(item.doanhSoThucTe) %></span></td>
                                            <td><%= formatNumber(item.kpiMucTieu) %></td>
                                            <td>
                                                <span class="<%= item.tyLeHoanThanh >= 100 ? 'kpi-badge kpi-good' : 
                                                               item.tyLeHoanThanh >= 70 ? 'kpi-badge kpi-warning' : 
                                                               'kpi-badge kpi-danger' %>">
                                                    <%= item.tyLeHoanThanh.toFixed(1) %>%
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge <%= item.danhGia === 'Đạt' ? 'bg-success' : 
                                                                     item.danhGia === 'Chưa đạt' ? 'bg-danger' : 
                                                                     'bg-secondary' %>">
                                                    <%= item.danhGia %>
                                                </span>
                                            </td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h6 class="fw-bold text-primary mb-3">
                                <i class="bi bi-trophy"></i> Top 10 khách hàng doanh số cao nhất
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Khách hàng ID</th>
                                            <th>Tên khách hàng</th>
                                            <th>Số đơn hàng</th>
                                            <th>Tổng doanh số</th>
                                            <th>Tổng thành tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% (data.topKhachHang || []).slice(0, 10).forEach(function(item, index) { %>
                                        <tr>
                                            <td><%= index + 1 %></td>
                                            <td><code><%= item.khachHangID %></code></td>
                                            <td><strong><%= item.tenKhach %></strong></td>
                                            <td><span class="badge bg-info"><%= item.soDonHang %></span></td>
                                            <td><span class="fw-bold text-success"><%= formatNumber(item.tongDoanhSo) %></span></td>
                                            <td><%= formatNumber(item.tongThanhTien) %></td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h6 class="fw-bold text-primary mb-3">
                                <i class="bi bi-x-circle"></i> Đơn hàng hủy gần đây
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Ngày tạo</th>
                                            <th>Nhân viên</th>
                                            <th>Mã đơn</th>
                                            <th>Tên khách</th>
                                            <th>Thành tiền</th>
                                            <th>Doanh số KPI</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% (data.donHangHuy?.data || []).forEach(function(item) { %>
                                        <tr class="table-danger">
                                            <td><%= formatDate(item.ngayTao) %></td>
                                            <td><strong><%= item.tenNhanVien %></strong></td>
                                            <td><code><%= item.maDon %></code></td>
                                            <td><%= item.tenKhach %></td>
                                            <td><span class="text-danger"><%= formatNumber(item.thanhTien) %></span></td>
                                            <td><span class="text-danger"><%= formatNumber(item.doanhSoKPI) %></span></td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            <% if (data.donHangHuy?.totalPages > 1) { %>
                            <nav class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <% for (let i = 1; i <= data.donHangHuy.totalPages; i++) { %>
                                    <li class="page-item <%= data.donHangHuy.currentPage === i ? 'active' : '' %>">
                                        <a class="page-link" href="?loaiBaoCao=donHangHuy&filterType=<%= filterType %>&startDate=<%= startDate %>&endDate=<%= endDate %>&page=<%= i %>">
                                            <%= i %>
                                        </a>
                                    </li>
                                    <% } %>
                                </ul>
                            </nav>
                            <% } %>
                        </div>
                    </div>
                <% } else if (loaiBaoCao === 'baoGiaDonHang') { %>
                    <!-- Báo cáo báo giá & đơn hàng -->
                    <div class="info-box">
                        <i class="bi bi-info-circle"></i> 
                        Báo cáo thể hiện số lượng báo giá và đơn hàng của từng nhân viên, cùng tỷ lệ chuyển đổi.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nhân viên</th>
                                    <th>Tổng báo giá</th>
                                    <th>Tổng đơn hàng</th>
                                    <th>Tổng doanh số</th>
                                    <th>Tỷ lệ chuyển đổi</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for (const [nv, item] of Object.entries(data)) { %>
                                <tr>
                                    <td><strong><%= nv %></strong></td>
                                    <td><span class="badge bg-info"><%= item.tongBaoGia || 0 %></span></td>
                                    <td><span class="badge bg-success"><%= item.tongDonHang || 0 %></span></td>
                                    <td><span class="fw-bold text-success"><%= formatNumber(item.tongDoanhSo) %></span></td>
                                    <td>
                                        <span class="<%= (item.tyLeChuyenDoi || 0) >= 30 ? 'kpi-badge kpi-good' : 
                                                       (item.tyLeChuyenDoi || 0) >= 15 ? 'kpi-badge kpi-warning' : 
                                                       'kpi-badge kpi-danger' %>">
                                            <%= (item.tyLeChuyenDoi || 0).toFixed(1) %>%
                                        </span>
                                    </td>
                                    <td>
                                        <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                    </td>
                                </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                <% } else if (loaiBaoCao === 'doanhSoTheoNV') { %>
                    <!-- Doanh số theo nhân viên -->
                    <div class="info-box">
                        <i class="bi bi-info-circle"></i> 
                        Báo cáo thể hiện doanh số thực tế so với KPI mục tiêu của từng nhân viên.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nhân viên</th>
                                    <th>Doanh số thực tế</th>
                                    <th>KPI mục tiêu</th>
                                    <th>Tỷ lệ hoàn thành</th>
                                    <th>Đánh giá</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.forEach(function(item) { %>
                                <tr>
                                    <td><strong><%= item.tenNhanVien %></strong></td>
                                    <td><span class="fw-bold text-success"><%= formatNumber(item.doanhSoThucTe) %></span></td>
                                    <td><%= formatNumber(item.kpiMucTieu) %></td>
                                    <td>
                                        <span class="<%= item.tyLeHoanThanh >= 100 ? 'kpi-badge kpi-good' : 
                                                       item.tyLeHoanThanh >= 70 ? 'kpi-badge kpi-warning' : 
                                                       'kpi-badge kpi-danger' %>">
                                            <%= item.tyLeHoanThanh.toFixed(1) %>%
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge <%= item.danhGia === 'Đạt' ? 'bg-success' : 
                                                             item.danhGia === 'Chưa đạt' ? 'bg-danger' : 
                                                             'bg-secondary' %>">
                                            <%= item.danhGia %>
                                        </span>
                                    </td>
                                    <td>
                                        <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else if (loaiBaoCao === 'donHangHuy') { %>
                    <!-- Đơn hàng hủy -->
                    <div class="info-box">
                        <i class="bi bi-info-circle"></i> 
                        Danh sách đơn hàng bị hủy, hiển thị thông tin khách hàng và nhân viên bán hàng.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Ngày tạo</th>
                                    <th>Nhân viên</th>
                                    <th>Mã đơn</th>
                                    <th>Tên khách</th>
                                    <th>Thành tiền</th>
                                    <th>Doanh số KPI</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.data.forEach(function(item) { %>
                                <tr class="table-danger">
                                    <td><%= formatDate(item.ngayTao) %></td>
                                    <td><strong><%= item.tenNhanVien %></strong></td>
                                    <td><code><%= item.maDon %></code></td>
                                    <td><%= item.tenKhach %></td>
                                    <td><span class="text-danger"><%= formatNumber(item.thanhTien) %></span></td>
                                    <td><span class="text-danger"><%= formatNumber(item.doanhSoKPI) %></span></td>
                                    <td>
                                        <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    <% if (data.totalPages > 1) { %>
                    <nav class="mt-3">
                        <ul class="pagination justify-content-center">
                            <% for (let i = 1; i <= data.totalPages; i++) { %>
                            <li class="page-item <%= data.currentPage === i ? 'active' : '' %>">
                                <a class="page-link" href="?loaiBaoCao=donHangHuy&filterType=<%= filterType %>&startDate=<%= startDate %>&endDate=<%= endDate %>&page=<%= i %>">
                                    <%= i %>
                                </a>
                            </li>
                            <% } %>
                        </ul>
                    </nav>
                    <% } %>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Tổng cộng:</strong> <%= data.total %> đơn hàng bị hủy
                        <% 
                            const totalRevenueLost = data.data.reduce((sum, item) => sum + (item.doanhSoKPI || 0), 0);
                        %>
                        <br>Tổng doanh số bị mất: <span class="text-danger fw-bold"><%= formatNumber(totalRevenueLost) %></span>
                    </div>
                <% } else if (loaiBaoCao === 'topKhachHang') { %>
                    <!-- Top khách hàng -->
                    <div class="info-box">
                        <i class="bi bi-info-circle"></i> 
                        Top 100 khách hàng có doanh số cao nhất, sắp xếp từ cao xuống thấp.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Khách hàng ID</th>
                                    <th>Tên khách hàng</th>
                                    <th>Số đơn hàng</th>
                                    <th>Tổng doanh số</th>
                                    <th>Tổng thành tiền</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.forEach(function(item, index) { %>
                                <tr>
                                    <td><%= index + 1 %></td>
                                    <td><code><%= item.khachHangID %></code></td>
                                    <td><strong><%= item.tenKhach %></strong></td>
                                    <td><span class="badge bg-info"><%= item.soDonHang %></span></td>
                                    <td><span class="fw-bold text-success"><%= formatNumber(item.tongDoanhSo) %></span></td>
                                    <td><%= formatNumber(item.tongThanhTien) %></td>
                                    <td>
                                        <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else if (loaiBaoCao === 'ketQuaChienDich') { %>
                    <!-- Kết quả chiến dịch quảng cáo -->
                    <div class="info-box">
                        <i class="bi bi-info-circle"></i> 
                        Báo cáo phân tích hiệu quả chiến dịch quảng cáo, so sánh chi phí dự kiến và thực tế.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Mã chiến dịch</th>
                                    <th>Tên chiến dịch</th>
                                    <th>Kênh chạy</th>
                                    <th>Chi phí dự kiến</th>
                                    <th>Chi phí thực tế</th>
                                    <th>Số LEAD</th>
                                    <th>Tỷ lệ tiêu thu</th>
                                    <th>CP trung bình/LEAD</th>
                                    <th>Đánh giá</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.forEach(function(item) { %>
                                <tr>
                                    <td><code><%= item.maChienDich %></code></td>
                                    <td><strong><%= item.tenChienDich %></strong></td>
                                    <td><span class="badge bg-secondary"><%= item.kenhChay %></span></td>
                                    <td><%= formatNumber(item.chiPhiDuKien) %></td>
                                    <td>
                                        <span class="<%= item.chiPhiThucTe > item.chiPhiDuKien ? 'text-danger' : 'text-success' %>">
                                            <%= formatNumber(item.chiPhiThucTe) %>
                                        </span>
                                    </td>
                                    <td><span class="badge bg-info"><%= item.soLead %></span></td>
                                    <td>
                                        <span class="<%= item.tyLeTieuThu > 100 ? 'kpi-badge kpi-danger' : 
                                                       item.tyLeTieuThu >= 80 ? 'kpi-badge kpi-good' : 
                                                       item.tyLeTieuThu >= 50 ? 'kpi-badge kpi-warning' : 
                                                       'kpi-badge kpi-danger' %>">
                                            <%= item.tyLeTieuThu.toFixed(1) %>%
                                        </span>
                                    </td>
                                    <td><%= formatNumber(item.chiPhiTrungBinhLead) %></td>
                                    <td>
                                        <span class="badge <%= item.danhGia === 'Vượt ngân sách' ? 'bg-danger' : 
                                                             item.danhGia === 'Đạt mục tiêu' ? 'bg-success' : 
                                                             item.danhGia === 'Cần cải thiện' ? 'bg-warning' : 
                                                             'bg-secondary' %>">
                                            <%= item.danhGia %>
                                        </span>
                                    </td>
                                    <td>
                                        <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else if (loaiBaoCao === 'baoCaoKyThuat') { %>
                    <!-- Báo cáo Kỹ thuật - Thiết kế -->
                    <div class="info-box">
                        <i class="bi bi-info-circle"></i> 
                        Báo cáo thể hiện hiệu suất của bộ phận kỹ thuật - thiết kế, thời gian tiếp nhận và hoàn thành bản vẽ.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Mã đơn hàng</th>
                                    <th>Số lần thiết kế</th>
                                    <th>Loại bản vẽ</th>
                                    <th>Nhân sự kỹ thuật</th>
                                    <th>Thời gian tiếp nhận (phút)</th>
                                    <th>Thời gian thực hiện (ngày)</th>
                                    <th>Đánh giá tiếp nhận</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.forEach(function(item) { %>
                                <tr>
                                    <td><code><%= item.maDonHang %></code></td>
                                    <td><span class="badge bg-info"><%= item.soLanThietKe %></span></td>
                                    <td><%= item.loaiBanVe %></td>
                                    <td><strong><%= item.nhanSuKyThuat %></strong></td>
                                    <td>
                                        <% if (item.thoiGianTiepNhanPhut !== null) { %>
                                            <span class="<%= item.thoiGianTiepNhanPhut <= 30 ? 'text-success' : 'text-danger' %>">
                                                <%= item.thoiGianTiepNhanPhut %> phút
                                            </span>
                                        <% } else { %>
                                            <span class="text-muted">Không xác định</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (item.thoiGianThucHienNgay !== null) { %>
                                            <span class="<%= item.thoiGianThucHienNgay <= 3 ? 'text-success' : 
                                                           item.thoiGianThucHienNgay <= 7 ? 'text-warning' : 
                                                           'text-danger' %>">
                                                <%= item.thoiGianThucHienNgay %> ngày
                                            </span>
                                        <% } else { %>
                                            <span class="text-muted">Đang thực hiện</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <span class="badge <%= item.danhGiaTiepNhan === 'Đạt' ? 'bg-success' : 
                                                             item.danhGiaTiepNhan === 'Chậm trễ' ? 'bg-danger' : 
                                                             'bg-secondary' %>">
                                            <%= item.danhGiaTiepNhan %>
                                        </span>
                                    </td>
                                    <td>
                                        <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else if (loaiBaoCao === 'chamCong') { %>
                    <!-- Báo cáo chấm công -->
                    <div class="info-box">
                        <i class="bi bi-info-circle"></i> 
                        Báo cáo số ngày làm việc đã được duyệt và chưa được duyệt theo từng nhân sự.
                    </div>
                    
                    <h6 class="fw-bold text-success mt-4">
                        <i class="bi bi-check-circle"></i> Đã duyệt
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nhân sự</th>
                                    <th>Bộ phận</th>
                                    <th>Số ngày đã duyệt</th>
                                    <th>Số ngày chưa duyệt</th>
                                    <th>Tổng số ngày</th>
                                    <th>Tỷ lệ duyệt</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.daDuyet.forEach(function(item) { %>
                                <tr class="table-success">
                                    <td><strong><%= item.tenNhanSu %></strong></td>
                                    <td><%= item.boPhan %></td>
                                    <td><span class="badge bg-success"><%= item.soNgayDaDuyet %></span></td>
                                    <td><span class="badge bg-secondary"><%= item.soNgayChuaDuyet %></span></td>
                                    <td><%= item.tongSoNgay %></td>
                                    <td>
                                        <span class="kpi-badge kpi-good">
                                            <%= ((item.soNgayDaDuyet / item.tongSoNgay) * 100).toFixed(1) %>%
                                        </span>
                                    </td>
                                    <td>
                                        <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    
                    <h6 class="fw-bold text-danger mt-4">
                        <i class="bi bi-x-circle"></i> Chưa duyệt
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nhân sự</th>
                                    <th>Bộ phận</th>
                                    <th>Số ngày đã duyệt</th>
                                    <th>Số ngày chưa duyệt</th>
                                    <th>Tổng số ngày</th>
                                    <th>Tỷ lệ duyệt</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.chuaDuyet.forEach(function(item) { %>
                                <tr class="table-danger">
                                    <td><strong><%= item.tenNhanSu %></strong></td>
                                    <td><%= item.boPhan %></td>
                                    <td><span class="badge bg-success"><%= item.soNgayDaDuyet %></span></td>
                                    <td><span class="badge bg-danger"><%= item.soNgayChuaDuyet %></span></td>
                                    <td><%= item.tongSoNgay %></td>
                                    <td>
                                        <span class="kpi-badge kpi-danger">
                                            <%= ((item.soNgayDaDuyet / item.tongSoNgay) * 100).toFixed(1) %>%
                                        </span>
                                    </td>
                                    <td>
                                        <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <!-- Các báo cáo khác -->
                    <div class="info-box">
                        <i class="bi bi-info-circle"></i> 
                        Báo cáo dạng bảng với đầy đủ thông tin và cột ghi chú cho quản lý.
                    </div>
                    <div class="table-responsive">
                        <% if (Array.isArray(data)) { %>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <% if (data.length > 0) { 
                                        const sample = data[0];
                                        Object.keys(sample).forEach(function(key) { %>
                                            <% if (key !== 'danhSachCongTrinh' && key !== 'danhSachCongViec') { %>
                                            <th><%= key.replace(/([A-Z])/g, ' $1').replace(/^./, function(str){ return str.toUpperCase(); }) %></th>
                                            <% } %>
                                        <% }); %>
                                    <% } %>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.forEach(function(item) { %>
                                <tr>
                                    <% Object.keys(item).forEach(function(key) { 
                                        if (key !== 'danhSachCongTrinh' && key !== 'danhSachCongViec') {
                                            const value = item[key];
                                            let displayValue = value;
                                            
                                            if (typeof value === 'number') {
                                                if (key.toLowerCase().includes('tyle') || key.toLowerCase().includes('percent')) {
                                                    displayValue = value.toFixed(1) + '%';
                                                } else if (key.toLowerCase().includes('doanhso') || key.toLowerCase().includes('tien')) {
                                                    displayValue = formatNumber(value);
                                                } else {
                                                    displayValue = formatNumber(value);
                                                }
                                            }
                                    %>
                                    <td><%= displayValue %></td>
                                    <% } }); %>
                                    <td>
                                        <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                        <% } else if (typeof data === 'object') { %>
                        <p class="text-muted">Dữ liệu được nhóm theo từng nhân viên/phòng ban.</p>
                        <% for (const [key, value] of Object.entries(data)) { %>
                        <h6 class="mt-3 mb-2 fw-bold text-primary"><%= key %></h6>
                        <div class="table-responsive mb-4">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <% if (Array.isArray(value) && value.length > 0) {
                                            const sample = value[0];
                                            Object.keys(sample).forEach(function(col) { %>
                                            <th><%= col %></th>
                                            <% }); %>
                                        <% } %>
                                        <th>Ghi chú</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (Array.isArray(value)) {
                                        value.forEach(function(item) { %>
                                    <tr>
                                        <% Object.values(item).forEach(function(val) { %>
                                        <td><%= val %></td>
                                        <% }); %>
                                        <td>
                                            <textarea class="form-control form-control-sm" rows="1" placeholder="Nhập ghi chú..."></textarea>
                                        </td>
                                    </tr>
                                    <% }); } %>
                                </tbody>
                            </table>
                        </div>
                        <% } %>
                        <% } else { %>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Không có dữ liệu để hiển thị cho báo cáo này.
                        </div>
                        <% } %>
                    </div>
                <% } %>
            </div>
            
            <div class="card-footer">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="bi bi-clock-history"></i> Cập nhật lần cuối: <%= new Date().toLocaleString('vi-VN') %>
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success btn-sm">
                            <i class="bi bi-save"></i> Lưu ghi chú
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Links -->
        <div class="row mt-4">
            <div class="col-md-12">
                <h5 class="mb-3"><i class="bi bi-link-45deg"></i> Truy cập nhanh</h5>
                <div class="d-flex flex-wrap gap-2">
                    <a href="?loaiBaoCao=baoGiaDonHang&filterType=<%= filterType %>&startDate=<%= startDate %>" class="btn btn-outline-primary btn-sm">
                        Báo giá & Đơn hàng
                    </a>
                    <a href="?loaiBaoCao=doanhSoTheoNV&filterType=<%= filterType %>&startDate=<%= startDate %>" class="btn btn-outline-primary btn-sm">
                        Doanh số
                    </a>
                    <a href="?loaiBaoCao=donHangHuy&filterType=<%= filterType %>&startDate=<%= startDate %>" class="btn btn-outline-danger btn-sm">
                        Đơn hàng hủy
                    </a>
                    <a href="?loaiBaoCao=topKhachHang&filterType=<%= filterType %>&startDate=<%= startDate %>" class="btn btn-outline-success btn-sm">
                        Top KH
                    </a>
                    <a href="?loaiBaoCao=ketQuaChienDich&filterType=<%= filterType %>&startDate=<%= startDate %>" class="btn btn-outline-warning btn-sm">
                        Chiến dịch QC
                    </a>
                    <a href="?loaiBaoCao=baoCaoKyThuat&filterType=<%= filterType %>&startDate=<%= startDate %>" class="btn btn-outline-info btn-sm">
                        Kỹ thuật
                    </a>
                    <a href="/bien-ban-cuoc-hop" class="btn btn-outline-dark btn-sm">
                        <i class="bi bi-journal-text"></i> Biên bản họp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5 py-3 bg-white border-top">
        <div class="container text-center">
            <p class="mb-0 text-muted">
                <i class="bi bi-c-circle"></i> 2024 Hệ thống KPI Phòng Kinh Doanh. 
                Phiên bản 1.0 | <span class="text-primary">Phát triển bởi Đội ngũ Kỹ thuật</span>
            </p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        // Khởi tạo DataTable
        $(document).ready(function() {
            $('table').DataTable({
                pageLength: 10,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/vi.json'
                },
                dom: '<"row"<"col-md-6"l><"col-md-6"f>>rt<"row"<"col-md-6"i><"col-md-6"p>>'
            });
        });
        
        // Toggle date inputs based on filter type
        function toggleDateInputs(filterType) {
            const startDateDiv = document.getElementById('startDateDiv');
            const endDateDiv = document.getElementById('endDateDiv');
            const startDateLabel = document.getElementById('startDateLabel');
            
            let label = 'Ngày';
            let inputType = 'date';
            
            switch(filterType) {
                case 'day':
                    label = 'Ngày';
                    inputType = 'date';
                    break;
                case 'week':
                    label = 'Tuần bắt đầu';
                    inputType = 'date';
                    break;
                case 'month':
                    label = 'Tháng';
                    inputType = 'month';
                    break;
                case 'quarter':
                    label = 'Quý';
                    inputType = 'month';
                    break;
                case 'year':
                    label = 'Năm';
                    inputType = 'month';
                    break;
                case 'range':
                    label = 'Từ ngày';
                    inputType = 'date';
                    break;
            }
            
            startDateLabel.textContent = label;
            startDateDiv.querySelector('input').type = inputType;
            
            if (filterType === 'range') {
                endDateDiv.style.display = 'block';
            } else {
                endDateDiv.style.display = 'none';
            }
        }
        
        // Reset filters
        function resetFilters() {
            window.location.href = '/baocao-kpi-phong-kinh-doanh';
        }
        
        // Initialize date inputs
        document.addEventListener('DOMContentLoaded', function() {
            toggleDateInputs('<%= filterType %>');
        });
    </script>
</body>
</html>