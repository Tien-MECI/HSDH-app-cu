<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo KPI Phòng Kinh Doanh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <style>
        .card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
        }
        .table-header {
            background-color: #34495e;
            color: white;
        }
        .nav-tabs .nav-link.active {
            background-color: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }
        .nav-tabs .nav-link {
            color: #2c3e50;
            font-weight: 500;
        }
        .kpi-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        .kpi-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .kpi-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .progress-kpi {
            height: 25px;
            border-radius: 5px;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .excel-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            border: none;
            color: white;
        }
        .tab-content {
            padding-top: 20px;
        }
        .number-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4 sticky-header">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0"><i class="bi bi-graph-up-arrow"></i> HỆ THỐNG BÁO CÁO KPI PHÒNG KINH DOANH</h4>
                            <small class="text-white">Đánh giá hiệu suất nhân sự - Phân tích dữ liệu toàn diện</small>
                        </div>
                        <div>
                            <button class="btn excel-btn btn-sm me-2" onclick="exportToExcel()">
                                <i class="bi bi-file-excel"></i> Xuất Excel
                            </button>
                            <button class="btn btn-light btn-sm" onclick="printReport()">
                                <i class="bi bi-printer"></i> In báo cáo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-section shadow-sm">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-3">
                            <label for="reportType" class="form-label">Loại báo cáo</label>
                            <select class="form-select" id="reportType" name="reportType">
                                <optgroup label="Bộ phận Kinh Doanh">
                                    <option value="tong-quan" <%= reportType === 'tong-quan' ? 'selected' : '' %>>Tổng quan KPI</option>
                                    <option value="bao-giao-don-hang" <%= reportType === 'bao-giao-don-hang' ? 'selected' : '' %>>Báo giá & Đơn hàng</option>
                                    <option value="doanh-so-theo-nv" <%= reportType === 'doanh-so-theo-nv' ? 'selected' : '' %>>Doanh số theo NV</option>
                                    <option value="don-hang-huy" <%= reportType === 'don-hang-huy' ? 'selected' : '' %>>Đơn hàng hủy</option>
                                    <option value="top-100-khach-hang" <%= reportType === 'top-100-khach-hang' ? 'selected' : '' %>>Top 100 KH doanh số</option>
                                    <option value="khach-hang-cu" <%= reportType === 'khach-hang-cu' ? 'selected' : '' %>>KH cũ (≥ 2 đơn)</option>
                                    <option value="khach-hang-moi" <%= reportType === 'khach-hang-moi' ? 'selected' : '' %>>KH mới (1 đơn)</option>
                                    <option value="chuyen-doi-bao-gia" <%= reportType === 'chuyen-doi-bao-gia' ? 'selected' : '' %>>Chuyển đổi báo giá</option>
                                    <option value="don-hang-phe-duyet" <%= reportType === 'don-hang-phe-duyet' ? 'selected' : '' %>>Đơn hàng phê duyệt</option>
                                    <option value="khach-hang-moi-tao" <%= reportType === 'khach-hang-moi-tao' ? 'selected' : '' %>>KH mới được tạo</option>
                                    <option value="khach-hang-dai-ly-moi" <%= reportType === 'khach-hang-dai-ly-moi' ? 'selected' : '' %>>KH đại lý mới</option>
                                    <option value="khach-hang-ban-giao" <%= reportType === 'khach-hang-ban-giao' ? 'selected' : '' %>>KH được bàn giao</option>
                                </optgroup>
                                <optgroup label="Marketing & Truyền thông">
                                    <option value="marketing-bai-dang" <%= reportType === 'marketing-bai-dang' ? 'selected' : '' %>>Bài đăng marketing</option>
                                    <option value="marketing-chien-dich" <%= reportType === 'marketing-chien-dich' ? 'selected' : '' %>>Chiến dịch quảng cáo</option>
                                </optgroup>
                                <optgroup label="Chăm sóc khách hàng">
                                    <option value="cham-soc-khach-hang" <%= reportType === 'cham-soc-khach-hang' ? 'selected' : '' %>>Chăm sóc khách hàng</option>
                                </optgroup>
                                <optgroup label="Kỹ thuật & Thiết kế">
                                    <option value="ky-thuat-ban-ve" <%= reportType === 'ky-thuat-ban-ve' ? 'selected' : '' %>>Bản vẽ kỹ thuật</option>
                                </optgroup>
                                <optgroup label="Thực hiện công việc">
                                    <option value="thuc-hien-cong-viec" <%= reportType === 'thuc-hien-cong-viec' ? 'selected' : '' %>>Công việc được giao</option>
                                </optgroup>
                                <optgroup label="Chấm công">
                                    <option value="cham-cong" <%= reportType === 'cham-cong' ? 'selected' : '' %>>Chấm công làm việc</option>
                                    <option value="khao-sat-cong-trinh" <%= reportType === 'khao-sat-cong-trinh' ? 'selected' : '' %>>Khảo sát công trình</option>
                                    <option value="lam-viec-van-phong" <%= reportType === 'lam-viec-van-phong' ? 'selected' : '' %>>Làm việc tại VP</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label for="filterType" class="form-label">Chu kỳ</label>
                            <select class="form-select" id="filterType" name="filterType">
                                <% for (const [key, value] of Object.entries(periods)) { %>
                                    <option value="<%= key %>" <%= filterType === key ? 'selected' : '' %>><%= value %></option>
                                <% } %>
                            </select>
                        </div>

                        <!-- Dynamic date inputs based on filterType -->
                        <div class="col-md-2" id="dateInput" style="<%= filterType === 'ngay' ? '' : 'display:none;' %>">
                            <label for="customDate" class="form-label">Ngày</label>
                            <input type="date" class="form-control" id="customDate" name="customDate" value="<%= customDate || new Date().toISOString().split('T')[0] %>">
                        </div>
                        <%
function getWeekNumber(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}
%>


                        <div class="col-md-2" id="weekInput" style="<%= filterType === 'tuan' ? '' : 'display:none;' %>">
                            <label for="week" class="form-label">Tuần</label>
                            <input type="number" class="form-control" id="week" name="week" min="1" max="53" value="<%= week || getWeekNumber(new Date()) %>">
                        </div>

                        <div class="col-md-2" id="monthInput" style="<%= filterType === 'thang' ? '' : 'display:none;' %>">
                            <label for="month" class="form-label">Tháng</label>
                            <select class="form-select" id="month" name="month">
                                <% for(let m = 1; m <= 12; m++) { %>
                                    <option value="<%= m %>" <%= month == m ? 'selected' : '' %>>Tháng <%= m %></option>
                                <% } %>
                            </select>
                        </div>

                        <div class="col-md-2" id="quarterInput" style="<%= filterType === 'quy' ? '' : 'display:none;' %>">
                            <label for="quarter" class="form-label">Quý</label>
                            <select class="form-select" id="quarter" name="quarter">
                                <% for(let q = 1; q <= 4; q++) { %>
                                    <option value="<%= q %>" <%= quarter == q ? 'selected' : '' %>>Quý <%= q %></option>
                                <% } %>
                            </select>
                        </div>

                        <div class="col-md-2" id="yearInput">
                            <label for="year" class="form-label">Năm</label>
                            <select class="form-select" id="year" name="year">
                                <% for(let y = year - 5; y <= year + 1; y++) { %>
                                    <option value="<%= y %>" <%= year == y ? 'selected' : '' %>>Năm <%= y %></option>
                                <% } %>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="employeeCode" class="form-label">Nhân viên</label>
                            <select class="form-select select2" id="employeeCode" name="employeeCode">
                                <option value="">Tất cả nhân viên</option>
                                <% employees.forEach(emp => { %>
                                    <option value="<%= emp.split(' - ')[0] %>" <%= employeeCode === emp.split(' - ')[0] ? 'selected' : '' %>>
                                        <%= emp %>
                                    </option>
                                <% }); %>
                            </select>
                        </div>

                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Lọc dữ liệu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <% if (reportType === 'tong-quan') { %>
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-label">Tổng doanh số</div>
                        <div class="kpi-value text-primary">
                            <%= formatNumber(reportData.doanhSo?.reduce((sum, item) => sum + item.doanhSoThucTe, 0) || 0) %>
                        </div>
                        <small>VNĐ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-label">Tổng đơn hàng</div>
                        <div class="kpi-value text-success">
                            <%= reportData.baoGiaoDonHang?.reduce((sum, item) => sum + item.tongDonHang, 0) || 0 %>
                        </div>
                        <small>đơn hàng</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-label">Tỷ lệ chuyển đổi</div>
                        <div class="kpi-value text-warning">
                            <% 
                                const tongBaoGia = reportData.baoGiaoDonHang?.reduce((sum, item) => sum + item.tongBaoGia, 0) || 0;
                                const tongDonHang = reportData.baoGiaoDonHang?.reduce((sum, item) => sum + item.tongDonHang, 0) || 0;
                                const tyLe = tongBaoGia > 0 ? (tongDonHang / tongBaoGia * 100).toFixed(2) : 0;
                            %>
                            <%= tyLe %>%
                        </div>
                        <small>báo giá → đơn hàng</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-label">KH mới</div>
                        <div class="kpi-value text-info">
                            <%= reportData.khachHangMoi?.length || 0 %>
                        </div>
                        <small>khách hàng</small>
                    </div>
                </div>
            </div>
        <% } %>

        <!-- Main Report Content -->
        <div class="row">
            <div class="col-12">
                <!-- Báo cáo Tổng quan -->
                <% if (reportType === 'tong-quan') { %>
                    <div class="card shadow">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> TỔNG QUAN KPI PHÒNG KINH DOANH</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Báo giá & Đơn hàng -->
                                <div class="col-md-6 mb-4">
                                    <h6 class="border-bottom pb-2">Báo giá & Đơn hàng theo NV</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-sm">
                                            <thead class="table-header">
                                                <tr>
                                                    <th>Nhân viên</th>
                                                    <th>Báo giá</th>
                                                    <th>Đơn hàng</th>
                                                    <th>Tỷ lệ</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (reportData.baoGiaoDonHang && reportData.baoGiaoDonHang.length > 0) { %>
                                                    <% reportData.baoGiaoDonHang.forEach(item => { %>
                                                        <tr>
                                                            <td><%= item.tenNV %></td>
                                                            <td class="text-center"><%= item.tongBaoGia %></td>
                                                            <td class="text-center"><%= item.tongDonHang %></td>
                                                            <td class="text-center"><%= item.tyLeChuyenDoi %>%</td>
                                                        </tr>
                                                    <% }); %>
                                                <% } else { %>
                                                    <tr><td colspan="4" class="text-center">Không có dữ liệu</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Doanh số theo NV -->
                                <div class="col-md-6 mb-4">
                                    <h6 class="border-bottom pb-2">Doanh số theo NV</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-sm">
                                            <thead class="table-header">
                                                <tr>
                                                    <th>Nhân viên</th>
                                                    <th>Thực tế</th>
                                                    <th>Mục tiêu</th>
                                                    <th>Đạt</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (reportData.doanhSo && reportData.doanhSo.length > 0) { %>
                                                    <% reportData.doanhSo.forEach(item => { %>
                                                        <tr>
                                                            <td><%= item.tenNV %></td>
                                                            <td class="number-cell"><%= formatNumber(item.doanhSoThucTe) %></td>
                                                            <td class="number-cell"><%= formatNumber(item.mucTieuKPI) %></td>
                                                            <td class="text-center">
                                                                <% const tyLe = parseFloat(item.tyLeDat); %>
                                                                <span class="status-badge <%= tyLe >= 100 ? 'status-success' : tyLe >= 80 ? 'status-warning' : 'status-danger' %>">
                                                                    <%= item.tyLeDat %>%
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    <% }); %>
                                                <% } else { %>
                                                    <tr><td colspan="4" class="text-center">Không có dữ liệu</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Đơn hàng hủy gần đây -->
                                <div class="col-md-12 mb-4">
                                    <h6 class="border-bottom pb-2">Đơn hàng hủy gần đây</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-header">
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Mã đơn</th>
                                                    <th>Khách hàng</th>
                                                    <th>NV bán</th>
                                                    <th>Doanh số hủy</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (reportData.donHangHuy && reportData.donHangHuy.data && reportData.donHangHuy.data.length > 0) { %>
                                                    <% reportData.donHangHuy.data.forEach(item => { %>
                                                        <tr>
                                                            <td><%= item.stt %></td>
                                                            <td><%= item.maDonHang %></td>
                                                            <td><%= item.tenKhachHang %></td>
                                                            <td><%= item.nhanVienBan %></td>
                                                            <td class="number-cell"><%= formatNumber(item.doanhSoHuy) %></td>
                                                        </tr>
                                                    <% }); %>
                                                <% } else { %>
                                                    <tr><td colspan="5" class="text-center">Không có đơn hàng hủy</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <!-- Báo cáo Báo giá & Đơn hàng -->
                <% } else if (reportType === 'bao-giao-don-hang') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> BÁO CÁO BÁO GIÁ & ĐƠN HÀNG THEO NHÂN VIÊN</h5>
                            <span class="badge bg-primary">KPI Kinh doanh</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Mã NV</th>
                                            <th>Tên nhân viên</th>
                                            <th>Tổng báo giá</th>
                                            <th>Tổng đơn hàng</th>
                                            <th>Tỷ lệ chuyển đổi (%)</th>
                                            <th>Doanh số (BR)</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.maNV %></td>
                                                    <td><%= item.tenNV %></td>
                                                    <td class="text-center"><%= item.tongBaoGia %></td>
                                                    <td class="text-center"><%= item.tongDonHang %></td>
                                                    <td class="text-center">
                                                        <div class="progress progress-kpi">
                                                            <div class="progress-bar <%= parseFloat(item.tyLeChuyenDoi) >= 30 ? 'bg-success' : parseFloat(item.tyLeChuyenDoi) >= 20 ? 'bg-warning' : 'bg-danger' %>" 
                                                                 role="progressbar" 
                                                                 style="width: <%= Math.min(parseFloat(item.tyLeChuyenDoi), 100) %>%">
                                                                <%= item.tyLeChuyenDoi %>%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="number-cell"><%= formatNumber(item.doanhSoBR) %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Báo cáo Doanh số theo NV -->
                <% } else if (reportType === 'doanh-so-theo-nv') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-cash-stack"></i> BÁO CÁO DOANH SỐ THEO NHÂN VIÊN</h5>
                            <span class="badge bg-success">KPI Doanh số</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Mã NV</th>
                                            <th>Tên nhân viên</th>
                                            <th>Doanh số thực tế (BR)</th>
                                            <th>Mục tiêu KPI</th>
                                            <th>Tỷ lệ đạt (%)</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.maNV %></td>
                                                    <td><%= item.tenNV %></td>
                                                    <td class="number-cell"><%= formatNumber(item.doanhSoThucTe) %></td>
                                                    <td class="number-cell"><%= formatNumber(item.mucTieuKPI) %></td>
                                                    <td class="text-center">
                                                        <% const tyLe = parseFloat(item.tyLeDat); %>
                                                        <div class="progress progress-kpi">
                                                            <div class="progress-bar <%= tyLe >= 100 ? 'bg-success' : tyLe >= 80 ? 'bg-warning' : 'bg-danger' %>" 
                                                                 role="progressbar" 
                                                                 style="width: <%= Math.min(tyLe, 100) %>%">
                                                                <%= item.tyLeDat %>%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td><input type="text" class="form-control form-control-sm" value="<%= formatNumber(item.mucTieuKPI) %>"></td>
                                                    <td><input type="text" class="form-control form-control-sm" value="<%= item.tyLeDat %>%"></td>
                                                    <td><input type="text" class="form-control form-control-sm" value="<%= item.ghiChu || '' %>"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="9" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Báo cáo Đơn hàng hủy -->
                <% } else if (reportType === 'don-hang-huy') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-x-octagon"></i> BÁO CÁO ĐƠN HÀNG HỦY</h5>
                            <span class="badge bg-danger">Cần xem xét</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Mã đơn hàng</th>
                                            <th>Khách hàng ID</th>
                                            <th>Tên khách hàng</th>
                                            <th>Nhân viên bán</th>
                                            <th>Doanh số hủy (BR)</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach(item => { %>
                                                <tr>
                                                    <td><%= item.stt %></td>
                                                    <td><%= item.maDonHang %></td>
                                                    <td><%= item.khachHangID %></td>
                                                    <td><%= item.tenKhachHang %></td>
                                                    <td><%= item.nhanVienBan %></td>
                                                    <td class="number-cell"><%= formatNumber(item.doanhSoHuy) %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="9" class="text-center">Không có đơn hàng hủy</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <% if (pagination && pagination.totalPages > 1) { %>
                                <nav class="mt-3">
                                    <ul class="pagination justify-content-center">
                                        <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                                            <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                                                <a class="page-link" 
                                                   href="?reportType=don-hang-huy&page=<%= i %>&filterType=<%= filterType %>&year=<%= year %>&month=<%= month %>&employeeCode=<%= employeeCode %>">
                                                    <%= i %>
                                                </a>
                                            </li>
                                        <% } %>
                                    </ul>
                                </nav>
                            <% } %>
                        </div>
                    </div>

                <!-- Top 100 Khách hàng -->
                <% } else if (reportType === 'top-100-khach-hang') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-trophy"></i> TOP 100 KHÁCH HÀNG DOANH SỐ CAO NHẤT</h5>
                            <span class="badge bg-warning">Phân tích KH</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Khách hàng ID</th>
                                            <th>Tên khách hàng</th>
                                            <th>Số đơn hàng</th>
                                            <th>Tổng doanh số (BE)</th>
                                            <th>Tổng doanh số (BR)</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach(item => { %>
                                                <tr>
                                                    <td><%= item.stt %></td>
                                                    <td><%= item.khachHangID %></td>
                                                    <td><%= item.tenKhachHang %></td>
                                                    <td class="text-center"><%= item.soDonHang %></td>
                                                    <td class="number-cell"><%= formatNumber(item.tongDoanhSoBE) %></td>
                                                    <td class="number-cell"><%= formatNumber(item.tongDoanhSoBR) %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="9" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Khách hàng cũ -->
                <% } else if (reportType === 'khach-hang-cu') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-people"></i> KHÁCH HÀNG CŨ (≥ 2 ĐƠN HÀNG)</h5>
                            <span class="badge bg-info">Khách hàng trung thành</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Khách hàng ID</th>
                                            <th>Tên khách hàng</th>
                                            <th>Nhân viên bán</th>
                                            <th>Số đơn hàng</th>
                                            <th>Tổng doanh số (BE)</th>
                                            <th>Tổng doanh số (BR)</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach(item => { %>
                                                <tr>
                                                    <td><%= item.stt %></td>
                                                    <td><%= item.khachHangID %></td>
                                                    <td><%= item.tenKhachHang %></td>
                                                    <td><%= item.nhanVienBan %></td>
                                                    <td class="text-center"><%= item.soDonHang %></td>
                                                    <td class="number-cell"><%= formatNumber(item.tongDoanhSoBE) %></td>
                                                    <td class="number-cell"><%= formatNumber(item.tongDoanhSoBR) %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <% if (pagination && pagination.totalPages > 1) { %>
                                <nav class="mt-3">
                                    <ul class="pagination justify-content-center">
                                        <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                                            <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                                                <a class="page-link" 
                                                   href="?reportType=khach-hang-cu&page=<%= i %>&filterType=<%= filterType %>&year=<%= year %>&month=<%= month %>">
                                                    <%= i %>
                                                </a>
                                            </li>
                                        <% } %>
                                    </ul>
                                </nav>
                            <% } %>
                        </div>
                    </div>

                <!-- Khách hàng mới -->
                <% } else if (reportType === 'khach-hang-moi') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-person-plus"></i> KHÁCH HÀNG MỚI (1 ĐƠN HÀNG)</h5>
                            <span class="badge bg-success">Khách hàng mới</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Khách hàng ID</th>
                                            <th>Tên khách hàng</th>
                                            <th>Nhân viên bán</th>
                                            <th>Doanh số (BE)</th>
                                            <th>Doanh số (BR)</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach(item => { %>
                                                <tr>
                                                    <td><%= item.stt %></td>
                                                    <td><%= item.khachHangID %></td>
                                                    <td><%= item.tenKhachHang %></td>
                                                    <td><%= item.nhanVienBan %></td>
                                                    <td class="number-cell"><%= formatNumber(item.tongDoanhSoBE) %></td>
                                                    <td class="number-cell"><%= formatNumber(item.tongDoanhSoBR) %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="9" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <% if (pagination && pagination.totalPages > 1) { %>
                                <nav class="mt-3">
                                    <ul class="pagination justify-content-center">
                                        <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                                            <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                                                <a class="page-link" 
                                                   href="?reportType=khach-hang-moi&page=<%= i %>&filterType=<%= filterType %>&year=<%= year %>&month=<%= month %>">
                                                    <%= i %>
                                                </a>
                                            </li>
                                        <% } %>
                                    </ul>
                                </nav>
                            <% } %>
                        </div>
                    </div>

                <!-- Chuyển đổi báo giá -->
                <% } else if (reportType === 'chuyen-doi-bao-gia') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-arrow-right-circle"></i> KHÁCH HÀNG CHUYỂN ĐỔI TỪ BÁO GIÁ → ĐƠN HÀNG</h5>
                            <span class="badge bg-primary">Tỷ lệ chuyển đổi</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Khách hàng ID</th>
                                            <th>Tên khách hàng</th>
                                            <th>Nhân viên bán</th>
                                            <th>Có báo giá</th>
                                            <th>Có đơn hàng</th>
                                            <th>Doanh số (BR)</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach(item => { %>
                                                <tr>
                                                    <td><%= item.stt %></td>
                                                    <td><%= item.khachHangID %></td>
                                                    <td><%= item.tenKhachHang %></td>
                                                    <td><%= item.nhanVienBan %></td>
                                                    <td class="text-center"><i class="bi bi-check-lg text-success"></i></td>
                                                    <td class="text-center"><i class="bi bi-check-lg text-success"></i></td>
                                                    <td class="number-cell"><%= formatNumber(item.doanhSoBR) %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <% if (pagination && pagination.totalPages > 1) { %>
                                <nav class="mt-3">
                                    <ul class="pagination justify-content-center">
                                        <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                                            <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                                                <a class="page-link" 
                                                   href="?reportType=chuyen-doi-bao-gia&page=<%= i %>&filterType=<%= filterType %>&year=<%= year %>&month=<%= month %>">
                                                    <%= i %>
                                                </a>
                                            </li>
                                        <% } %>
                                    </ul>
                                </nav>
                            <% } %>
                        </div>
                    </div>

                <!-- Đơn hàng phê duyệt -->
                <% } else if (reportType === 'don-hang-phe-duyet') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-check-circle"></i> ĐƠN HÀNG ĐƯỢC PHÊ DUYỆT THEO NHÂN VIÊN</h5>
                            <span class="badge bg-success">Quy trình phê duyệt</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Nhân viên phê duyệt</th>
                                            <th>Số đơn hàng</th>
                                            <th>Tổng doanh số</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach(item => { %>
                                                <tr>
                                                    <td><%= item.stt %></td>
                                                    <td><%= item.nhanVienPheDuyet %></td>
                                                    <td class="text-center"><%= item.soDonHang %></td>
                                                    <td class="number-cell"><%= formatNumber(item.tongDoanhSo) %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="7" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Khách hàng mới tạo -->
                <% } else if (reportType === 'khach-hang-moi-tao') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-person-plus"></i> KHÁCH HÀNG MỚI ĐƯỢC TẠO</h5>
                            <span class="badge bg-info">Mở rộng thị trường</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Khách hàng ID</th>
                                            <th>Tên khách hàng</th>
                                            <th>Loại khách</th>
                                            <th>Nguồn khách</th>
                                            <th>NV phụ trách</th>
                                            <th>Người tạo</th>
                                            <th>Ngày tạo</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.khachHangID %></td>
                                                    <td><%= item.tenKhachHang %></td>
                                                    <td><%= item.loaiKhach %></td>
                                                    <td><%= item.nguonKhach %></td>
                                                    <td><%= item.nhanVienPhuTrach %></td>
                                                    <td><%= item.nguoiTao %></td>
                                                    <td><%= item.ngayTao %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="11" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Khách hàng đại lý mới -->
                <% } else if (reportType === 'khach-hang-dai-ly-moi') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-shop"></i> KHÁCH HÀNG ĐẠI LÝ MỚI</h5>
                            <span class="badge bg-warning">Phát triển đại lý</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Khách hàng ID</th>
                                            <th>Tên khách hàng</th>
                                            <th>Loại khách</th>
                                            <th>Nguồn khách</th>
                                            <th>NV phụ trách</th>
                                            <th>Ngày tạo</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.khachHangID %></td>
                                                    <td><%= item.tenKhachHang %></td>
                                                    <td><span class="badge bg-warning"><%= item.loaiKhach %></span></td>
                                                    <td><%= item.nguonKhach %></td>
                                                    <td><%= item.nhanVienPhuTrach %></td>
                                                    <td><%= item.ngayTao %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Khách hàng được bàn giao -->
                <% } else if (reportType === 'khach-hang-ban-giao') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-arrow-left-right"></i> KHÁCH HÀNG ĐƯỢC BÀN GIAO</h5>
                            <span class="badge bg-info">Quản lý khách hàng</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Khách hàng ID</th>
                                            <th>Tên khách hàng</th>
                                            <th>Nguồn khách</th>
                                            <th>NV phụ trách</th>
                                            <th>Người tạo</th>
                                            <th>Ngày bàn giao</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.khachHangID %></td>
                                                    <td><%= item.tenKhachHang %></td>
                                                    <td><%= item.nguonKhach %></td>
                                                    <td><%= item.nhanVienPhuTrach %></td>
                                                    <td><%= item.nguoiTao %></td>
                                                    <td><%= item.ngayBanGiao %></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Bài đăng marketing -->
                <% } else if (reportType === 'marketing-bai-dang') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-megaphone"></i> BÀI ĐĂNG MARKETING</h5>
                            <span class="badge bg-purple">Marketing</span>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Theo nhân viên</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-header">
                                                <tr>
                                                    <th>Nhân viên</th>
                                                    <th>Số bài đăng</th>
                                                    <th>Mục tiêu</th>
                                                    <th>Kết quả</th>
                                                    <th>Ghi chú</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (reportData.theoNhanVien && reportData.theoNhanVien.length > 0) { %>
                                                    <% reportData.theoNhanVien.forEach(item => { %>
                                                        <tr>
                                                            <td><%= item.tenNV %></td>
                                                            <td class="text-center"><%= item.soBaiDang %></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                        </tr>
                                                    <% }); %>
                                                <% } else { %>
                                                    <tr><td colspan="5" class="text-center">Không có dữ liệu</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Theo kênh đăng</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-header">
                                                <tr>
                                                    <th>Kênh đăng</th>
                                                    <th>Số bài đăng</th>
                                                    <th>Mục tiêu</th>
                                                    <th>Kết quả</th>
                                                    <th>Ghi chú</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (reportData.theoKenh && reportData.theoKenh.length > 0) { %>
                                                    <% reportData.theoKenh.forEach(item => { %>
                                                        <tr>
                                                            <td><%= item.kenhDang %></td>
                                                            <td class="text-center"><%= item.soBaiDang %></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                        </tr>
                                                    <% }); %>
                                                <% } else { %>
                                                    <tr><td colspan="5" class="text-center">Không có dữ liệu</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <h6>Chi tiết bài đăng</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Nhân viên</th>
                                            <th>Kênh đăng</th>
                                            <th>Link bài đăng</th>
                                            <th>Hình ảnh</th>
                                            <th>Ngày đăng</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData.theoNhanVien && reportData.theoNhanVien.length > 0) { %>
                                            <% let detailIndex = 1; %>
                                            <% reportData.theoNhanVien.forEach(nv => { %>
                                                <% if (nv.baiDang && nv.baiDang.length > 0) { %>
                                                    <% nv.baiDang.forEach(bai => { %>
                                                        <tr>
                                                            <td><%= detailIndex++ %></td>
                                                            <td><%= nv.tenNV %></td>
                                                            <td><%= bai.kenhDang %></td>
                                                            <td>
                                                                <% if (bai.link) { %>
                                                                    <a href="<%= bai.link %>" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                        <i class="bi bi-link"></i> Xem
                                                                    </a>
                                                                <% } else { %>
                                                                    Không có link
                                                                <% } %>
                                                            </td>
                                                            <td>
                                                                <% if (bai.hinhAnh) { %>
                                                                    <a href="<%= bai.hinhAnh %>" target="_blank" class="btn btn-sm btn-outline-success">
                                                                        <i class="bi bi-image"></i> Xem
                                                                    </a>
                                                                <% } else { %>
                                                                    Không có ảnh
                                                                <% } %>
                                                            </td>
                                                            <td><%= bai.ngayBaoCao %></td>
                                                        </tr>
                                                    <% }); %>
                                                <% } %>
                                            <% }); %>
                                            <% if (detailIndex === 1) { %>
                                                <tr><td colspan="6" class="text-center">Không có chi tiết bài đăng</td></tr>
                                            <% } %>
                                        <% } else { %>
                                            <tr><td colspan="6" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Chiến dịch marketing -->
                <% } else if (reportType === 'marketing-chien-dich') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-bullseye"></i> CHIẾN DỊCH QUẢNG CÁO</h5>
                            <span class="badge bg-purple">Marketing</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Công việc</th>
                                            <th>Người thực hiện</th>
                                            <th>Ngày thực hiện</th>
                                            <th>File kết quả</th>
                                            <th>Kết quả</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.tenCongViec %></td>
                                                    <td><%= item.nguoiThucHien %></td>
                                                    <td><%= item.ngayThucHien %></td>
                                                    <td>
                                                        <% if (item.linkXem) { %>
                                                            <a href="<%= item.linkXem %>" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                <i class="bi bi-play-btn"></i> Xem kết quả
                                                            </a>
                                                        <% } else if (item.fileKetQua) { %>
                                                            <small><%= item.fileKetQua %></small>
                                                        <% } else { %>
                                                            Không có file
                                                        <% } %>
                                                    </td>
                                                    <td><span class="badge <%= item.ketQua === 'Hoàn thành' ? 'bg-success' : 'bg-warning' %>">
                                                        <%= item.ketQua || 'Đang thực hiện' %>
                                                    </span></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="9" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Chăm sóc khách hàng -->
                <% } else if (reportType === 'cham-soc-khach-hang') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-telephone-outbound"></i> CHĂM SÓC KHÁCH HÀNG</h5>
                            <span class="badge bg-info">Customer Service</span>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Thống kê theo nhân viên</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-header">
                                                <tr>
                                                    <th>Nhân viên</th>
                                                    <th>Số lượt CS</th>
                                                    <th>Mục tiêu</th>
                                                    <th>Kết quả</th>
                                                    <th>Ghi chú</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (reportData.thongKeNhanVien && reportData.thongKeNhanVien.length > 0) { %>
                                                    <% reportData.thongKeNhanVien.forEach(item => { %>
                                                        <tr>
                                                            <td><%= item.tenNV %></td>
                                                            <td class="text-center"><%= item.soLuotChamSoc %></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                        </tr>
                                                    <% }); %>
                                                <% } else { %>
                                                    <tr><td colspan="5" class="text-center">Không có dữ liệu</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <h6>Chi tiết chăm sóc</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Khách hàng</th>
                                            <th>Hình thức</th>
                                            <th>Nội dung</th>
                                            <th>Nhân viên</th>
                                            <th>Kết quả</th>
                                            <th>Ngày hẹn tiếp</th>
                                            <th>Ngày CS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData.chiTiet && reportData.chiTiet.length > 0) { %>
                                            <% reportData.chiTiet.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><strong><%= item.tenKhach %></strong><br><small><%= item.khachHangID %></small></td>
                                                    <td><%= item.hinhThuc %></td>
                                                    <td><small><%= item.noiDung %></small></td>
                                                    <td><%= item.tenNV %></td>
                                                    <td><span class="badge bg-info"><%= item.ketQua || 'Đã liên hệ' %></span></td>
                                                    <td><%= item.ngayHenTiep || 'Chưa hẹn' %></td>
                                                    <td><%= item.ngayChamSoc %></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="8" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Kỹ thuật bản vẽ -->
                <% } else if (reportType === 'ky-thuat-ban-ve') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-rulers"></i> BẢN VẼ KỸ THUẬT</h5>
                            <span class="badge bg-secondary">Kỹ thuật</span>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Thống kê theo kỹ sư</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-header">
                                                <tr>
                                                    <th>Kỹ sư</th>
                                                    <th>Số bản vẽ</th>
                                                    <th>Tổng số lần TK</th>
                                                    <th>Mục tiêu</th>
                                                    <th>Kết quả</th>
                                                    <th>Ghi chú</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (reportData.thongKeKySu && reportData.thongKeKySu.length > 0) { %>
                                                    <% reportData.thongKeKySu.forEach(item => { %>
                                                        <tr>
                                                            <td><%= item.kySu %></td>
                                                            <td class="text-center"><%= item.soBanVe %></td>
                                                            <td class="text-center"><%= item.tongSoLanThietKe %></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                            <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                        </tr>
                                                    <% }); %>
                                                <% } else { %>
                                                    <tr><td colspan="6" class="text-center">Không có dữ liệu</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <h6>Chi tiết bản vẽ</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Mã đơn hàng</th>
                                            <th>Số lần TK</th>
                                            <th>Loại file</th>
                                            <th>Loại bản vẽ</th>
                                            <th>Kỹ sư</th>
                                            <th>Thời gian TH</th>
                                            <th>Ngày tạo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData.chiTiet && reportData.chiTiet.length > 0) { %>
                                            <% reportData.chiTiet.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.maDonHang %></td>
                                                    <td class="text-center"><%= item.soLanThietKe %></td>
                                                    <td><%= item.loaiFile %></td>
                                                    <td><%= item.loaiBanVe %></td>
                                                    <td><%= item.kySu %></td>
                                                    <td><%= item.thoiGianThucHien %></td>
                                                    <td><%= item.ngayTao %></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="8" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Thực hiện công việc -->
                <% } else if (reportType === 'thuc-hien-cong-viec') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-check2-square"></i> THỰC HIỆN CÔNG VIỆC ĐƯỢC GIAO</h5>
                            <span class="badge bg-primary">Quản lý công việc</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Nhân viên</th>
                                            <th>Tổng CV được giao</th>
                                            <th>Đã tiếp nhận</th>
                                            <th>Đã hoàn thành</th>
                                            <th>Tỷ lệ tiếp nhận</th>
                                            <th>Tỷ lệ hoàn thành</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.tenNV %></td>
                                                    <td class="text-center"><%= item.tongCongViec %></td>
                                                    <td class="text-center"><%= item.daTiepNhan %></td>
                                                    <td class="text-center"><%= item.daHoanThanh %></td>
                                                    <td>
                                                        <div class="progress progress-kpi">
                                                            <div class="progress-bar <%= parseFloat(item.tyLeTiepNhan) >= 90 ? 'bg-success' : parseFloat(item.tyLeTiepNhan) >= 70 ? 'bg-warning' : 'bg-danger' %>" 
                                                                 role="progressbar" 
                                                                 style="width: <%= Math.min(parseFloat(item.tyLeTiepNhan), 100) %>%">
                                                                <%= item.tyLeTiepNhan %>%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="progress progress-kpi">
                                                            <div class="progress-bar <%= parseFloat(item.tyLeHoanThanh) >= 90 ? 'bg-success' : parseFloat(item.tyLeHoanThanh) >= 70 ? 'bg-warning' : 'bg-danger' %>" 
                                                                 role="progressbar" 
                                                                 style="width: <%= Math.min(parseFloat(item.tyLeHoanThanh), 100) %>%">
                                                                <%= item.tyLeHoanThanh %>%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Chấm công -->
                <% } else if (reportType === 'cham-cong') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-calendar-check"></i> CHẤM CÔNG LÀM VIỆC</h5>
                            <span class="badge bg-dark">HR</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Nhân viên</th>
                                            <th>Bộ phận</th>
                                            <th>Số ngày công</th>
                                            <th>Được duyệt</th>
                                            <th>Không duyệt</th>
                                            <th>Tỷ lệ duyệt</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.nhanVien %></td>
                                                    <td><%= item.boPhan %></td>
                                                    <td class="text-center"><%= item.soNgayCong %></td>
                                                    <td class="text-center"><%= item.duyet %></td>
                                                    <td class="text-center"><%= item.khongDuyet %></td>
                                                    <td>
                                                        <% 
                                                            const tyLeDuyet = item.soNgayCong > 0 ? (item.duyet / item.soNgayCong * 100).toFixed(2) : 0;
                                                        %>
                                                        <div class="progress progress-kpi">
                                                            <div class="progress-bar <%= tyLeDuyet >= 90 ? 'bg-success' : tyLeDuyet >= 70 ? 'bg-warning' : 'bg-danger' %>" 
                                                                 role="progressbar" 
                                                                 style="width: <%= Math.min(tyLeDuyet, 100) %>%">
                                                                <%= tyLeDuyet %>%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Khảo sát công trình -->
                <% } else if (reportType === 'khao-sat-cong-trinh') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-binoculars"></i> KHẢO SÁT CÔNG TRÌNH</h5>
                            <span class="badge bg-info">Field Work</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Nhân viên</th>
                                            <th>Ngày</th>
                                            <th>Mô tả công việc</th>
                                            <th>Loại việc</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.nhanVien %></td>
                                                    <td><%= item.ngay %></td>
                                                    <td><small><%= item.moTa %></small></td>
                                                    <td><span class="badge bg-info"><%= item.loaiViec %></span></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="8" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                <!-- Làm việc tại văn phòng -->
                <% } else if (reportType === 'lam-viec-van-phong') { %>
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-building"></i> LÀM VIỆC TẠI VĂN PHÒNG</h5>
                            <span class="badge bg-secondary">Office Work</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-header">
                                        <tr>
                                            <th>STT</th>
                                            <th>Nhân viên</th>
                                            <th>Ngày</th>
                                            <th>Mô tả công việc</th>
                                            <th>Loại việc</th>
                                            <th>Mục tiêu</th>
                                            <th>Kết quả</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (reportData && reportData.length > 0) { %>
                                            <% reportData.forEach((item, index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td><%= item.nhanVien %></td>
                                                    <td><%= item.ngay %></td>
                                                    <td><small><%= item.moTa %></small></td>
                                                    <td><span class="badge bg-secondary"><%= item.loaiViec %></span></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập mục tiêu"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập kết quả"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Nhập ghi chú"></td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr><td colspan="8" class="text-center">Không có dữ liệu</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Đánh giá hiện trạng -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> ĐÁNH GIÁ HIỆN TRẠNG TỒN TẠI</h5>
                    </div>
                    <div class="card-body">
                        <form id="evaluationForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nguyên nhân khách quan:</label>
                                    <textarea class="form-control" rows="3" placeholder="Nhập nguyên nhân khách quan ảnh hưởng đến KPI..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Nguyên nhân chủ quan:</label>
                                    <textarea class="form-control" rows="3" placeholder="Nhập nguyên nhân chủ quan từ phía nhân sự/quản lý..."></textarea>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="form-label">Kết luận & Đánh giá:</label>
                                    <textarea class="form-control" rows="3" placeholder="Nhập kết luận tổng quan về tình hình thực hiện KPI..."></textarea>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="form-label">Công việc tiếp theo cần triển khai:</label>
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="nextTasksTable">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Công việc</th>
                                                    <th>Người phụ trách</th>
                                                    <th>Thời hạn</th>
                                                    <th>Ghi chú</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="nextTasksBody">
                                                <tr>
                                                    <td>1</td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Mô tả công việc"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Người phụ trách"></td>
                                                    <td><input type="date" class="form-control form-control-sm"></td>
                                                    <td><input type="text" class="form-control form-control-sm" placeholder="Ghi chú"></td>
                                                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeTask(this)"><i class="bi bi-trash"></i></button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-success" onclick="addTask()">
                                        <i class="bi bi-plus-circle"></i> Thêm công việc
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 text-end">
                                    <button type="button" class="btn btn-primary" onclick="saveEvaluation()">
                                        <i class="bi bi-save"></i> Lưu đánh giá
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/vi.js"></script>
    <script>
        // Initialize Select2
        $(document).ready(function() {
            $('.select2').select2({
                language: "vi",
                placeholder: "Chọn nhân viên",
                allowClear: true
            });
        });

        // Dynamic date inputs based on filter type
        document.getElementById('filterType').addEventListener('change', function() {
            const filterType = this.value;
            
            // Hide all date inputs
            document.getElementById('dateInput').style.display = 'none';
            document.getElementById('weekInput').style.display = 'none';
            document.getElementById('monthInput').style.display = 'none';
            document.getElementById('quarterInput').style.display = 'none';
            
            // Show relevant input
            switch(filterType) {
                case 'ngay':
                    document.getElementById('dateInput').style.display = 'block';
                    break;
                case 'tuan':
                    document.getElementById('weekInput').style.display = 'block';
                    break;
                case 'thang':
                    document.getElementById('monthInput').style.display = 'block';
                    break;
                case 'quy':
                    document.getElementById('quarterInput').style.display = 'block';
                    break;
            }
        });

        // Form submission
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const params = new URLSearchParams();
            
            for (const [key, value] of formData.entries()) {
                if (value) params.append(key, value);
            }
            
            window.location.href = `/baocao-kpi?${params.toString()}`;
        });

        // Export to Excel
        function exportToExcel() {
            const formData = new FormData(document.getElementById('filterForm'));
            const params = new URLSearchParams();
            
            for (const [key, value] of formData.entries()) {
                if (value) params.append(key, value);
            }
            
            window.location.href = `/export/kpi?${params.toString()}`;
        }

        // Print report
        function printReport() {
            window.print();
        }

        // Evaluation form functions
        let taskCounter = 1;
        
        function addTask() {
            taskCounter++;
            const tableBody = document.getElementById('nextTasksBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${taskCounter}</td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Mô tả công việc"></td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Người phụ trách"></td>
                <td><input type="date" class="form-control form-control-sm"></td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Ghi chú"></td>
                <td><button type="button" class="btn btn-sm btn-danger" onclick="removeTask(this)"><i class="bi bi-trash"></i></button></td>
            `;
            tableBody.appendChild(newRow);
        }
        
        function removeTask(button) {
            const row = button.closest('tr');
            if (document.getElementById('nextTasksBody').children.length > 1) {
                row.remove();
                // Renumber rows
                const rows = document.querySelectorAll('#nextTasksBody tr');
                rows.forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
                taskCounter = rows.length;
            }
        }
        
        function saveEvaluation() {
            const form = document.getElementById('evaluationForm');
            const formData = new FormData(form);
            
            // Collect tasks
            const tasks = [];
            const taskRows = document.querySelectorAll('#nextTasksBody tr');
            taskRows.forEach(row => {
                const task = {
                    description: row.cells[1].querySelector('input').value,
                    responsible: row.cells[2].querySelector('input').value,
                    deadline: row.cells[3].querySelector('input').value,
                    notes: row.cells[4].querySelector('input').value
                };
                if (task.description || task.responsible) {
                    tasks.push(task);
                }
            });
            
            const evaluationData = {
                objectiveReasons: formData.get('objectiveReasons') || '',
                subjectiveReasons: formData.get('subjectiveReasons') || '',
                conclusion: formData.get('conclusion') || '',
                nextTasks: tasks
            };
            
            // Send data to server
            fetch('/kpi/nhap-danh-gia', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(evaluationData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Đã lưu đánh giá thành công!');
                    // Clear form
                    form.reset();
                    document.getElementById('nextTasksBody').innerHTML = `
                        <tr>
                            <td>1</td>
                            <td><input type="text" class="form-control form-control-sm" placeholder="Mô tả công việc"></td>
                            <td><input type="text" class="form-control form-control-sm" placeholder="Người phụ trách"></td>
                            <td><input type="date" class="form-control form-control-sm"></td>
                            <td><input type="text" class="form-control form-control-sm" placeholder="Ghi chú"></td>
                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeTask(this)"><i class="bi bi-trash"></i></button></td>
                        </tr>
                    `;
                    taskCounter = 1;
                } else {
                    alert('Lỗi khi lưu đánh giá: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Đã xảy ra lỗi khi lưu đánh giá');
            });
        }

        // Helper function for week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
    </script>
</body>
</html>