<!DOCTYPE html>
<html>

<head>
    <title>Lệnh Sản Xuất PVC</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 13px;
            margin: 0;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        td,
        th {
            border: 1px solid black;
            padding: 5px;
            text-align: left;
        }

        .header {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        .logo {
            text-align: left;
        }

        .header-right {
            text-align: right;
        }

        .red {
            color: red;
        }

        .center-text {
            text-align: center;
        }

        .no-border {
            border: none;
        }

        /* Watermark */
        .watermark {
            position: fixed;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
            opacity: 0.1;
            text-align: center;
        }

        .watermark img {
            width: 80vw;
            height: auto;
        }

        /* CSS cho in ấn */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            body {
                margin: 1.5cm;
                padding: 0;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>

    <% if (typeof autoPrint !=='undefined' && autoPrint) { %>
        <script>
            window.onload = function () {
                setTimeout(function () {
                    window.print();
                    setTimeout(function () {
                        if (window.opener) {
                            window.close();
                        }
                    }, 500);
                }, 1000);
            };
        </script>
        <% } %>
</head>

<body>
    <% if (watermarkBase64) { %>
        <div class="watermark">
            <img src="<%= watermarkBase64 %>" />
        </div>
        <% } %>

            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td class="no-border">
                        <img class="logo" src="<%= logoBase64 %>" style="width: 80px; height: 40px;" />
                    </td>
                    <td class="no-border" style="text-align: right;">
                        <strong>CÔNG TY CỔ PHẦN CÔNG NGHIỆP MECI</strong>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="border: none; padding: 0;">
                        <div style="border-top: 3px double black; margin: -1px 0 0 0;"></div>
                    </td>
                </tr>
            </table>

            <h2 class="center-text">LỆNH THỰC HIỆN (<%= lenhValue %>)</h2>

            <!-- Thông tin khách hàng và lệnh sản xuất -->
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td colspan="2" style="font-weight: bold; text-align: center;" width="60%"><b>THÔNG TIN KHÁCH
                            HÀNG</b></td>
                    <td width="15%" style="font-weight: bold; text-align: center;"><b>LỆNH SẢN XUẤT</b></td>
                    <td width="25%" style="font-weight: bold; text-align: Left;"><b>
                            <%= maDonHang %>
                        </b></td>
                </tr>
                <tr>
                    <td width="15%" style="font-weight: bold;">Người mua hàng:</td>
                    <td style="text-align: left;" width="45%">
                        <%= donHang[17] || donHang[20] || '' %>
                    </td>
                    <td width="15%" style="font-weight: bold;">Ngày lập:</td>
                    <td style="text-align: left;" width="25%">
                        <%= donHang[1] instanceof Date ? donHang[1].toLocaleDateString('vi-VN') : donHang[1] %>
                    </td>
                </tr>
                <tr>
                    <td style="font-weight: bold;" width="15%">Tên công ty:</td>
                    <td style="text-align: left;" width="45%">
                        <%= donHang[9] || '' %>
                    </td>
                    <td style="font-weight: bold;" width="15%">Người lập:</td>
                    <td style="text-align: left;" width="25%">
                        <%= donHang[2] || '' %>
                    </td>
                </tr>
                <tr>
                    <td style="font-weight: bold;" width="15%">Địa chỉ TH:</td>
                    <td style="text-align: left;" width="45%">
                        <%= donHang[24] || donHang[26] || donHang[28] || '' %>
                    </td>
                    <td style="font-weight: bold;" width="15%">Ngày YC TH:</td>
                    <td style="text-align: left;" width="25%">
                        <%= donHang[45] instanceof Date ? donHang[45].toLocaleDateString('vi-VN') : donHang[45] %>
                    </td>
                </tr>
                <tr>
                    <td style="font-weight: bold;" width="15%">phone người nhận:</td>
                    <td style="text-align: left;" width="45%">
                        <%= donHang[25] || donHang[27] || donHang[29] || '' %>
                    </td>
                    <td style="font-weight: bold;" width="15%">phone/Zalo/Face:</td>
                    <td style="text-align: left;" width="25%">
                        <%= donHang[52] || '' %>
                    </td>
                </tr>
                <tr>
                    <td style="font-weight: bold;" width="15%">Loại yêu cầu:</td>
                    <td style="text-align: left;" width="45%">
                        <%= donHang[36] || '' %>
                    </td>
                    <td style="font-weight: bold;" width="15%">Yêu cầu gửi nhà xe:</td>
                    <td style="text-align: left;" width="25%">
                        <%= donHang[38] || '' %>
                    </td>
                </tr>
                <tr>
                    <td style="font-weight: bold;" width="15%">Nhóm SP YC:</td>
                    <td style="text-align: left;" width="45%">
                        <%= donHang[34] || '' %>
                    </td>
                    <td style="font-weight: bold;" width="15%">Ghi chú thực hiện:</td>
                    <td style="text-align: left;" width="25%">
                        <%= donHang[37] || '' %>
                    </td>
                </tr>
            </table>

            <!-- Bảng chi tiết hàng hóa -->
            <h2>BẢNG CHI TIẾT HÀNG HÓA</h2>
            <table style="width: 100%; font-size: 12px;">
                <thead>
                    <tr>
                        <% // Xác định các cột cần hiển thị const columns=[ { header: "Mã ĐH chi tiết" ,
                            key: "maDonHangChiTiet" }, { header: "Tên thương mại sản phẩm" , key: "tenThuongMai" }, {
                            header: "Dài (mm)" , key: "dai" }, { header: "Rộng (mm)" , key: "rong" }, {
                            header: "Cao (mm)" , key: "cao" }, { header: "SL - Sợi" , key: "slSoi" }, {
                            header: "Số lượng" , key: "soLuong" }, { header: "Đơn vị tính" , key: "donViTinh" }, {
                            header: "Tổng số lượng" , key: "tongSoLuong" }, { header: "Tổng SL-Sợi" , key: "tongSLSoi"
                            }, { header: "Ghi chú sản xuất" , key: "ghiChuSanXuat" } ]; // Lọc các cột có dữ liệu const
                            filteredColumns=columns.filter(col=> {
                            return products.some(product => product[col.key]);
                            });

                            // Hiển thị tiêu đề
                            filteredColumns.forEach(col => {
                            %>
                            <th>
                                <%= col.header %>
                            </th>
                            <% }); %>
                    </tr>
                </thead>
                <tbody>
                    <% products.forEach(function(product) { %>
                        <tr>
                            <% filteredColumns.forEach(col=> { %>
                                <td style="text-align: center;">
                                    <%= product[col.key] || '' %>
                                </td>
                                <% }); %>
                        </tr>
                        <% }); %>
                </tbody>
            </table>
</body>

</html>